<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xavier Serbia Money Map</title>
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=Fraunces:opsz,wght@9..144,600;9..144,700;9..144,800;9..144,900&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #3956E8;
  --emerald: #10b981;
  --emerald-dark: #059669;
  --amber: #f59e0b;
  --charcoal: #18181b;
  --slate: #475569;
  --slate-light: #cbd5e1;
  --bg: #fafafa;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #0f172a;
  --text-muted: #64748b;
  --danger: #ef4444;
  --warning: #f59e0b;
  --success: #10b981;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; -webkit-font-smoothing: antialiased; }
.app-container { min-height: 100vh; display: flex; flex-direction: column; }
.app-header { background: linear-gradient(135deg, var(--primary) 0%, #2845d9 100%); color: white; padding: 2rem 2rem 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
.header-content { max-width: 1400px; margin: 0 auto; }
.app-subtitle { color: var(--slate-light); font-size: 1rem; margin-bottom: 2rem; font-weight: 400; }
.tabs-container { display: flex; gap: 0.5rem; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
.tabs-container::-webkit-scrollbar { display: none; }
.tab-button { background: transparent; border: none; color: rgba(255,255,255,0.6); padding: 1rem 1.5rem; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; white-space: nowrap; font-family: 'DM Sans', sans-serif; }
.tab-button:hover { color: rgba(255,255,255,0.9); background: rgba(255,255,255,0.05); }
.tab-button.active { color: white; border-bottom-color: var(--emerald); }
.main-content { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }
.card { background: var(--card); border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 1.5rem; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border); }
.card-title { font-family: 'Fraunces', serif; font-size: 1.5rem; font-weight: 700; color: var(--charcoal); }
.card-subtitle { color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem; }
.form-group { margin-bottom: 1.25rem; }
.form-label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); font-size: 0.9rem; }
.form-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; font-family: 'DM Sans', sans-serif; transition: all 0.2s ease; background: white; }
.form-input:focus { outline: none; border-color: var(--emerald); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
.form-input::placeholder { color: var(--text-muted); }
select.form-input { cursor: pointer; }
.btn { padding: 0.75rem 1.5rem; border: none; border-radius: 10px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; font-family: 'DM Sans', sans-serif; display: inline-flex; align-items: center; gap: 0.5rem; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #2845d9; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(57,86,232,0.3); }
.btn-secondary { background: var(--charcoal); color: white; }
.btn-danger { background: #fecaca; color: #991b1b; padding: 0.5rem 1rem; font-size: 0.875rem; }
.btn-danger:hover { background: #fca5a5; }
.btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
.stat-card { background: linear-gradient(135deg, var(--emerald) 0%, var(--emerald-dark) 100%); padding: 1.5rem; border-radius: 12px; color: white; }
.stat-label { font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem; }
.stat-value { font-family: 'Fraunces', serif; font-size: 2rem; font-weight: 800; line-height: 1; }
.table-container { overflow-x: auto; margin: 1rem 0; }
table { width: 100%; border-collapse: separate; border-spacing: 0; }
thead { background: var(--bg); }
th { padding: 1rem; text-align: left; font-weight: 700; font-size: 0.875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid var(--border); }
td { padding: 1rem; border-bottom: 1px solid var(--border); }
tbody tr:hover { background: var(--bg); }
.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
.grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
.category-section { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
.category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.category-title { font-weight: 700; font-size: 1.1rem; color: var(--charcoal); }
.summary-card { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 2rem; border-radius: 16px; margin-top: 2rem; }
.summary-title { font-family: 'Fraunces', serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--charcoal); }
.summary-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border); }
.summary-row:last-child { border-bottom: none; margin-top: 1rem; padding-top: 1.5rem; border-top: 2px solid var(--charcoal); }
.summary-row-label { font-weight: 600; color: var(--text); }
.summary-row-value { font-family: 'Fraunces', serif; font-size: 1.25rem; font-weight: 700; color: var(--charcoal); }
.summary-row:last-child .summary-row-value { font-size: 1.75rem; color: var(--emerald); }
.chart-container { position: relative; height: 300px; margin: 1.5rem 0; }
.export-footer { background: var(--card); padding: 1.5rem 2rem; border-top: 1px solid var(--border); position: sticky; bottom: 0; z-index: 10; }
.export-footer-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
.export-info { color: var(--text-muted); font-size: 0.875rem; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.3s ease-out; }
@media (max-width: 768px) { .app-header { padding: 1.5rem 1rem 0; } .main-content { padding: 1rem; } .card { padding: 1rem; } .stats-grid { grid-template-columns: 1fr; } }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--slate-light); border-radius: 5px; }
.currency { font-family: 'Fraunces', serif; font-weight: 700; font-feature-settings: 'tnum'; }
.text-success { color: var(--success); } .text-warning { color: var(--warning); } .text-danger { color: var(--danger); }
.text-muted { color: var(--text-muted); } .text-right { text-align: right; } .text-center { text-align: center; }
.mb-0 { margin-bottom: 0; } .mt-2 { margin-top: 2rem; } .font-bold { font-weight: 700; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

// ============= UTILITY FUNCTIONS =============
const formatCurrency = (value, currencyCode = 'USD') => {
  if (value === null || value === undefined || value === '') {
    const symbols = { 'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£', 'MXN': '$', 'COP': '$', 'ARS': '$', 'CLP': '$', 'PEN': 'S/', 'BRL': 'R$', 'CAD': 'C$' };
    return `${symbols[currencyCode] || '$'}0`;
  }
  const num = typeof value === 'string' ? parseFloat(value.replace(/,/g, '')) : value;
  if (isNaN(num)) {
    const symbols = { 'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£', 'MXN': '$', 'COP': '$', 'ARS': '$', 'CLP': '$', 'PEN': 'S/', 'BRL': 'R$', 'CAD': 'C$' };
    return `${symbols[currencyCode] || '$'}0`;
  }
  const locales = { 'USD': 'en-US', 'EUR': 'de-DE', 'GBP': 'en-GB', 'MXN': 'es-MX', 'COP': 'es-CO', 'ARS': 'es-AR', 'CLP': 'es-CL', 'PEN': 'es-PE', 'BRL': 'pt-BR', 'CAD': 'en-CA' };
  return new Intl.NumberFormat(locales[currencyCode] || 'en-US', { style: 'currency', currency: currencyCode, maximumFractionDigits: 0 }).format(num);
};

const parseNumber = (value) => {
  if (value === null || value === undefined || value === '') return 0;
  const num = typeof value === 'string' ? parseFloat(value.replace(/,/g, '')) : value;
  return isNaN(num) ? 0 : num;
};

// ============= ONBOARDING MODAL =============
function OnboardingModal({ isOpen, onClose, onSave, initialProfile }) {
  const [formData, setFormData] = useState({ ...initialProfile, parejaNombre: initialProfile.parejaNombre || '', parejaApellido: initialProfile.parejaApellido || '', parejaAvatar: initialProfile.parejaAvatar || 'üë§' });
  const avatarOptions = ['üë§','üë®','üë©','üßë','üë®‚Äçüíº','üë©‚Äçüíº','üë®‚Äçüéì','üë©‚Äçüéì','üßî','üë®‚Äçü¶∞','üë©‚Äçü¶∞','üë±‚Äç‚ôÇÔ∏è','üë±‚Äç‚ôÄÔ∏è'];
  const handleSubmit = (e) => {
    e.preventDefault();
    const isCouple = formData.estadoCivil === 'casado' || formData.estadoCivil === 'pareja';
    onSave({ ...formData, analisisConjunto: isCouple, parejaNombre: isCouple ? formData.parejaNombre : '', parejaApellido: isCouple ? formData.parejaApellido : '', parejaAvatar: isCouple ? formData.parejaAvatar : 'üë§' });
    onClose();
  };
  const updateField = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
  if (!isOpen) return null;
  const isCouple = formData.estadoCivil === 'casado' || formData.estadoCivil === 'pareja';
  return (
    <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',zIndex:2000,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px',backdropFilter:'blur(8px)'}} onClick={onClose}>
      <div style={{background:'#fff',borderRadius:'20px',maxWidth:'600px',width:'100%',maxHeight:'90vh',overflow:'auto',boxShadow:'0 25px 70px rgba(0,0,0,0.5)'}} onClick={e=>e.stopPropagation()}>
        <div style={{padding:'2rem 2rem 1rem',borderBottom:'1px solid var(--border)',textAlign:'center',position:'relative'}}>
          <button onClick={onClose} style={{position:'absolute',top:'1rem',right:'1rem',background:'rgba(0,0,0,0.05)',border:'none',width:'32px',height:'32px',borderRadius:'50%',fontSize:'20px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',color:'#666'}}>√ó</button>
          <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üëã</div>
          <img src="https://xserbia.github.io/calculadora-financiera/assets/XAVIER-MONEY-MAP-LOGO-2.png" alt="Xavier Serbia Money Map" style={{height:'70px',marginBottom:'0.75rem'}} />
          <div style={{color:'var(--text-muted)',fontSize:'0.95rem'}}>Comienza tu viaje hacia la libertad financiera</div>
        </div>
        <form onSubmit={handleSubmit} style={{padding:'2rem'}}>
          <div style={{marginBottom:'1.5rem',textAlign:'center'}}>
            <label style={{display:'block',fontWeight:'600',marginBottom:'1rem',color:'#333'}}>Elige tu avatar</label>
            <div style={{display:'flex',gap:'0.75rem',justifyContent:'center',flexWrap:'wrap'}}>
              {avatarOptions.map(av => <button key={av} type="button" onClick={()=>updateField('avatar',av)} style={{fontSize:'2rem',width:'60px',height:'60px',border:formData.avatar===av?'3px solid var(--primary)':'2px solid var(--border)',borderRadius:'50%',background:formData.avatar===av?'rgba(59,130,246,0.1)':'white',cursor:'pointer'}}>{av}</button>)}
            </div>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1.5rem'}}>
            <div><label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem',fontSize:'0.9rem'}}>Nombre *</label><input type="text" required value={formData.nombre} onChange={e=>updateField('nombre',e.target.value)} placeholder="Juan" style={{width:'100%',padding:'0.75rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'1rem',outline:'none'}} /></div>
            <div><label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem',fontSize:'0.9rem'}}>Apellido *</label><input type="text" required value={formData.apellido} onChange={e=>updateField('apellido',e.target.value)} placeholder="P√©rez" style={{width:'100%',padding:'0.75rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'1rem',outline:'none'}} /></div>
          </div>
          <div style={{marginBottom:'1.5rem'}}><label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem',fontSize:'0.9rem'}}>Edad *</label><input type="number" required min="18" max="100" value={formData.edad} onChange={e=>updateField('edad',e.target.value)} placeholder="30" style={{width:'100%',padding:'0.75rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'1rem',outline:'none'}} /></div>
          <div style={{marginBottom:'1.5rem'}}><label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem',fontSize:'0.9rem'}}>Estado Civil *</label>
            <select required value={formData.estadoCivil} onChange={e=>updateField('estadoCivil',e.target.value)} style={{width:'100%',padding:'0.75rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'1rem',outline:'none',cursor:'pointer',background:'white'}}>
              <option value="soltero">Soltero/a</option><option value="casado">Casado/a</option><option value="pareja">En pareja / Uni√≥n libre</option><option value="divorciado">Divorciado/a</option><option value="viudo">Viudo/a</option>
            </select>
          </div>
          {isCouple && (
            <>
              <div style={{background:'#eff6ff',border:'2px solid var(--primary)',borderRadius:'12px',padding:'1rem',marginBottom:'1.5rem'}}>
                <div style={{display:'flex',gap:'0.75rem',alignItems:'flex-start'}}>
                  <span style={{fontSize:'1.5rem'}}>üí°</span>
                  <div><div style={{fontWeight:'700',marginBottom:'0.25rem',color:'var(--primary)'}}>An√°lisis Financiero Conjunto</div>
                  <div style={{fontSize:'0.875rem',color:'#1e40af',lineHeight:'1.5'}}>El dashboard analizar√° las finanzas de ambos como una unidad familiar.</div></div>
                </div>
              </div>
              <div style={{marginBottom:'1.5rem',textAlign:'center',background:'#f8fafc',padding:'1.5rem',borderRadius:'12px'}}>
                <label style={{display:'block',fontWeight:'600',marginBottom:'1rem',color:'#333'}}>Avatar de tu pareja</label>
                <div style={{display:'flex',gap:'0.75rem',justifyContent:'center',flexWrap:'wrap'}}>
                  {avatarOptions.map(av => <button key={`p-${av}`} type="button" onClick={()=>updateField('parejaAvatar',av)} style={{fontSize:'2rem',width:'60px',height:'60px',border:formData.parejaAvatar===av?'3px solid var(--primary)':'2px solid var(--border)',borderRadius:'50%',background:formData.parejaAvatar===av?'rgba(59,130,246,0.1)':'white',cursor:'pointer'}}>{av}</button>)}
                </div>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1.5rem'}}>
                <div><label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem',fontSize:'0.9rem'}}>Nombre de tu pareja *</label><input type="text" required value={formData.parejaNombre} onChange={e=>updateField('parejaNombre',e.target.value)} placeholder="Mar√≠a" style={{width:'100%',padding:'0.75rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'1rem',outline:'none'}} /></div>
                <div><label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem',fontSize:'0.9rem'}}>Apellido *</label><input type="text" required value={formData.parejaApellido} onChange={e=>updateField('parejaApellido',e.target.value)} placeholder="Gonz√°lez" style={{width:'100%',padding:'0.75rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'1rem',outline:'none'}} /></div>
              </div>
            </>
          )}
          <div style={{marginBottom:'2rem'}}><label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem',fontSize:'0.9rem'}}>N√∫mero de Dependientes</label><input type="number" min="0" max="20" value={formData.dependientes} onChange={e=>updateField('dependientes',parseInt(e.target.value)||0)} style={{width:'100%',padding:'0.75rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'1rem',outline:'none'}} /><div style={{fontSize:'0.8rem',color:'var(--text-muted)',marginTop:'0.25rem'}}>Hijos, padres u otras personas que dependan econ√≥micamente de ti</div></div>
          <button type="submit" style={{background:'var(--primary)',color:'white',border:'none',padding:'0.875rem 2rem',borderRadius:'8px',fontSize:'1rem',fontWeight:'700',cursor:'pointer',width:'100%'}}>Comenzar üöÄ</button>
        </form>
      </div>
    </div>
  );
}

// ============= IMPORT PREVIEW MODAL =============
function ImportPreviewModal({ data, onConfirm, onCancel }) {
  if (!data) return null;
  const pn = n => parseFloat(String(n).replace(/[$,]/g, '')) || 0;
  const prof           = data.userProfile || data.profile || {};
  const totalIngresos  = data.ingresos.reduce((s, i) => s + pn(i.monto), 0) * 12;
  const totalEfectivo  = data.activos.efectivo.reduce((s, i) => s + pn(i.valor), 0);
  const totalRetiro    = data.activos.retiro.reduce((s, i) => s + pn(i.valor), 0);
  const totalInv       = data.activos.inversiones.reduce((s, i) => s + pn(i.valor), 0);
  const totalBR        = data.activos.bienesRaices.reduce((s, i) => s + pn(i.valor), 0);
  const totalBP        = data.activos.bienesPersonales.reduce((s, i) => s + pn(i.valor), 0);
  const totalActivos   = totalEfectivo + totalRetiro + totalInv + totalBR + totalBP;
  const totalDeudas    = Object.values(data.deudas).flat().reduce((s, d) => s + pn(d.balance), 0);
  const patrimonio     = totalActivos - totalDeudas;
  const totalItems     = data.ingresos.length + Object.values(data.gastos).flat().length + Object.values(data.activos).flat().length + Object.values(data.deudas).flat().length;
  const fmt = v => '$' + Math.round(v).toLocaleString('en-US');

  const Card = ({ label, value, color, bg }) => (
    <div style={{ background: bg || '#f8fafc', borderRadius: '12px', padding: '1rem', textAlign: 'center' }}>
      <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.35rem', fontWeight: '600' }}>{label}</div>
      <div style={{ fontWeight: '800', fontSize: '1.2rem', color: color || '#0f172a' }}>{value}</div>
    </div>
  );

  return (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.75)', zIndex: 3000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', backdropFilter: 'blur(8px)' }}>
      <div style={{ background: '#fff', borderRadius: '20px', maxWidth: '680px', width: '100%', maxHeight: '88vh', overflow: 'hidden', display: 'flex', flexDirection: 'column', boxShadow: '0 25px 70px rgba(0,0,0,0.5)' }}>

        {/* Header */}
        <div style={{ padding: '1.5rem 2rem', background: 'var(--primary)', color: 'white', flexShrink: 0 }}>
          <div style={{ fontSize: '1.4rem', fontWeight: '800', marginBottom: '0.2rem' }}>üìÇ Importar desde Discovery</div>
          <div style={{ opacity: 0.85, fontSize: '0.875rem' }}>Revisa el resumen antes de cargar los datos en tu Money Map</div>
        </div>

        {/* Body */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '1.5rem 2rem' }}>

          {/* Client card */}
          <div style={{ background: '#eff6ff', border: '2px solid var(--primary)', borderRadius: '12px', padding: '1rem 1.25rem', marginBottom: '1.25rem', display: 'flex', gap: '1rem', alignItems: 'center' }}>
            <span style={{ fontSize: '2.5rem' }}>{prof.avatar || 'üë§'}</span>
            <div>
              <div style={{ fontWeight: '700', fontSize: '1.1rem' }}>{prof.nombre} {prof.apellido}</div>
              {prof.edad && <div style={{ color: '#3956E8', fontSize: '0.875rem' }}>{prof.edad} a√±os ¬∑ {prof.estadoCivil || ''}</div>}
              {prof.parejaNombre && <div style={{ color: '#64748b', fontSize: '0.875rem' }}>Pareja: {prof.parejaNombre} {prof.parejaApellido}</div>}
              {data._exportDate && <div style={{ color: '#94a3b8', fontSize: '0.8rem', marginTop: '0.25rem' }}>Discovery: {data._exportDate}</div>}
            </div>
          </div>

          {/* Summary grid */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3,1fr)', gap: '0.75rem', marginBottom: '1.25rem' }}>
            <Card label="Ingresos / a√±o"    value={fmt(totalIngresos)}  color="#10b981" bg="#f0fdf4" />
            <Card label="Total Activos"     value={fmt(totalActivos)}   bg="#f0fdf4" />
            <Card label="Total Deudas"      value={fmt(totalDeudas)}    color="#ef4444" bg="#fef2f2" />
            <Card label="Patrimonio Neto"   value={fmt(patrimonio)}     color={patrimonio >= 0 ? '#10b981' : '#ef4444'} bg={patrimonio >= 0 ? '#f0fdf4' : '#fef2f2'} />
            <Card label="Cuentas Bancarias" value={fmt(totalEfectivo)}  bg="#fffbeb" />
            <Card label="Items importados"  value={totalItems}          bg="#f8fafc" />
          </div>

          {/* Item counts */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', fontSize: '0.85rem', color: '#475569', marginBottom: '1.25rem' }}>
            {[['üíµ Ingresos', data.ingresos.length], ['üßæ Gastos', Object.values(data.gastos).flat().length], ['üí∞ Activos', Object.values(data.activos).flat().length], ['üí≥ Deudas', Object.values(data.deudas).flat().length]].map(([label, count]) => (
              <div key={label} style={{ background: '#f8fafc', borderRadius: '8px', padding: '0.5rem 0.75rem', display: 'flex', justifyContent: 'space-between' }}>
                <span>{label}</span><span style={{ fontWeight: '700' }}>{count} items</span>
              </div>
            ))}
          </div>

          <div style={{ background: '#fffbeb', border: '2px solid #f59e0b', borderRadius: '12px', padding: '0.875rem 1rem', fontSize: '0.875rem', lineHeight: '1.5' }}>
            ‚ö†Ô∏è <strong>Esta acci√≥n reemplazar√° todos los datos actuales</strong> del Money Map con los datos de este cliente. Aseg√∫rate de revisar el PDF del Discovery antes de confirmar.
          </div>
        </div>

        {/* Footer */}
        <div style={{ padding: '1.25rem 2rem', borderTop: '1px solid var(--border)', display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', flexShrink: 0 }}>
          <button onClick={onCancel} style={{ padding: '0.75rem 1.5rem', border: '2px solid var(--border)', borderRadius: '10px', background: 'white', fontWeight: '600', cursor: 'pointer', fontSize: '0.95rem', fontFamily: 'DM Sans,sans-serif' }}>
            Cancelar
          </button>
          <button onClick={() => onConfirm(data)} style={{ padding: '0.75rem 2rem', background: 'var(--primary)', color: 'white', border: 'none', borderRadius: '10px', fontWeight: '700', cursor: 'pointer', fontSize: '0.95rem', fontFamily: 'DM Sans,sans-serif', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            ‚úÖ Confirmar e Importar
          </button>
        </div>
      </div>
    </div>
  );
}

// ============= MAIN APP COMPONENT =============
function App() {
  const [activeTab, setActiveTab] = useState('vistaGeneral');
  const [currency, setCurrency] = useState(() => localStorage.getItem('currency') || 'USD');
  const [showHelpModal, setShowHelpModal] = useState(false);
  const [showOnboardingModal, setShowOnboardingModal] = useState(false);

  // ‚îÄ‚îÄ DISCOVERY IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const importFileRef = useRef(null);
  const [importPreview, setImportPreview] = useState(null);

  const handleImportFile = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    e.target.value = '';
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!data._version || !data.activos) {
          alert('Archivo no v√°lido.\n\nUsa el archivo .moneymap.json generado por el Discovery Form (bot√≥n "üíæ Exportar ‚Üí Money Map").');
          return;
        }
        setImportPreview(data);
      } catch (err) {
        alert('Error al leer el archivo:\n\n' + err.message);
      }
    };
    reader.readAsText(file);
  };

  const handleImportConfirm = (data) => {
    const prof = data.userProfile || data.profile;
    if (data.activos)  { setActivos(data.activos);   localStorage.setItem('activos',   JSON.stringify(data.activos)); }
    if (data.deudas)   { setDeudas(data.deudas);      localStorage.setItem('deudas',    JSON.stringify(data.deudas)); }
    if (data.ingresos) { setIngresos(data.ingresos);  localStorage.setItem('ingresos',  JSON.stringify(data.ingresos)); }
    if (data.gastos)   { setGastos(data.gastos);      localStorage.setItem('gastos',    JSON.stringify(data.gastos)); }
    if (data.proteccion) { setProteccion(data.proteccion); localStorage.setItem('proteccion', JSON.stringify(data.proteccion)); }
    if (prof) {
      const merged = { ...userProfile, ...prof };
      saveUserProfile(merged);
      if (merged.edad) setRatiosData(prev => ({ ...prev, edad: merged.edad }));
    }
    setImportPreview(null);
    setShowOnboardingModal(false);   // perfil ya viene del Discovery
    setActiveTab('vistaGeneral');
    setTimeout(() => alert('‚úÖ Datos del Discovery importados correctamente.\n\nRevisa cada pesta√±a para confirmar la informaci√≥n del cliente.'), 200);
  };
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const [userProfile, setUserProfile] = useState(() => {
    const saved = localStorage.getItem('userProfile');
    return saved ? JSON.parse(saved) : { nombre: '', apellido: '', edad: '', estadoCivil: 'soltero', dependientes: 0, avatar: 'üë§', analisisConjunto: false, parejaNombre: '', parejaApellido: '', parejaAvatar: 'üë§' };
  });

  useEffect(() => {
    const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
    if (!hasSeenOnboarding) setShowOnboardingModal(true);
  }, []);

  const saveUserProfile = (profile) => {
    setUserProfile(profile);
    localStorage.setItem('userProfile', JSON.stringify(profile));
    localStorage.setItem('hasSeenOnboarding', 'true');
    if (profile.edad) setRatiosData(prev => ({ ...prev, edad: profile.edad }));
  };

  const clearAllData = () => {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar TODOS tus datos financieros?\n\nEsta acci√≥n no se puede deshacer.')) {
      ['activos','deudas','ingresos','gastos','ratiosData','modoCalculo','currency','userProfile','hasSeenOnboarding','proteccion'].forEach(k => localStorage.removeItem(k));
      window.location.reload();
    }
  };

  const [activos, setActivos] = useState(() => {
    const saved = localStorage.getItem('activos');
    return saved ? JSON.parse(saved) : { efectivo: [], inversiones: [], retiro: [], bienesRaices: [], bienesPersonales: [] };
  });
  const [deudas, setDeudas] = useState(() => {
    const saved = localStorage.getItem('deudas');
    return saved ? JSON.parse(saved) : { tarjetas: [], lineaPersonal: [], lineaPropiedad: [], casa: [], auto: [], educacion: [], otros: [] };
  });
  const [ingresos, setIngresos] = useState(() => { const s = localStorage.getItem('ingresos'); return s ? JSON.parse(s) : []; });
  const [gastos, setGastos] = useState(() => {
    const saved = localStorage.getItem('gastos');
    return saved ? JSON.parse(saved) : { diarios: [], deuda: [], ahorro: [], impuestos: [], seguros: [] };
  });
  const [proteccion, setProteccion] = useState(() => {
    const s = localStorage.getItem('proteccion');
    return s ? JSON.parse(s) : {
      documentos: [
        { tipo:'Testamento',              tiene:'no', fecha:'', contacto:'', notas:'' },
        { tipo:'Living Trust',            tiene:'no', fecha:'', contacto:'', notas:'' },
        { tipo:'Power of Attorney',       tiene:'no', fecha:'', contacto:'', notas:'' },
        { tipo:'Healthcare Directive',    tiene:'no', fecha:'', contacto:'', notas:'' },
        { tipo:'Beneficiarios actualizados', tiene:'no', fecha:'', contacto:'', notas:'' },
      ],
      polizas: []
    };
  });
  const [modoCalculo, setModoCalculo] = useState(() => localStorage.getItem('modoCalculo') || 'mensual');
  const [ratiosData, setRatiosData] = useState(() => {
    const saved = localStorage.getItem('ratiosData');
    return saved ? JSON.parse(saved) : { edad: '', ingresoBruto: 0, ingresoNeto: 0, ahorroAnual: 0, impuestosAnual: 0, segurosAnual: 0, deudaAnual: 0, gastosAnual: 0, pagoDeudaMensual: 0, gastosEsencialesMensuales: 0, reserva: 0, pasivosCorrientes: 0 };
  });

  useEffect(() => { localStorage.setItem('activos', JSON.stringify(activos)); }, [activos]);
  useEffect(() => { localStorage.setItem('deudas', JSON.stringify(deudas)); }, [deudas]);
  useEffect(() => { localStorage.setItem('ingresos', JSON.stringify(ingresos)); }, [ingresos]);
  useEffect(() => { localStorage.setItem('gastos', JSON.stringify(gastos)); }, [gastos]);
  useEffect(() => { localStorage.setItem('ratiosData', JSON.stringify(ratiosData)); }, [ratiosData]);

  // ‚îÄ‚îÄ Keep ratiosData in sync with ingresos/gastos/activos/deudas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(() => {
    const ingBruto    = ingresos.reduce((s,i)=>s+parseFloat(i.monto||0),0)*12;
    const impAnual    = (gastos.impuestos?.reduce((s,g)=>s+parseFloat(g.monto||0),0)||0)*12;
    const segAnual    = (gastos.seguros?.reduce((s,g)=>s+parseFloat(g.monto||0),0)||0)*12;
    const ahorroAnual = (gastos.ahorro?.reduce((s,g)=>s+parseFloat(g.monto||0),0)||0)*12;
    const deudaAnual  = (gastos.deuda?.reduce((s,g)=>s+parseFloat(g.monto||0),0)||0)*12;
    const gastosAnual = (gastos.diarios?.reduce((s,g)=>s+parseFloat(g.monto||0),0)||0)*12;
    setRatiosData(prev => ({
      ...prev,
      ingresoBruto: ingBruto,
      ingresoNeto:  ingBruto - impAnual - segAnual,
      ahorroAnual,
      impuestosAnual: impAnual,
      segurosAnual:   segAnual,
      deudaAnual,
      gastosAnual,
      pagoDeudaMensual:          deudaAnual / 12,
      gastosEsencialesMensuales: gastosAnual / 12,
      reserva:           totales.totalEfectivo  || 0,
      pasivosCorrientes: totales.pasivosTotales || 0,
    }));
  }, [ingresos, gastos, totales]);
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(() => { localStorage.setItem('modoCalculo', modoCalculo); }, [modoCalculo]);
  useEffect(() => { localStorage.setItem('proteccion', JSON.stringify(proteccion)); }, [proteccion]);
  useEffect(() => { localStorage.setItem('currency', currency); }, [currency]);

  const totales = useMemo(() => {
    const totalEfectivo       = activos.efectivo.reduce((s, i) => s + parseNumber(i.valor), 0);
    const totalInversiones    = activos.inversiones.reduce((s, i) => s + parseNumber(i.valor), 0);
    const totalRetiro         = activos.retiro.reduce((s, i) => s + parseNumber(i.valor), 0);
    const totalBienesRaices   = activos.bienesRaices.reduce((s, i) => s + parseNumber(i.valor), 0);
    const totalBienesPersonales = activos.bienesPersonales.reduce((s, i) => s + parseNumber(i.valor), 0);
    const activosTotales      = totalEfectivo + totalInversiones + totalRetiro + totalBienesRaices + totalBienesPersonales;
    const totalTarjetas       = deudas.tarjetas.reduce((s, i) => s + parseNumber(i.balance), 0);
    const totalLineaPersonal  = deudas.lineaPersonal.reduce((s, i) => s + parseNumber(i.balance), 0);
    const totalLineaPropiedad = deudas.lineaPropiedad.reduce((s, i) => s + parseNumber(i.balance), 0);
    const totalCasa           = deudas.casa.reduce((s, i) => s + parseNumber(i.balance), 0);
    const totalAuto           = deudas.auto.reduce((s, i) => s + parseNumber(i.balance), 0);
    const totalEducacion      = deudas.educacion.reduce((s, i) => s + parseNumber(i.balance), 0);
    const totalOtros          = deudas.otros.reduce((s, i) => s + parseNumber(i.balance), 0);
    const pasivosTotales      = totalTarjetas + totalLineaPersonal + totalLineaPropiedad + totalCasa + totalAuto + totalEducacion + totalOtros;
    const patrimonioNeto      = activosTotales - pasivosTotales;
    const mult                = modoCalculo === 'anual' ? 12 : 1;
    const totalIngresos       = ingresos.reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
    const totalAhorro         = gastos.ahorro.reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
    const totalDeudaGastos    = gastos.deuda.reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
    const totalDiarios        = gastos.diarios.reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
    const totalSeguros        = gastos.seguros.reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
    const totalImpuestos      = gastos.impuestos.reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
    const totalGastos         = totalAhorro + totalDeudaGastos + totalDiarios + totalSeguros + totalImpuestos;
    const superavit           = totalIngresos - totalGastos;
    return { activosTotales, pasivosTotales, patrimonioNeto, totalIngresos, totalGastos, superavit, totalEfectivo, totalInversiones, totalRetiro, totalBienesRaices, totalBienesPersonales, activosLiquidos: totalEfectivo, inversiones: totalInversiones + totalRetiro };
  }, [activos, deudas, ingresos, gastos, modoCalculo]);

  return (
    <div className="app-container">
      <OnboardingModal isOpen={showOnboardingModal} onClose={() => setShowOnboardingModal(false)} onSave={saveUserProfile} initialProfile={userProfile} />

      {/* Import Preview Modal */}
      <ImportPreviewModal data={importPreview} onConfirm={handleImportConfirm} onCancel={() => setImportPreview(null)} />

      <header className="app-header">
        <div className="header-content">
          <img src="https://xserbia.github.io/calculadora-financiera/assets/XAVIER-MONEY-MAP-LOGO.png" alt="Xavier Serbia Money Map" style={{ height: '60px', marginBottom: '0.5rem' }} />
          <p className="app-subtitle">Tu mapa financiero personal hacia la libertad econ√≥mica</p>

          <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
            {/* Currency selector */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <label style={{ color: 'rgba(255,255,255,0.8)', fontSize: '0.9rem', fontWeight: '600' }}>Moneda:</label>
              <select value={currency} onChange={e => setCurrency(e.target.value)} style={{ padding: '0.5rem 1rem', borderRadius: '8px', border: '2px solid rgba(255,255,255,0.2)', background: 'rgba(255,255,255,0.1)', color: 'white', fontWeight: '600', fontSize: '0.9rem', cursor: 'pointer', outline: 'none' }}>
                <option value="USD" style={{ background: '#2845d9' }}>üá∫üá∏ USD</option>
                <option value="EUR" style={{ background: '#2845d9' }}>üá™üá∫ EUR</option>
                <option value="GBP" style={{ background: '#2845d9' }}>üá¨üáß GBP</option>
                <option value="MXN" style={{ background: '#2845d9' }}>üá≤üáΩ MXN</option>
                <option value="COP" style={{ background: '#2845d9' }}>üá®üá¥ COP</option>
                <option value="ARS" style={{ background: '#2845d9' }}>üá¶üá∑ ARS</option>
                <option value="CLP" style={{ background: '#2845d9' }}>üá®üá± CLP</option>
                <option value="PEN" style={{ background: '#2845d9' }}>üáµüá™ PEN</option>
                <option value="BRL" style={{ background: '#2845d9' }}>üáßüá∑ BRL</option>
                <option value="CAD" style={{ background: '#2845d9' }}>üá®üá¶ CAD</option>
              </select>
            </div>

            {/* Mi Perfil */}
            <button onClick={() => setShowOnboardingModal(true)} style={{ padding: '0.5rem 1.25rem', borderRadius: '8px', border: '2px solid rgba(255,255,255,0.3)', background: 'rgba(255,255,255,0.15)', color: 'white', fontWeight: '600', fontSize: '0.9rem', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              {userProfile.avatar} Mi Perfil
            </button>

            {/* C√≥mo usar */}
            <button onClick={() => setShowHelpModal(true)} style={{ padding: '0.5rem 1.25rem', borderRadius: '8px', border: '2px solid rgba(255,255,255,0.3)', background: 'rgba(255,255,255,0.15)', color: 'white', fontWeight: '600', fontSize: '0.9rem', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              ‚ùì C√≥mo usar
            </button>

            {/* üìÇ IMPORTAR DISCOVERY ‚Üê NUEVO */}
            <button
              onClick={() => importFileRef.current && importFileRef.current.click()}
              style={{ padding: '0.5rem 1.25rem', borderRadius: '8px', border: '2px solid rgba(99,255,180,0.6)', background: 'rgba(16,185,129,0.3)', color: 'white', fontWeight: '700', fontSize: '0.9rem', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem' }}
              title="Importar datos desde el archivo .moneymap.json del Discovery Form"
            >
              üìÇ Importar Discovery
            </button>
            <input ref={importFileRef} type="file" accept=".json,.moneymap.json" style={{ display: 'none' }} onChange={handleImportFile} />

            {/* Limpiar datos */}
            <button onClick={clearAllData} style={{ padding: '0.5rem 1.25rem', borderRadius: '8px', border: '2px solid rgba(239,68,68,0.5)', background: 'rgba(239,68,68,0.15)', color: 'white', fontWeight: '600', fontSize: '0.9rem', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem' }} title="Borrar todos los datos guardados">
              üóëÔ∏è Limpiar Datos
            </button>
          </div>

          <div className="tabs-container">
            {[['vistaGeneral','üìä Vista General'],['graficos','üìà Gr√°ficos'],['ingresos','üíµ Ingresos y Gastos'],['activos','üí∞ Activos'],['deudas','üí≥ Pasivos'],['balance','‚öñÔ∏è Patrimonio Neto'],['proteccion','üõ°Ô∏è Protecci√≥n'],['ratios','üìä Ratios Financieros'],['runway','‚è±Ô∏è Runway'],['calc_deuda','üí≥ Salir de Deuda']].map(([key, label]) => (
              <button key={key} className={`tab-button ${activeTab === key ? 'active' : ''}`} onClick={() => setActiveTab(key)}>{label}</button>
            ))}
          </div>
        </div>
      </header>

      <main className="main-content fade-in">
        {activeTab === 'vistaGeneral' && <VistaGeneral totales={totales} ingresos={ingresos} gastos={gastos} ratiosData={ratiosData} currency={currency} setActiveTab={setActiveTab} userProfile={userProfile} />}
        {activeTab === 'graficos'     && <GraficosTab activos={activos} deudas={deudas} ingresos={ingresos} gastos={gastos} totales={totales} ratiosData={ratiosData} currency={currency} />}
        {activeTab === 'activos'      && <InventarioActivos activos={activos} setActivos={setActivos} totales={totales} currency={currency} />}
        {activeTab === 'deudas'       && <InventarioDeudas deudas={deudas} setDeudas={setDeudas} currency={currency} />}
        {activeTab === 'balance'      && <HojaBalance activos={activos} deudas={deudas} totales={totales} currency={currency} />}
        {activeTab === 'ingresos'     && <IngresosGastos ingresos={ingresos} setIngresos={setIngresos} gastos={gastos} setGastos={setGastos} modoCalculo={modoCalculo} setModoCalculo={setModoCalculo} currency={currency} />}
        {activeTab === 'proteccion'   && <Proteccion proteccion={proteccion} setProteccion={setProteccion} activos={activos} setActivos={setActivos} currency={currency} />}
        {activeTab === 'ratios'       && <RatiosFinancieros ratiosData={ratiosData} setRatiosData={setRatiosData} totales={totales} currency={currency} ingresos={ingresos} gastos={gastos} setActiveTab={setActiveTab} />}
        {activeTab === 'runway'       && <RunwayCalculator activos={activos} gastos={gastos} ingresos={ingresos} deudas={deudas} totales={totales} currency={currency} />}
        {activeTab === 'calc_deuda'  && <SalirDeDeuda deudas={deudas} gastos={gastos} ingresos={ingresos} currency={currency} />}
      </main>

      {/* Help Modal */}
      {showHelpModal && (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',zIndex:2000,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px',backdropFilter:'blur(8px)'}} onClick={()=>setShowHelpModal(false)}>
          <div style={{background:'#fff',borderRadius:'20px',maxWidth:'800px',width:'100%',maxHeight:'90vh',overflow:'hidden',display:'flex',flexDirection:'column',boxShadow:'0 25px 70px rgba(0,0,0,0.5)'}} onClick={e=>e.stopPropagation()}>
            <div style={{padding:'24px 28px',background:'var(--primary)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <div style={{fontSize:'24px',fontWeight:'800',color:'white'}}>üó∫Ô∏è C√≥mo usar Money Map</div>
              <button onClick={()=>setShowHelpModal(false)} style={{background:'rgba(255,255,255,0.2)',border:'none',width:'36px',height:'36px',borderRadius:'50%',fontSize:'22px',cursor:'pointer',color:'white'}}>√ó</button>
            </div>
            <div style={{padding:'32px',overflowY:'auto',lineHeight:'1.7'}}>
              <h3 style={{margin:'0 0 16px',fontSize:'20px',fontWeight:'700',color:'var(--primary)'}}>üéØ Flujo de trabajo con Discovery</h3>
              <div style={{background:'#f0fdf4',border:'2px solid var(--emerald)',borderRadius:'12px',padding:'1.25rem',marginBottom:'1.5rem'}}>
                <div style={{fontWeight:'700',marginBottom:'0.75rem',fontSize:'1rem'}}>C√≥mo importar datos del Discovery Form:</div>
                <ol style={{paddingLeft:'1.5rem',color:'var(--text)',fontSize:'14px',lineHeight:'2'}}>
                  <li>El cliente completa el <strong>Discovery Form</strong></li>
                  <li>T√∫ recibes el <strong>PDF</strong> (para revisar) y el <strong>Excel</strong> (para archivar)</li>
                  <li>En el Discovery, haz clic en <strong>"üíæ Exportar ‚Üí Money Map"</strong> para descargar el <code>.moneymap.json</code></li>
                  <li>En el Money Map, haz clic en <strong>"üìÇ Importar Discovery"</strong> y selecciona ese archivo</li>
                  <li>Revisa el resumen y confirma ‚Äî ¬°todos los datos se cargan autom√°ticamente!</li>
                </ol>
              </div>
              <h3 style={{margin:'0 0 16px',fontSize:'20px',fontWeight:'700',color:'var(--primary)'}}>üìù Ingreso manual</h3>
              <p style={{marginBottom:'16px',fontSize:'15px'}}>Tambi√©n puedes ingresar datos manualmente en cada pesta√±a: Activos, Pasivos, Ingresos y Gastos. Los Ratios Financieros se calculan autom√°ticamente.</p>
            </div>
          </div>
        </div>
      )}

      <ExportFooter totales={totales} currency={currency} />
    </div>
  );
}

// ============= INVENTARIO ACTIVOS =============
function InventarioActivos({ activos, setActivos, totales, currency }) {
  const categorias = [
    { key: 'efectivo',         nombre: 'Efectivo y Equivalentes', items: ['Checking','Savings','Money Market','CD','Efectivo a mano','Otro'] },
    { key: 'inversiones',      nombre: 'Inversiones',             items: ['Brokerage account','Acciones','ETF/Fondos mutuos','Bonos','Criptomonedas','Otro'] },
    { key: 'retiro',           nombre: 'Cuentas de Retiro',       items: ['401(k)','403(b)','IRA Tradicional','Roth IRA','SEP IRA','Pensi√≥n','Anualidad','Otro'] },
    { key: 'bienesRaices',     nombre: 'Bienes Ra√≠ces',           items: ['Casa principal','Casa vacacional','Propiedad de renta','Apartamento','Terreno','Otro'] },
    { key: 'bienesPersonales', nombre: 'Bienes Personales',       items: ['Veh√≠culo','Bote','RV','Joyas','Arte','Coleccionables','Otro'] }
  ];
  const addItem    = cat => setActivos(prev => ({ ...prev, [cat]: [...prev[cat], { tipo: '', ubicacion: '', valor: '', transferencia: '' }] }));
  const updateItem = (cat, idx, field, val) => setActivos(prev => ({ ...prev, [cat]: prev[cat].map((item, i) => i === idx ? { ...item, [field]: val } : item) }));
  const removeItem = (cat, idx) => setActivos(prev => ({ ...prev, [cat]: prev[cat].filter((_, i) => i !== idx) }));

  return (
    <div>
      <div className="stats-grid">
        <div className="stat-card"><div className="stat-label">Total Activos</div><div className="stat-value">{formatCurrency(totales.activosTotales, currency)}</div></div>
        <div className="stat-card" style={{background:'linear-gradient(135deg,var(--amber) 0%,#d97706 100%)'}}><div className="stat-label">Efectivo</div><div className="stat-value">{formatCurrency(totales.totalEfectivo, currency)}</div></div>
        <div className="stat-card" style={{background:'linear-gradient(135deg,var(--charcoal) 0%,#3f3f46 100%)'}}><div className="stat-label">Inversiones</div><div className="stat-value">{formatCurrency(totales.totalInversiones, currency)}</div></div>
      </div>
      {categorias.map(cat => (
        <div key={cat.key} className="category-section">
          <div className="category-header">
            <h3 className="category-title">{cat.nombre}</h3>
            <button className="btn btn-primary btn-small" onClick={() => addItem(cat.key)}>+ A√±adir activo</button>
          </div>
          {activos[cat.key].length === 0 ? <p className="text-muted">No hay activos registrados</p> : (
            <div className="table-container">
              <table><thead><tr><th>Tipo</th><th>Instituci√≥n</th><th>Transferencia</th><th>Valor</th><th style={{width:'80px'}}>Acci√≥n</th></tr></thead>
                <tbody>{activos[cat.key].map((item, idx) => (
                  <tr key={idx}>
                    <td><select className="form-input" value={item.tipo} onChange={e => updateItem(cat.key, idx, 'tipo', e.target.value)}><option value="">Seleccionar...</option>{cat.items.map(t => <option key={t} value={t}>{t}</option>)}</select></td>
                    <td><input type="text" className="form-input" placeholder="Banco, broker..." value={item.ubicacion} onChange={e => updateItem(cat.key, idx, 'ubicacion', e.target.value)} /></td>
                    <td>
                      <select className="form-input" value={item.transferencia||''} onChange={e => updateItem(cat.key, idx, 'transferencia', e.target.value)}
                        style={{borderColor: item.transferencia==='Sin designaci√≥n'?'#ef4444': item.transferencia?'#10b981':'var(--border)'}}>
                        {['','Beneficiario (TOD/POD)','Joint Tenancy (JTWROS)','Tenancy in Common','En Trust','V√≠a Testamento','Sin designaci√≥n'].map(o => <option key={o} value={o}>{o||'Seleccionar...'}</option>)}
                      </select>
                    </td>
                    <td><input type="number" className="form-input" placeholder="0" value={item.valor} onChange={e => updateItem(cat.key, idx, 'valor', e.target.value)} /></td>
                    <td><button className="btn btn-danger btn-small" onClick={() => removeItem(cat.key, idx)}>üóëÔ∏è</button></td>
                  </tr>
                ))}</tbody>
                <tfoot><tr style={{background:'#f0fdf4',borderTop:'2px solid #10b981',fontWeight:'700'}}>
                  <td colSpan="3" style={{fontWeight:'700',color:'#475569',paddingLeft:'0.5rem'}}>Total {cat.nombre}</td>
                  <td style={{fontWeight:'800',color:'#059669',fontSize:'1rem',textAlign:'right',paddingRight:'0.5rem'}}>{formatCurrency(activos[cat.key].reduce((s,i)=>s+parseNumber(i.valor),0), currency)}</td>
                  <td></td>
                </tr></tfoot>
              </table>
            </div>
          )}
        </div>
      ))}
    </div>
  );
}

// ============= INVENTARIO DEUDAS =============
function InventarioDeudas({ deudas, setDeudas, currency }) {
  const categorias = [
    { key: 'tarjetas',        nombre: 'Tarjetas de Cr√©dito' },
    { key: 'lineaPersonal',   nombre: 'L√≠nea de Cr√©dito Personal' },
    { key: 'lineaPropiedad',  nombre: 'L√≠nea de Cr√©dito de Propiedad' },
    { key: 'casa',            nombre: 'Hipoteca/Casa' },
    { key: 'auto',            nombre: 'Pr√©stamo de Auto' },
    { key: 'educacion',       nombre: 'Pr√©stamos Educativos' },
    { key: 'otros',           nombre: 'Otros Pr√©stamos' }
  ];
  const addDeuda    = cat => setDeudas(prev => ({ ...prev, [cat]: [...prev[cat], { compania: '', apr: '', meses: '', mensual: '', balance: '' }] }));
  const updateDeuda = (cat, idx, field, val) => setDeudas(prev => ({ ...prev, [cat]: prev[cat].map((item, i) => i === idx ? { ...item, [field]: val } : item) }));
  const removeDeuda = (cat, idx) => setDeudas(prev => ({ ...prev, [cat]: prev[cat].filter((_, i) => i !== idx) }));
  // Calcula pago mensual si no viene del import (amortizaci√≥n est√°ndar)
  const estimarMensual = (d) => {
    if (parseNumber(d.mensual) > 0) return parseNumber(d.mensual);
    const P = parseNumber(d.balance);
    const n = parseFloat(d.meses) || 0;
    const r = (parseFloat(d.apr)  || 0) / 100 / 12;
    if (P <= 0 || n <= 0) return 0;
    if (r === 0) return Math.round(P / n);
    return Math.round(P * r / (1 - Math.pow(1 + r, -n)));
  };
  const totalBalance = Object.values(deudas).flat().reduce((s, d) => s + parseNumber(d.balance), 0);
  const totalMensual = Object.values(deudas).flat().reduce((s, d) => s + estimarMensual(d), 0);
  return (
    <div>
      <div className="stats-grid">
        <div className="stat-card" style={{background:'linear-gradient(135deg,var(--danger) 0%,#dc2626 100%)'}}><div className="stat-label">Balance Total</div><div className="stat-value">{formatCurrency(totalBalance, currency)}</div></div>
        <div className="stat-card" style={{background:'linear-gradient(135deg,var(--amber) 0%,#d97706 100%)'}}><div className="stat-label">Pago Mensual Total</div><div className="stat-value">{formatCurrency(totalMensual, currency)}</div></div>
      </div>
      {categorias.map(cat => (
        <div key={cat.key} className="category-section">
          <div className="category-header"><h3 className="category-title">{cat.nombre}</h3><button className="btn btn-primary btn-small" onClick={() => addDeuda(cat.key)}>+ A√±adir deuda</button></div>
          {deudas[cat.key].length === 0 ? <p className="text-muted">No hay deudas registradas</p> : (
            <div className="table-container">
              <table><thead><tr><th>Compa√±√≠a</th><th>APR (%)</th><th>Meses</th><th>Mensual</th><th>Balance</th><th style={{width:'80px'}}>Acci√≥n</th></tr></thead>
                <tbody>{deudas[cat.key].map((d, idx) => (
                  <tr key={idx}>
                    <td><input type="text" className="form-input" placeholder="Compa√±√≠a" value={d.compania} onChange={e => updateDeuda(cat.key, idx, 'compania', e.target.value)} /></td>
                    <td><input type="number" className="form-input" placeholder="19.99" step="0.01" value={d.apr} onChange={e => updateDeuda(cat.key, idx, 'apr', e.target.value)} /></td>
                    <td><input type="number" className="form-input" placeholder="24" value={d.meses} onChange={e => updateDeuda(cat.key, idx, 'meses', e.target.value)} /></td>
                    <td><input type="number" className="form-input" placeholder="Calculado auto" value={d.mensual} onChange={e => updateDeuda(cat.key, idx, 'mensual', e.target.value)} /></td>
                    <td><input type="number" className="form-input" placeholder="3500" value={d.balance} onChange={e => updateDeuda(cat.key, idx, 'balance', e.target.value)} /></td>
                    <td><button className="btn btn-danger btn-small" onClick={() => removeDeuda(cat.key, idx)}>üóëÔ∏è</button></td>
                  </tr>
                ))}</tbody>
                <tfoot><tr style={{background:'#fef2f2',borderTop:'2px solid #ef4444',fontWeight:'700'}}>
                  <td colSpan="3" style={{fontWeight:'700',color:'#475569',paddingLeft:'0.5rem'}}>Total {cat.nombre}</td>
                  <td style={{fontWeight:'800',color:'#dc2626',fontSize:'1rem',textAlign:'right',paddingRight:'0.5rem'}}>{formatCurrency(deudas[cat.key].reduce((s,d)=>s+estimarMensual(d),0), currency)}</td>
                  <td style={{fontWeight:'800',color:'#dc2626',fontSize:'1rem',textAlign:'right',paddingRight:'0.5rem'}}>{formatCurrency(deudas[cat.key].reduce((s,d)=>s+parseNumber(d.balance),0), currency)}</td>
                  <td></td>
                </tr></tfoot>
              </table>
            </div>
          )}
        </div>
      ))}
    </div>
  );
}

// ============= HOJA DE BALANCE =============
function HojaBalance({ activos, deudas, totales, currency }) {
  const nombresDeuda = { tarjetas:'Tarjetas de Cr√©dito', lineaPersonal:'L√≠nea Personal', lineaPropiedad:'L√≠nea de Propiedad', casa:'Hipoteca/Casa', auto:'Auto', educacion:'Educativos', otros:'Otros' };

  // Build rows for each side ‚Äî pad shorter side with nulls so totals align
  const activoRows = [
    ['Efectivo y Equivalentes', totales.totalEfectivo],
    ['Inversiones',             totales.totalInversiones],
    ['Cuentas de Retiro',       totales.totalRetiro],
    ['Bienes Ra√≠ces',           totales.totalBienesRaices],
    ['Bienes Personales',       totales.totalBienesPersonales],
  ];
  const pasivoRows = Object.entries(deudas)
    .map(([key, items]) => [nombresDeuda[key], items.reduce((s,i)=>s+parseNumber(i.balance),0)])
    .filter(([,val]) => val > 0);

  const maxRows = Math.max(activoRows.length, pasivoRows.length);
  const rows = Array.from({length: maxRows}, (_, i) => ({
    aLabel: activoRows[i]?.[0] ?? null,
    aVal:   activoRows[i]?.[1] ?? null,
    pLabel: pasivoRows[i]?.[0] ?? null,
    pVal:   pasivoRows[i]?.[1] ?? null,
  }));

  const cellStyle  = {padding:'0.875rem 1rem', borderBottom:'1px solid var(--border)', fontSize:'0.95rem'};
  const valStyle   = {padding:'0.875rem 1rem', borderBottom:'1px solid var(--border)', textAlign:'right', fontWeight:'700', fontFamily:"'Fraunces',serif", fontSize:'1rem'};
  const totalRowSt = {background:'#f8fafc', borderTop:'2px solid var(--charcoal)'};
  const totalCellSt= {padding:'1rem', fontWeight:'800', fontSize:'1.1rem', fontFamily:"'Fraunces',serif"};

  return (
    <div>
      <div className="card">
        <div className="card-header">
          <div><h2 className="card-title">Balance General</h2><p className="card-subtitle">Resumen consolidado de tu situaci√≥n financiera</p></div>
        </div>

        <div style={{overflowX:'auto'}}>
          <table style={{width:'100%', borderCollapse:'collapse'}}>
            <thead>
              <tr style={{borderBottom:'2px solid var(--border)'}}>
                <th style={{padding:'0.75rem 1rem', textAlign:'left', color:'var(--primary)', fontSize:'1rem', fontWeight:'800', width:'25%'}}>ACTIVOS</th>
                <th style={{padding:'0.75rem 1rem', textAlign:'right', width:'25%'}}></th>
                <th style={{padding:'0.75rem 1rem', textAlign:'left', color:'var(--danger)',  fontSize:'1rem', fontWeight:'800', width:'25%', borderLeft:'2px solid var(--border)'}}>PASIVOS</th>
                <th style={{padding:'0.75rem 1rem', textAlign:'right', width:'25%'}}></th>
              </tr>
            </thead>
            <tbody>
              {rows.map((row, i) => (
                <tr key={i}>
                  <td style={cellStyle}>{row.aLabel ?? ''}</td>
                  <td style={{...valStyle, color: row.aVal > 0 ? 'var(--text)' : 'var(--text-muted)'}}>
                    {row.aVal !== null ? formatCurrency(row.aVal, currency) : ''}
                  </td>
                  <td style={{...cellStyle, borderLeft:'2px solid var(--border)'}}>{row.pLabel ?? ''}</td>
                  <td style={{...valStyle, color: row.pVal > 0 ? 'var(--text)' : 'var(--text-muted)'}}>
                    {row.pVal !== null ? formatCurrency(row.pVal, currency) : ''}
                  </td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr style={totalRowSt}>
                <td style={{...totalCellSt, color:'var(--primary)'}}>Total Activos (I)</td>
                <td style={{...totalCellSt, textAlign:'right', color:'var(--primary)', fontSize:'1.5rem'}}>{formatCurrency(totales.activosTotales, currency)}</td>
                <td style={{...totalCellSt, color:'var(--danger)', borderLeft:'2px solid var(--border)'}}>Total Pasivos (II)</td>
                <td style={{...totalCellSt, textAlign:'right', color:'var(--danger)', fontSize:'1.5rem'}}>{formatCurrency(totales.pasivosTotales, currency)}</td>
              </tr>
            </tfoot>
          </table>
        </div>

        {/* Patrimonio Neto */}
        <div style={{marginTop:'1.5rem', padding:'1.5rem', background: totales.patrimonioNeto >= 0 ? '#f0fdf4' : '#fef2f2', borderRadius:'12px', border:`2px solid ${totales.patrimonioNeto >= 0 ? '#10b981' : '#ef4444'}`, display:'flex', justifyContent:'space-between', alignItems:'center'}}>
          <div>
            <div style={{fontWeight:'800', fontSize:'1.1rem', color: totales.patrimonioNeto >= 0 ? '#059669' : '#dc2626'}}>Patrimonio Neto (I ‚àí II)</div>
            <div style={{color:'var(--text-muted)', fontSize:'0.875rem', marginTop:'0.25rem'}}>{totales.patrimonioNeto >= 0 ? '‚úÖ Patrimonio positivo' : '‚ö†Ô∏è Considera reducir deudas'}</div>
          </div>
          <div style={{fontFamily:"'Fraunces',serif", fontSize:'2.5rem', fontWeight:'900', color: totales.patrimonioNeto >= 0 ? '#059669' : '#dc2626'}}>
            {formatCurrency(totales.patrimonioNeto, currency)}
          </div>
        </div>
      </div>
    </div>
  );
}

// ============= INGRESOS Y GASTOS =============
function IngresosGastos({ ingresos, setIngresos, gastos, setGastos, modoCalculo, setModoCalculo, currency }) {
  const categoriasIngresos = ['Salario','Pago por hora','Bono','Comisi√≥n','Negocio propio','Dividendos','Renta inmueble','Pensi√≥n','Seguro Social','Otro'];
  const categoriasGastos = {
    ahorro:    { nombre: 'Ahorro',         items: ['Reserva de emergencia','401(k)','IRA/Roth','Brokerage','ETF','Cripto','Otro'] },
    deuda:     { nombre: 'Pago de Deuda',  items: ['Hipoteca','HELOC','Tarjeta de cr√©dito','Pr√©stamo de auto','Pr√©stamo estudiantil','Pr√©stamo personal','Otro'] },
    diarios:   { nombre: 'Gastos Diarios', items: ['Alimentaci√≥n','Casa','Transportaci√≥n','Entretenimiento','Telecomunicaciones','Gastos M√©dicos','Cuidado Personal','Dependientes','Regalos','Otro'] },
    seguros:   { nombre: 'Seguros',        items: ['Vida - Term','Vida - Whole','Salud','Auto','Hogar','Disability','Umbrella','Otro'] },
    impuestos: { nombre: 'Impuestos',      items: ['Federales','Estatales','Seguro social','Medicare','Propiedad','Otro'] }
  };
  const addIngreso    = () => setIngresos([...ingresos, { categoria: 'Salario', nombre: '', monto: '' }]);
  const updateIngreso = (idx, field, val) => setIngresos(ingresos.map((item, i) => i === idx ? { ...item, [field]: val } : item));
  const removeIngreso = idx => setIngresos(ingresos.filter((_, i) => i !== idx));
  const addGasto      = cat => setGastos(prev => ({ ...prev, [cat]: [...prev[cat], { categoria: categoriasGastos[cat].items[0], nombre: '', monto: '' }] }));
  const updateGasto   = (cat, idx, field, val) => setGastos(prev => ({ ...prev, [cat]: prev[cat].map((item, i) => i === idx ? { ...item, [field]: val } : item) }));
  const removeGasto   = (cat, idx) => setGastos(prev => ({ ...prev, [cat]: prev[cat].filter((_, i) => i !== idx) }));
  const mult = modoCalculo === 'anual' ? 12 : 1;
  const totalIngresos = ingresos.reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
  const totalGastos   = Object.values(gastos).flat().reduce((s, i) => s + parseNumber(i.monto), 0) * mult;
  const balance       = totalIngresos - totalGastos;
  return (
    <div>
      <div className="card">
        <div className="card-header"><div><h2 className="card-title">Modo de C√°lculo</h2></div>
          <select className="form-input" style={{width:'auto'}} value={modoCalculo} onChange={e=>setModoCalculo(e.target.value)}><option value="mensual">Mensual</option><option value="anual">Anual</option></select>
        </div>
        <div className="stats-grid">
          <div className="stat-card"><div className="stat-label">Ingresos ({modoCalculo})</div><div className="stat-value">{formatCurrency(totalIngresos,currency)}</div></div>
          <div className="stat-card" style={{background:'linear-gradient(135deg,var(--danger) 0%,#dc2626 100%)'}}><div className="stat-label">Gastos ({modoCalculo})</div><div className="stat-value">{formatCurrency(totalGastos,currency)}</div></div>
          <div className="stat-card" style={{background:balance>=0?'linear-gradient(135deg,var(--emerald) 0%,var(--emerald-dark) 100%)':'linear-gradient(135deg,var(--danger) 0%,#dc2626 100%)'}}><div className="stat-label">{balance>=0?'Super√°vit':'D√©ficit'}</div><div className="stat-value">{formatCurrency(Math.abs(balance),currency)}</div></div>
        </div>
      </div>
      <div className="category-section">
        <div className="category-header"><h3 className="category-title">üí∞ Ingresos</h3><button className="btn btn-primary btn-small" onClick={addIngreso}>+ A√±adir</button></div>
        {ingresos.length === 0 ? <p className="text-muted">No hay ingresos registrados</p> : (
          <div className="table-container"><table><thead><tr><th>Categor√≠a</th><th>Descripci√≥n</th><th>Monto ({modoCalculo})</th><th style={{width:'80px'}}>Acci√≥n</th></tr></thead>
            <tbody>{ingresos.map((item, idx) => (
              <tr key={idx}>
                <td><select className="form-input" value={item.categoria} onChange={e=>updateIngreso(idx,'categoria',e.target.value)}>{categoriasIngresos.map(c=><option key={c} value={c}>{c}</option>)}</select></td>
                <td><input type="text" className="form-input" placeholder="Descripci√≥n" value={item.nombre} onChange={e=>updateIngreso(idx,'nombre',e.target.value)} /></td>
                <td><input type="number" className="form-input" placeholder="0" value={item.monto} onChange={e=>updateIngreso(idx,'monto',e.target.value)} /></td>
                <td><button className="btn btn-danger btn-small" onClick={()=>removeIngreso(idx)}>üóëÔ∏è</button></td>
              </tr>
            ))}</tbody>
            <tfoot><tr style={{background:'#f0fdf4',borderTop:'2px solid #10b981',fontWeight:'700'}}>
              <td colSpan="2" style={{fontWeight:'700',color:'#475569',paddingLeft:'0.5rem'}}>Total Ingresos</td>
              <td style={{fontWeight:'800',color:'#059669',fontSize:'1rem',textAlign:'right',paddingRight:'0.5rem'}}>{formatCurrency(ingresos.reduce((s,i)=>s+parseNumber(i.monto),0)*mult, currency)}</td>
              <td></td>
            </tr></tfoot>
          </table></div>
        )}
      </div>
      {Object.entries(categoriasGastos).map(([key, config]) => (
        <div key={key} className="category-section">
          <div className="category-header"><h3 className="category-title">{config.nombre}</h3><button className="btn btn-primary btn-small" onClick={()=>addGasto(key)}>+ A√±adir</button></div>
          {gastos[key].length === 0 ? <p className="text-muted">No hay gastos registrados</p> : (
            <div className="table-container"><table><thead><tr><th>Categor√≠a</th><th>Descripci√≥n</th><th>Monto ({modoCalculo})</th><th style={{width:'80px'}}>Acci√≥n</th></tr></thead>
              <tbody>{gastos[key].map((item, idx) => (
                <tr key={idx}>
                  <td><select className="form-input" value={item.categoria} onChange={e=>updateGasto(key,idx,'categoria',e.target.value)}>{config.items.map(c=><option key={c} value={c}>{c}</option>)}</select></td>
                  <td><input type="text" className="form-input" placeholder="Descripci√≥n" value={item.nombre} onChange={e=>updateGasto(key,idx,'nombre',e.target.value)} /></td>
                  <td><input type="number" className="form-input" placeholder="0" value={item.monto} onChange={e=>updateGasto(key,idx,'monto',e.target.value)} /></td>
                  <td><button className="btn btn-danger btn-small" onClick={()=>removeGasto(key,idx)}>üóëÔ∏è</button></td>
                </tr>
              ))}</tbody>
              <tfoot><tr style={{background:'#fef2f2',borderTop:'2px solid #ef4444',fontWeight:'700'}}>
                <td colSpan="2" style={{fontWeight:'700',color:'#475569',paddingLeft:'0.5rem'}}>Total {config.nombre}</td>
                <td style={{fontWeight:'800',color:'#dc2626',fontSize:'1rem',textAlign:'right',paddingRight:'0.5rem'}}>{formatCurrency(gastos[key].reduce((s,i)=>s+parseNumber(i.monto),0)*mult, currency)}</td>
                <td></td>
              </tr></tfoot>
            </table></div>
          )}
        </div>
      ))}
    </div>
  );
}

// ============= GR√ÅFICOS TAB =============
function GraficosTab({ activos, deudas, ingresos, gastos, totales, ratiosData, currency }) {
  const [retornoAnual, setRetornoAnual] = React.useState(7);
  React.useEffect(() => {
    ['pieActivos','pieGastos','barIngresosGastos','donutAssetAllocation','lineProyeccion'].forEach(id => { const c = Chart.getChart(id); if(c) c.destroy(); });
    const totalEfectivo  = activos.efectivo.reduce((s,i)=>s+parseNumber(i.valor),0);
    const totalInv       = activos.inversiones.reduce((s,i)=>s+parseNumber(i.valor),0);
    const totalRetiro    = activos.retiro.reduce((s,i)=>s+parseNumber(i.valor),0);
    const totalBR        = activos.bienesRaices.reduce((s,i)=>s+parseNumber(i.valor),0);
    const totalBP        = activos.bienesPersonales.reduce((s,i)=>s+parseNumber(i.valor),0);
    const mult = 12;
    const totalIngresos  = ingresos.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
    const totalAhorro    = gastos.ahorro.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
    const totalDiarios   = gastos.diarios.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
    const totalDeudaG    = gastos.deuda.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
    const totalImp       = gastos.impuestos.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
    const totalSeg       = gastos.seguros.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
    const totalGastos    = totalDiarios+totalDeudaG+totalImp+totalSeg;
    const tooltip = { callbacks: { label: ctx => { const v=ctx.parsed||ctx.parsed.y; const total=Array.isArray(ctx.dataset.data)?ctx.dataset.data.reduce((a,b)=>a+b,0):null; return total?`${ctx.label}: ${formatCurrency(v,currency)} (${((v/total)*100).toFixed(1)}%)`:formatCurrency(v,currency); } } };
    if(totales.activosTotales>0){ const c=document.getElementById('pieActivos'); if(c) new Chart(c,{type:'pie',data:{labels:['Efectivo','Inversiones','Retiro','Bienes Ra√≠ces','Bienes Personales'],datasets:[{data:[totalEfectivo,totalInv,totalRetiro,totalBR,totalBP],backgroundColor:['#10b981','#3b82f6','#8b5cf6','#f59e0b','#ec4899'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'},title:{display:true,text:'Distribuci√≥n de Activos',font:{size:16,weight:'bold'}},tooltip}}}); }
    if(totalGastos>0){ const c=document.getElementById('pieGastos'); if(c) new Chart(c,{type:'pie',data:{labels:['Gastos Diarios','Deuda','Impuestos','Seguros'],datasets:[{data:[totalDiarios,totalDeudaG,totalImp,totalSeg],backgroundColor:['#ef4444','#f59e0b','#eab308','#06b6d4'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'},title:{display:true,text:'Distribuci√≥n de Gastos Anuales',font:{size:16,weight:'bold'}},tooltip}}}); }
    const cb=document.getElementById('barIngresosGastos'); if(cb) new Chart(cb,{type:'bar',data:{labels:['Ingresos','Gastos','Ahorro'],datasets:[{data:[totalIngresos,totalGastos,totalAhorro],backgroundColor:['rgba(16,185,129,0.8)','rgba(239,68,68,0.8)','rgba(59,130,246,0.8)'],borderColor:['rgb(16,185,129)','rgb(239,68,68)','rgb(59,130,246)'],borderWidth:2}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},title:{display:true,text:'Ingresos vs Gastos vs Ahorro (Anual)',font:{size:16,weight:'bold'}},tooltip:{callbacks:{label:ctx=>formatCurrency(ctx.parsed.y,currency)}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>formatCurrency(v,currency)}}}}});
    if(totales.activosTotales>0){ const cd=document.getElementById('donutAssetAllocation'); if(cd) new Chart(cd,{type:'doughnut',data:{labels:['Activos L√≠quidos','Retiro','Activos Il√≠quidos'],datasets:[{data:[totalEfectivo+totalInv,totalRetiro,totalBR+totalBP],backgroundColor:['#10b981','#8b5cf6','#f59e0b'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'},title:{display:true,text:'Asset Allocation',font:{size:16,weight:'bold'}},tooltip}}}); }
    if(totales.patrimonioNeto>0&&totalAhorro>0){
      const r=retornoAnual/100; const years=[0,5,10,15,20,25,30];
      const proj=years.map(y=>totales.patrimonioNeto*Math.pow(1+r,y)+totalAhorro*((Math.pow(1+r,y)-1)/r));
      const cl=document.getElementById('lineProyeccion'); if(cl) new Chart(cl,{type:'line',data:{labels:years.map(y=>`A√±o ${y}`),datasets:[{label:'Patrimonio',data:proj,borderColor:'rgb(59,130,246)',backgroundColor:'rgba(59,130,246,0.1)',borderWidth:3,fill:true,tension:0.4,pointRadius:5}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},title:{display:true,text:`Proyecci√≥n (${formatCurrency(totalAhorro,currency)}/a√±o, ${retornoAnual}% retorno)`,font:{size:16,weight:'bold'}},tooltip:{callbacks:{label:ctx=>formatCurrency(ctx.parsed.y,currency)}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>formatCurrency(v,currency)}}}}});
    }
  }, [activos,deudas,ingresos,gastos,totales,ratiosData,currency,retornoAnual]);

  return (
    <div style={{padding:'2rem'}}>
      <h2 style={{fontSize:'2rem',fontWeight:'800',marginBottom:'1.5rem',color:'#1e293b'}}>üìà An√°lisis Gr√°fico</h2>
      <div style={{background:'white',padding:'1.5rem',borderRadius:'12px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)',marginBottom:'2rem'}}>
        <div style={{display:'flex',alignItems:'center',gap:'1.5rem',flexWrap:'wrap'}}>
          <div style={{flex:'1',minWidth:'200px'}}>
            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',color:'#64748b',marginBottom:'0.5rem'}}>Retorno Anual Esperado</label>
            <input type="range" min="0" max="20" step="0.5" value={retornoAnual} onChange={e=>setRetornoAnual(parseFloat(e.target.value))} style={{width:'100%',height:'8px',borderRadius:'4px',outline:'none',cursor:'pointer'}} />
          </div>
          <div style={{background:'linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)',color:'white',padding:'1rem 2rem',borderRadius:'12px',textAlign:'center',minWidth:'120px'}}>
            <div style={{fontSize:'0.875rem',opacity:0.9,marginBottom:'0.25rem'}}>Retorno</div>
            <div style={{fontSize:'2.5rem',fontWeight:'800'}}>{retornoAnual}%</div>
          </div>
        </div>
        <div style={{marginTop:'1rem',fontSize:'0.75rem',color:'#64748b',display:'flex',justifyContent:'space-between'}}>
          <span>0% (Conservador)</span><span>7% (Hist√≥rico S&P 500)</span><span>20% (Agresivo)</span>
        </div>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(400px, 1fr))',gap:'2rem',marginBottom:'2rem'}}>
        <div style={{background:'white',padding:'1.5rem',borderRadius:'12px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)',gridColumn:'span 2'}}><canvas id="lineProyeccion" style={{maxHeight:'400px'}}></canvas></div>
        <div style={{background:'white',padding:'1.5rem',borderRadius:'12px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}><canvas id="pieActivos" style={{maxHeight:'350px'}}></canvas></div>
        <div style={{background:'white',padding:'1.5rem',borderRadius:'12px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}><canvas id="pieGastos" style={{maxHeight:'350px'}}></canvas></div>
        <div style={{background:'white',padding:'1.5rem',borderRadius:'12px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}><canvas id="barIngresosGastos" style={{maxHeight:'350px'}}></canvas></div>
        <div style={{background:'white',padding:'1.5rem',borderRadius:'12px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}><canvas id="donutAssetAllocation" style={{maxHeight:'350px'}}></canvas></div>
      </div>
    </div>
  );
}

// ============= VISTA GENERAL =============
function VistaGeneral({ totales, ingresos, gastos, ratiosData, currency, setActiveTab, userProfile }) {
  const mult = 12;
  const totalIngresos    = ingresos.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
  const totalAhorro      = gastos.ahorro.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
  const totalDeudaGastos = gastos.deuda.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
  const totalDiarios     = gastos.diarios.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
  const totalSeguros     = gastos.seguros.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
  const totalImpuestos   = gastos.impuestos.reduce((s,i)=>s+parseNumber(i.monto),0)*mult;
  const totalGastos      = totalDeudaGastos + totalDiarios + totalSeguros + totalImpuestos;
  const deficit          = totalIngresos - totalGastos - totalAhorro;
  const ingresoBruto     = ratiosData.ingresoBruto || totalIngresos;
  const ingresoNeto      = ratiosData.ingresoNeto  || (totalIngresos - totalImpuestos - totalSeguros);
  const mesesReserva     = ratiosData.gastosEsencialesMensuales > 0 ? ratiosData.reserva / ratiosData.gastosEsencialesMensuales : 0;
  const razonCorriente   = ratiosData.pasivosCorrientes > 0 ? ratiosData.reserva / ratiosData.pasivosCorrientes : 0;
  const tasaAhorro       = ingresoBruto > 0 ? ratiosData.ahorroAnual / ingresoBruto : 0;
  const capAcum          = ingresoBruto > 0 ? (ratiosData.ahorroAnual - ratiosData.deudaAnual) / ingresoBruto : 0;
  const dtiNeto          = ingresoNeto  > 0 ? (ratiosData.pagoDeudaMensual * 12) / ingresoNeto : 0;
  const deudaActivos     = totales.activosTotales > 0 ? totales.pasivosTotales / totales.activosTotales : 0;
  const patrimonioActivos= totales.activosTotales > 0 ? totales.patrimonioNeto  / totales.activosTotales : 0;

  const tieneNombre = userProfile.nombre && userProfile.apellido;
  const isCouple    = userProfile.analisisConjunto;

  const RatioCard = ({ title, items }) => (
    <div style={{background:'white',borderRadius:'16px',padding:'1.25rem',boxShadow:'0 2px 8px rgba(0,0,0,0.08)',cursor:'pointer',border:'1px solid var(--border)'}} onClick={()=>setActiveTab('ratios')}>
      <div style={{background:'var(--primary)',color:'white',padding:'0.4rem 0.9rem',borderRadius:'8px',fontWeight:'700',fontSize:'0.8rem',marginBottom:'1rem',textTransform:'uppercase',letterSpacing:'0.5px',display:'inline-block'}}>{title}</div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.75rem'}}>
        {items.map(({label, value, ok}) => (
          <div key={label} style={{textAlign:'center',padding:'0.5rem'}}>
            <div style={{fontSize:'0.7rem',color:'#64748b',marginBottom:'0.35rem',fontWeight:'600',lineHeight:'1.3'}}>{label}</div>
            <div style={{fontSize:'1.4rem',fontWeight:'800',color:'#0f172a'}}>{value}</div>
            <div style={{fontSize:'1rem',marginTop:'0.2rem'}}>{ok==='green'?'‚úÖ':ok==='yellow'?'‚ö†Ô∏è':ok==='red'?'üö®':''}</div>
          </div>
        ))}
      </div>
    </div>
  );

  const Row = ({label, value, color, bg, tab}) => (
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'0.65rem 0.9rem',background:bg,borderRadius:'8px',marginBottom:'0.4rem',cursor:tab?'pointer':'default'}}
      onClick={()=>tab&&setActiveTab(tab)}>
      <span style={{color:'#64748b',fontSize:'0.875rem'}}>{label}</span>
      <span style={{fontWeight:'700',color,fontSize:'0.95rem'}}>{value}</span>
    </div>
  );

  return (
    <div style={{padding:'1.5rem'}}>
      {/* 3-column CSS Grid ‚Äî never wraps */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: '300px 1fr 1fr',
        gap: '1.5rem',
        alignItems: 'start',
        minHeight: '600px'
      }}>

        {/* ‚îÄ‚îÄ COLUMNA 1: Flujo de Caja + Balance General ‚îÄ‚îÄ */}
        <div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>
          <div style={{background:'white',borderRadius:'16px',padding:'1.25rem',boxShadow:'0 2px 8px rgba(0,0,0,0.08)',border:'1px solid var(--border)'}}>
            <div style={{fontWeight:'700',marginBottom:'0.875rem',color:'var(--primary)',fontSize:'0.875rem',textTransform:'uppercase',letterSpacing:'0.5px'}}>üíµ Flujo de Caja</div>
            <Row label="Ingresos anuales"  value={formatCurrency(totalIngresos, currency)}      color="#10b981" bg="#f0fdf4" tab="ingresos"/>
            <Row label="Gastos anuales"    value={formatCurrency(totalGastos, currency)}        color="#ef4444" bg="#fef2f2" tab="ingresos"/>
            <Row label="Ahorro anual"      value={formatCurrency(totalAhorro, currency)}        color="#10b981" bg="#f0fdf4" tab="ingresos"/>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'0.75rem 0.9rem',background:deficit>=0?'#f0fdf4':'#fef2f2',borderRadius:'8px',border:`2px solid ${deficit>=0?'#10b981':'#ef4444'}`}}>
              <span style={{color:'#475569',fontWeight:'600',fontSize:'0.875rem'}}>{deficit>=0?'Super√°vit':'D√©ficit'}</span>
              <span style={{fontWeight:'800',color:deficit>=0?'#10b981':'#ef4444',fontSize:'1rem'}}>{formatCurrency(Math.abs(deficit), currency)}</span>
            </div>
          </div>

          <div style={{background:'white',borderRadius:'16px',padding:'1.25rem',boxShadow:'0 2px 8px rgba(0,0,0,0.08)',border:'1px solid var(--border)'}}>
            <div style={{fontWeight:'700',marginBottom:'0.875rem',color:'var(--primary)',fontSize:'0.875rem',textTransform:'uppercase',letterSpacing:'0.5px'}}>‚öñÔ∏è Balance General</div>
            <Row label="Activos"   value={formatCurrency(totales.activosTotales,  currency)} color="#10b981" bg="#f0fdf4" tab="activos"/>
            <Row label="Pasivos"   value={formatCurrency(totales.pasivosTotales,  currency)} color="#ef4444" bg="#fef2f2" tab="deudas"/>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'0.75rem 0.9rem',background:'#f0fdf4',borderRadius:'8px',border:'2px solid #10b981',cursor:'pointer'}} onClick={()=>setActiveTab('balance')}>
              <span style={{color:'#475569',fontWeight:'600',fontSize:'0.875rem'}}>Patrimonio Neto</span>
              <span style={{fontWeight:'800',color:totales.patrimonioNeto>=0?'#10b981':'#ef4444',fontSize:'1rem'}}>{formatCurrency(totales.patrimonioNeto, currency)}</span>
            </div>
          </div>
        </div>

        {/* ‚îÄ‚îÄ COLUMNA 2: Avatar + Perfil del cliente ‚îÄ‚îÄ */}
        <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:'1.25rem',padding:'1rem'}}>

          {/* Avatares */}
          {isCouple ? (
            <div style={{display:'flex',gap:'1.25rem',alignItems:'center'}}>
              <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:'0.5rem'}}>
                <div style={{width:'90px',height:'90px',background:'linear-gradient(135deg,var(--primary) 0%,#2563eb 100%)',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'2.75rem',border:'4px solid white',boxShadow:'0 8px 24px rgba(57,86,232,0.3)'}}>{userProfile.avatar||'üë§'}</div>
                <div style={{fontWeight:'700',fontSize:'0.875rem',color:'#333',textAlign:'center'}}>{userProfile.nombre||'‚Äî'}</div>
              </div>
              <div style={{fontSize:'1.75rem',color:'var(--primary)',marginTop:'-1rem'}}>‚ù§Ô∏è</div>
              <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:'0.5rem'}}>
                <div style={{width:'90px',height:'90px',background:'linear-gradient(135deg,#ec4899 0%,#db2777 100%)',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'2.75rem',border:'4px solid white',boxShadow:'0 8px 24px rgba(236,72,153,0.3)'}}>{userProfile.parejaAvatar||'üë§'}</div>
                <div style={{fontWeight:'700',fontSize:'0.875rem',color:'#333',textAlign:'center'}}>{userProfile.parejaNombre||'‚Äî'}</div>
              </div>
            </div>
          ) : (
            <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:'0.75rem'}}>
              <div style={{width:'110px',height:'110px',background:'linear-gradient(135deg,var(--primary) 0%,#2563eb 100%)',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'3.5rem',border:'4px solid white',boxShadow:'0 8px 24px rgba(57,86,232,0.3)'}}>{userProfile.avatar||'üë§'}</div>
            </div>
          )}

          {/* Nombre completo */}
          <div style={{textAlign:'center'}}>
            <div style={{fontWeight:'800',color:'#0f172a',fontSize:'1.3rem',lineHeight:'1.2'}}>
              {tieneNombre ? `${userProfile.nombre} ${userProfile.apellido}` : 'Sin nombre'}
            </div>
            {isCouple && userProfile.parejaNombre && (
              <div style={{color:'#64748b',fontSize:'0.9rem',marginTop:'0.25rem'}}>
                & {userProfile.parejaNombre} {userProfile.parejaApellido}
              </div>
            )}
          </div>

          {/* Info pills */}
          <div style={{display:'flex',flexWrap:'wrap',gap:'0.5rem',justifyContent:'center'}}>
            {userProfile.edad && (
              <span style={{background:'#eff6ff',color:'var(--primary)',padding:'0.35rem 0.85rem',borderRadius:'999px',fontSize:'0.8rem',fontWeight:'600'}}>
                üéÇ {userProfile.edad} a√±os
              </span>
            )}
            {userProfile.estadoCivil && (
              <span style={{background:'#f0fdf4',color:'#059669',padding:'0.35rem 0.85rem',borderRadius:'999px',fontSize:'0.8rem',fontWeight:'600',textTransform:'capitalize'}}>
                {userProfile.estadoCivil}
              </span>
            )}
            {userProfile.dependientes > 0 && (
              <span style={{background:'#fffbeb',color:'#d97706',padding:'0.35rem 0.85rem',borderRadius:'999px',fontSize:'0.8rem',fontWeight:'600'}}>
                üë∂ {userProfile.dependientes} dep.
              </span>
            )}
            {isCouple && (
              <span style={{background:'#fdf2f8',color:'#9333ea',padding:'0.35rem 0.85rem',borderRadius:'999px',fontSize:'0.8rem',fontWeight:'600'}}>
                üíë An√°lisis conjunto
              </span>
            )}
          </div>

          {!tieneNombre && (
            <div style={{background:'#fffbeb',border:'1px solid #f59e0b',borderRadius:'10px',padding:'0.75rem 1rem',fontSize:'0.8rem',color:'#92400e',textAlign:'center',maxWidth:'220px'}}>
              üìÇ Importa el Discovery o edita tu perfil para ver el nombre del cliente
            </div>
          )}
        </div>

        {/* ‚îÄ‚îÄ COLUMNA 3: Ratios Financieros ‚îÄ‚îÄ */}
        <div style={{display:'flex',flexDirection:'column',gap:'0.875rem'}}>
          <div style={{fontWeight:'800',fontSize:'1rem',color:'#0f172a',marginBottom:'0.25rem'}}>üéØ Ratios Financieros <span style={{fontSize:'0.75rem',color:'var(--text-muted)',fontWeight:'400'}}>‚Äî clic para ver detalle</span></div>

          <RatioCard title="üíß Liquidez" items={[
            {label:'Meses de reserva',   value:isFinite(mesesReserva)?mesesReserva.toFixed(1)+'m':'‚Äî',   ok:mesesReserva>=6?'green':mesesReserva>=3?'yellow':'red'},
            {label:'Raz√≥n corriente',    value:isFinite(razonCorriente)?razonCorriente.toFixed(2):'‚Äî',   ok:razonCorriente>=1?'green':'red'},
          ]}/>

          <RatioCard title="üê∑ Ahorro" items={[
            {label:'Tasa de ahorro',      value:isFinite(tasaAhorro)?(tasaAhorro*100).toFixed(1)+'%':'‚Äî',   ok:tasaAhorro>=0.30?'green':tasaAhorro>=0.15?'yellow':'red'},
            {label:'Cap. acumulaci√≥n',    value:isFinite(capAcum)?(capAcum*100).toFixed(1)+'%':'‚Äî',         ok:capAcum>=0.30?'green':capAcum>=0.10?'yellow':'red'},
          ]}/>

          <RatioCard title="üè¶ Deuda" items={[
            {label:'DTI neto',            value:isFinite(dtiNeto)?(dtiNeto*100).toFixed(1)+'%':'‚Äî',         ok:dtiNeto<=0.36?'green':'red'},
            {label:'Pasivos / Activos',   value:isFinite(deudaActivos)?(deudaActivos*100).toFixed(1)+'%':'‚Äî', ok:deudaActivos<=0.30?'green':deudaActivos<=0.50?'yellow':'red'},
          ]}/>

          <RatioCard title="üíé Patrimonio" items={[
            {label:'Patrimonio / Activos', value:isFinite(patrimonioActivos)?(patrimonioActivos*100).toFixed(1)+'%':'‚Äî', ok:patrimonioActivos>=0.70?'green':patrimonioActivos>=0.50?'yellow':'red'},
            {label:'Ver an√°lisis completo ‚Üí', value:'', ok:''},
          ]}/>
        </div>

      </div>
    </div>
  );
}



// ============= PROTECCI√ìN =============
function Proteccion({ proteccion, setProteccion, activos, setActivos, currency }) {
  const TIPOS_DOC = ['Testamento','Living Trust','Power of Attorney','Healthcare Directive','Beneficiarios actualizados'];
  const TIPOS_POLIZA = ['Vida - Term','Vida - Whole','Salud','Auto','Hogar','Disability','Umbrella','Otro'];
  const TRANSFER_OPTS = ['','Beneficiario (TOD/POD)','Joint Tenancy (JTWROS)','Tenancy in Common','En Trust','V√≠a Testamento','Sin designaci√≥n'];

  const updateDoc    = (idx, field, val) => setProteccion(prev => ({ ...prev, documentos: prev.documentos.map((d,i) => i===idx ? {...d,[field]:val} : d) }));
  const addPoliza    = () => setProteccion(prev => ({ ...prev, polizas: [...prev.polizas, { tipo:'Vida - Term', aseguradora:'', numeroPoliza:'', cobertura:'', prima:'', frecuenciaPrima:'mensual', deducible:'', beneficiario:'', renovacion:'', notas:'' }] }));
  const updatePoliza = (idx, field, val) => setProteccion(prev => ({ ...prev, polizas: prev.polizas.map((p,i) => i===idx ? {...p,[field]:val} : p) }));
  const removePoliza = idx => setProteccion(prev => ({ ...prev, polizas: prev.polizas.filter((_,i) => i!==idx) }));

  // Flatten all activos with transferencia info
  const todosActivos = Object.entries(activos).flatMap(([cat, items]) =>
    items.map(item => ({ ...item, cat }))
  );
  const sinDesignacion = todosActivos.filter(a => !a.transferencia || a.transferencia === 'Sin designaci√≥n');
  const conDesignacion = todosActivos.filter(a => a.transferencia && a.transferencia !== 'Sin designaci√≥n');

  const totalCobertura = proteccion.polizas.reduce((s,p) => s + parseNumber(p.cobertura), 0);
  const totalPrimas    = proteccion.polizas.reduce((s,p) => {
    const m = parseNumber(p.prima);
    return s + (p.frecuenciaPrima === 'anual' ? m/12 : m);
  }, 0);

  const docStatus = (tiene) => tiene === 'si' ? { bg:'#f0fdf4', border:'#10b981', color:'#059669', label:'‚úÖ S√≠' }
    : tiene === 'desactualizado' ? { bg:'#fffbeb', border:'#f59e0b', color:'#d97706', label:'‚ö†Ô∏è Desactualizado' }
    : { bg:'#fef2f2', border:'#ef4444', color:'#dc2626', label:'‚ùå No' };

  const CAT_LABELS = { efectivo:'Efectivo', inversiones:'Inversiones', retiro:'Retiro', bienesRaices:'Bienes Ra√≠ces', bienesPersonales:'Bienes Personales' };

  return (
    <div>
      {/* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */}
      <div className="stats-grid">
        <div className="stat-card" style={{background:'linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%)'}}>
          <div className="stat-label">Documentos activos</div>
          <div className="stat-value">{proteccion.documentos.filter(d=>d.tiene==='si').length} / {proteccion.documentos.length}</div>
        </div>
        <div className="stat-card" style={{background:'linear-gradient(135deg,#0891b2 0%,#0e7490 100%)'}}>
          <div className="stat-label">Cobertura total seguros</div>
          <div className="stat-value">{formatCurrency(totalCobertura, currency)}</div>
        </div>
        <div className="stat-card" style={{background:sinDesignacion.length>0?'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)':'linear-gradient(135deg,#10b981 0%,#059669 100%)'}}>
          <div className="stat-label">Activos sin designaci√≥n</div>
          <div className="stat-value">{sinDesignacion.length}</div>
        </div>
        <div className="stat-card" style={{background:'linear-gradient(135deg,var(--amber) 0%,#d97706 100%)'}}>
          <div className="stat-label">Primas / mes</div>
          <div className="stat-value">{formatCurrency(totalPrimas, currency)}</div>
        </div>
      </div>

      {/* ‚îÄ‚îÄ Documentos Legales ‚îÄ‚îÄ */}
      <div className="category-section">
        <div className="category-header"><h3 className="category-title">üìã Documentos Legales</h3></div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(340px,1fr))',gap:'1rem'}}>
          {proteccion.documentos.map((doc, idx) => {
            const st = docStatus(doc.tiene);
            return (
              <div key={idx} style={{border:`2px solid ${st.border}`,borderRadius:'12px',padding:'1.25rem',background:st.bg}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.875rem'}}>
                  <div style={{fontWeight:'700',fontSize:'1rem'}}>{doc.tipo}</div>
                  <select value={doc.tiene} onChange={e=>updateDoc(idx,'tiene',e.target.value)}
                    style={{padding:'0.35rem 0.75rem',borderRadius:'8px',border:`1px solid ${st.border}`,background:'white',fontWeight:'600',fontSize:'0.85rem',cursor:'pointer',color:st.color}}>
                    <option value="no">‚ùå No</option>
                    <option value="si">‚úÖ S√≠</option>
                    <option value="desactualizado">‚ö†Ô∏è Desactualizado</option>
                  </select>
                </div>
                {doc.tiene !== 'no' && (
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem'}}>
                    <div>
                      <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.25rem'}}>Fecha</div>
                      <input type="date" className="form-input" value={doc.fecha} onChange={e=>updateDoc(idx,'fecha',e.target.value)} style={{fontSize:'0.875rem',padding:'0.5rem'}}/>
                    </div>
                    <div>
                      <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.25rem'}}>Abogado / Contacto</div>
                      <input type="text" className="form-input" placeholder="Nombre..." value={doc.contacto} onChange={e=>updateDoc(idx,'contacto',e.target.value)} style={{fontSize:'0.875rem',padding:'0.5rem'}}/>
                    </div>
                  </div>
                )}
                {doc.tiene === 'no' && (
                  <div style={{fontSize:'0.8rem',color:st.color,marginTop:'0.25rem'}}>‚ö†Ô∏è Item de acci√≥n para el cliente</div>
                )}
              </div>
            );
          })}
        </div>
      </div>

      {/* ‚îÄ‚îÄ P√≥lizas de Seguro ‚îÄ‚îÄ */}
      <div className="category-section">
        <div className="category-header">
          <h3 className="category-title">üõ°Ô∏è P√≥lizas de Seguro</h3>
          <button className="btn btn-primary btn-small" onClick={addPoliza}>+ A√±adir p√≥liza</button>
        </div>
        {proteccion.polizas.length === 0 ? (
          <p className="text-muted">No hay p√≥lizas registradas</p>
        ) : proteccion.polizas.map((p, idx) => (
          <div key={idx} style={{border:'1px solid var(--border)',borderRadius:'12px',padding:'1.25rem',marginBottom:'1rem',background:'#fafafa'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
              <select className="form-input" value={p.tipo} onChange={e=>updatePoliza(idx,'tipo',e.target.value)} style={{width:'auto',fontWeight:'700',fontSize:'1rem'}}>
                {TIPOS_POLIZA.map(t=><option key={t} value={t}>{t}</option>)}
              </select>
              <button className="btn btn-danger btn-small" onClick={()=>removePoliza(idx)}>üóëÔ∏è</button>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))',gap:'0.75rem'}}>
              {[
                ['Aseguradora','aseguradora','text','Nombre compa√±√≠a'],
                ['# P√≥liza','numeroPoliza','text','N√∫mero de p√≥liza'],
                ['Beneficiario','beneficiario','text','Nombre beneficiario'],
                ['Renovaci√≥n','renovacion','date',''],
              ].map(([label,field,type,ph]) => (
                <div key={field}>
                  <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.25rem'}}>{label}</div>
                  <input type={type} className="form-input" placeholder={ph} value={p[field]} onChange={e=>updatePoliza(idx,field,e.target.value)} style={{fontSize:'0.875rem',padding:'0.5rem'}}/>
                </div>
              ))}
              <div>
                <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.25rem'}}>Cobertura ($)</div>
                <input type="number" className="form-input" placeholder="500000" value={p.cobertura} onChange={e=>updatePoliza(idx,'cobertura',e.target.value)} style={{fontSize:'0.875rem',padding:'0.5rem'}}/>
              </div>
              <div>
                <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.25rem'}}>Deducible ($)</div>
                <input type="number" className="form-input" placeholder="1000" value={p.deducible} onChange={e=>updatePoliza(idx,'deducible',e.target.value)} style={{fontSize:'0.875rem',padding:'0.5rem'}}/>
              </div>
              <div>
                <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.25rem'}}>Prima</div>
                <div style={{display:'flex',gap:'0.4rem'}}>
                  <input type="number" className="form-input" placeholder="150" value={p.prima} onChange={e=>updatePoliza(idx,'prima',e.target.value)} style={{fontSize:'0.875rem',padding:'0.5rem'}}/>
                  <select value={p.frecuenciaPrima} onChange={e=>updatePoliza(idx,'frecuenciaPrima',e.target.value)} style={{padding:'0.5rem',border:'2px solid var(--border)',borderRadius:'8px',fontSize:'0.8rem',background:'white',cursor:'pointer'}}>
                    <option value="mensual">/ mes</option>
                    <option value="anual">/ a√±o</option>
                  </select>
                </div>
              </div>
              <div style={{gridColumn:'1/-1'}}>
                <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',marginBottom:'0.25rem'}}>Notas</div>
                <input type="text" className="form-input" placeholder="Notas adicionales..." value={p.notas} onChange={e=>updatePoliza(idx,'notas',e.target.value)} style={{fontSize:'0.875rem',padding:'0.5rem'}}/>
              </div>
            </div>
          </div>
        ))}
        {proteccion.polizas.length > 0 && (
          <div style={{background:'#f0fdf4',border:'2px solid #10b981',borderRadius:'12px',padding:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <span style={{fontWeight:'700',color:'#059669'}}>Total cobertura</span>
            <span style={{fontWeight:'800',fontSize:'1.25rem',color:'#059669',fontFamily:"'Fraunces',serif"}}>{formatCurrency(totalCobertura, currency)}</span>
            <span style={{fontWeight:'700',color:'#059669'}}>Primas / mes</span>
            <span style={{fontWeight:'800',fontSize:'1.25rem',color:'#059669',fontFamily:"'Fraunces',serif"}}>{formatCurrency(totalPrimas, currency)}</span>
          </div>
        )}
      </div>

      {/* ‚îÄ‚îÄ Resumen Patrimonial ‚îÄ‚îÄ */}
      <div className="category-section">
        <div className="category-header"><h3 className="category-title">üóÇÔ∏è Resumen de Transferencia Patrimonial</h3></div>

        {sinDesignacion.length > 0 && (
          <div style={{background:'#fef2f2',border:'2px solid #ef4444',borderRadius:'12px',padding:'1rem',marginBottom:'1.25rem'}}>
            <div style={{fontWeight:'700',color:'#dc2626',marginBottom:'0.75rem'}}>‚ö†Ô∏è {sinDesignacion.length} activo(s) sin designaci√≥n de transferencia</div>
            {sinDesignacion.map((a,i) => (
              <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'0.5rem 0.75rem',background:'white',borderRadius:'8px',marginBottom:'0.4rem',fontSize:'0.875rem'}}>
                <span>{CAT_LABELS[a.cat]} ‚Äî {a.tipo||'Sin tipo'} {a.ubicacion?`(${a.ubicacion})`:''}</span>
                <span style={{fontWeight:'700',color:'#dc2626'}}>{formatCurrency(parseNumber(a.valor), currency)}</span>
              </div>
            ))}
          </div>
        )}

        {TRANSFER_OPTS.filter(o=>o).map(metodo => {
          const grupo = conDesignacion.filter(a => a.transferencia === metodo);
          if (grupo.length === 0) return null;
          const total = grupo.reduce((s,a) => s+parseNumber(a.valor), 0);
          return (
            <div key={metodo} style={{marginBottom:'0.875rem'}}>
              <div style={{fontWeight:'700',fontSize:'0.875rem',color:'#475569',marginBottom:'0.4rem',display:'flex',justifyContent:'space-between'}}>
                <span>{metodo}</span>
                <span style={{color:'#059669'}}>{formatCurrency(total,currency)}</span>
              </div>
              {grupo.map((a,i) => (
                <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'0.5rem 0.75rem',background:'#f8fafc',borderRadius:'8px',marginBottom:'0.3rem',fontSize:'0.875rem',borderLeft:'3px solid #10b981'}}>
                  <span>{CAT_LABELS[a.cat]} ‚Äî {a.tipo||'Sin tipo'} {a.ubicacion?`(${a.ubicacion})`:''}</span>
                  <span style={{fontWeight:'700'}}>{formatCurrency(parseNumber(a.valor), currency)}</span>
                </div>
              ))}
            </div>
          );
        })}

        {todosActivos.length === 0 && <p className="text-muted">Agrega activos en la pesta√±a Activos para ver el resumen de transferencia.</p>}
      </div>
    </div>
  );
}



// ============= SALIR DE DEUDA =============
function SalirDeDeuda({ deudas, gastos, currency }) {
  const { useState, useEffect, useMemo, useRef, useCallback } = React;

  const COLORS = ['#e74c3c','#3498db','#9b59b6','#2ecc71','#f39c12','#1abc9c','#e67e22','#34495e','#c0392b','#2980b9'];
  const CAT_NAMES = { tarjetas:'Tarjeta', lineaPersonal:'L√≠nea Personal', lineaPropiedad:'HELOC', casa:'Hipoteca', auto:'Auto', educacion:'Estudiante', otros:'Otro' };
  const EXCLUDE_CATS = ['casa']; // hipoteca se excluye ‚Äî estrategia de largo plazo

  const fmt$ = n => '$' + new Intl.NumberFormat('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}).format(n||0);
  const fmtFull = n => '$' + new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0);
  const fmtMos = m => { if (!m) return '‚Äî'; const y=Math.floor(m/12),mo=m%12; return y&&mo?`${y}a ${mo}m`:y?`${y} a√±o${y>1?'s':''}`:`${mo} mes${mo>1?'es':''}`; };

  function estimarMin(d) {
    const bal=parseNumber(d.balance), apr=parseFloat(d.apr)||0, n=parseFloat(d.meses)||0;
    const men=parseNumber(d.mensual);
    if (men>0) return men;
    if (bal<=0||n<=0) return Math.round(bal*0.02);
    const r=apr/100/12;
    return r===0 ? Math.round(bal/n) : Math.round(bal*r/(1-Math.pow(1+r,-n)));
  }

  // ‚îÄ‚îÄ Build debt list from Money Map
  const mmDebts = useMemo(() => {
    const list = []; let ci = 0;
    Object.entries(deudas).forEach(([key, items]) => {
      if (EXCLUDE_CATS.includes(key)) return;
      items.forEach(item => {
        const bal = parseNumber(item.balance);
        if (bal <= 0) return;
        list.push({
          id: `${key}-${ci}`,
          name: item.tipo || CAT_NAMES[key] || key,
          balance: bal,
          apr: parseFloat(item.apr) || 0,
          minPay: estimarMin(item),
          color: COLORS[ci % COLORS.length],
          enabled: true,
        });
        ci++;
      });
    });
    return list;
  }, [deudas]);

  const mmAhorro = useMemo(() =>
    (gastos.ahorro||[]).reduce((s,i)=>s+parseNumber(i.monto),0)
  , [gastos]);

  const [debtList,    setDebtList]  = useState(mmDebts);
  const [extraPay,    setExtraPay]  = useState(mmAhorro);
  const [ahorroUsado, setAhorroUsado]= useState(100);   // % of mmAhorro used
  const [extraAdicional, setExtraAd]= useState(0);      // additional from other sources
  const [method,      setMethod]    = useState('avalanche');
  const [activeTab,   setTabView]   = useState('resumen');

  const [dragIdx,     setDragIdx]   = useState(null);
  const [dragOver,    setDragOver]  = useState(null);
  const balChartRef   = useRef(null);
  const debtChartRef  = useRef(null);
  const balChart      = useRef(null);
  const debtChart     = useRef(null);

  useEffect(() => { setDebtList(mmDebts); }, [JSON.stringify(mmDebts)]);
  useEffect(() => { setExtraPay(mmAhorro); }, [mmAhorro]);

  // ‚îÄ‚îÄ Simulation engine
  function simulate(debts, extra, sortFn) {
    const ds = debts.filter(d=>d.enabled&&d.balance>0)
      .map(d=>({...d, bal:d.balance, initBal:d.balance, paidOff:null}));
    if (!ds.length) return null;
    extra = Math.max(0, extra||0);
    const schedule = [], balHistory = [];
    let totalInt=0, totalPaid=0, month=0;
    while (month<600) {
      const alive=ds.filter(d=>d.bal>0);
      if (!alive.length) break;
      month++;
      let mInt=0;
      alive.forEach(d=>{ const int=d.bal*(d.apr/100/12); d.bal+=int; mInt+=int; });
      totalInt+=mInt;
      // pay minimums
      alive.forEach(d=>{ const p=Math.min(d.minPay,d.bal); d.bal=Math.max(0,d.bal-p); totalPaid+=p; if(d.bal<0.01&&!d.paidOff)d.paidOff=month; });
      // dump extra on priority target
      let pool=extra, safety=0;
      while (pool>0.01&&++safety<500) {
        const tgt=ds.filter(d=>d.bal>0).sort(sortFn)[0];
        if (!tgt) break;
        const p=Math.min(pool,tgt.bal); tgt.bal=Math.max(0,tgt.bal-p); pool-=p; totalPaid+=p;
        if(tgt.bal<0.01&&!tgt.paidOff)tgt.paidOff=month;
      }
      const rem=ds.reduce((s,d)=>s+d.bal,0);
      schedule.push({month,mInt,rem});
      const snap={month,total:rem}; ds.forEach(d=>{snap[d.id]=d.bal;}); balHistory.push(snap);
    }
    const done=ds.every(d=>d.bal<0.01);
    return { months:done?month:null, totalInt, totalPaid, schedule, balHistory, ds };
  }

  const sortFns = {
    avalanche: (a,b)=>b.apr-a.apr||b.bal-a.bal,
    snowball:  (a,b)=>a.bal-b.bal,
    custom:    (a,b)=>0, // order preserved from debtList
  };

  const extraPayComputed = Math.round((extraPay * ahorroUsado / 100) + (extraAdicional||0));
  const enabledDebts = debtList.filter(d=>d.enabled);
  const totalBal  = enabledDebts.reduce((s,d)=>s+d.balance,0);
  const totalMin  = enabledDebts.reduce((s,d)=>s+d.minPay,0);

  // For custom: pass debts in current UI order, sort by position (stable)
  const avResult  = useMemo(()=>simulate(debtList, extraPayComputed, sortFns.avalanche), [debtList, extraPayComputed]);
  const sbResult  = useMemo(()=>simulate(debtList, extraPayComputed, sortFns.snowball),  [debtList, extraPayComputed]);
  const cusResult = useMemo(()=>simulate([...debtList].map((d,i)=>({...d,_pos:i})), extraPayComputed, (a,b)=>a._pos-b._pos), [debtList, extraPayComputed]);

  const activeResult = method==='avalanche'?avResult:method==='snowball'?sbResult:cusResult;

  // ‚îÄ‚îÄ Charts
  useEffect(()=>{
    if (!activeResult||!balChartRef.current) return;
    if (balChart.current) balChart.current.destroy();
    const r=activeResult, labels=r.schedule.map(s=>`Mes ${s.month}`), data=r.schedule.map(s=>s.rem);
    balChart.current = new Chart(balChartRef.current,{
      type:'line', data:{labels,datasets:[{label:'Balance total',data,borderColor:'#1d4ed8',backgroundColor:'rgba(29,78,216,0.08)',fill:true,tension:0.4,borderWidth:2,pointRadius:0}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmt$(c.parsed.y)}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>fmt$(v),color:'#94a3b8',font:{size:11}}},x:{ticks:{color:'#94a3b8',font:{size:10},maxTicksLimit:12}}}}
    });
    return ()=>{ if(balChart.current){balChart.current.destroy();balChart.current=null;} };
  }, [activeResult]);

  useEffect(()=>{
    if (!activeResult||!debtChartRef.current) return;
    if (debtChart.current) debtChart.current.destroy();
    const r=activeResult, labels=r.schedule.map(s=>`Mes ${s.month}`);
    const datasets=enabledDebts.map(d=>({
      label:d.name, data:r.balHistory.map(s=>s[d.id]||0),
      borderColor:d.color, backgroundColor:d.color+'22', fill:false, tension:0.4, borderWidth:2, pointRadius:0
    }));
    debtChart.current = new Chart(debtChartRef.current,{
      type:'line', data:{labels,datasets},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#334155',font:{size:11},boxWidth:12}},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${fmt$(c.parsed.y)}`}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>fmt$(v),color:'#94a3b8',font:{size:11}}},x:{ticks:{color:'#94a3b8',font:{size:10},maxTicksLimit:12}}}}
    });
    return ()=>{ if(debtChart.current){debtChart.current.destroy();debtChart.current=null;} };
  }, [activeResult]);

  // ‚îÄ‚îÄ Drag & drop handlers
  const onDragStart = (i) => setDragIdx(i);
  const onDragOver  = (e,i) => { e.preventDefault(); setDragOver(i); };
  const onDrop      = (i) => {
    if (dragIdx===null||dragIdx===i) { setDragIdx(null);setDragOver(null);return; }
    const next=[...debtList]; const [moved]=next.splice(dragIdx,1); next.splice(i,0,moved);
    setDebtList(next); setDragIdx(null); setDragOver(null);
  };

  const cardSt  = {background:'white',borderRadius:'16px',border:'1px solid var(--border)',padding:'1.25rem',boxShadow:'0 1px 3px rgba(0,0,0,0.04)',marginBottom:'1rem'};
  const labelSt = {fontSize:'11px',fontWeight:'700',letterSpacing:'1px',color:'#94a3b8',marginBottom:'6px'};
  const tabBtnSt = (active)=>({padding:'8px 16px',borderRadius:'8px 8px 0 0',border:'none',cursor:'pointer',background:active?'#eff6ff':'transparent',color:active?'#1d4ed8':'#64748b',fontWeight:active?'800':'600',fontSize:'13px',fontFamily:'inherit',borderBottom:`2px solid ${active?'#1d4ed8':'transparent'}`,marginBottom:'-2px'});
  const methodSt = (active)=>({flex:'1',padding:'12px 10px',borderRadius:'12px',border:`2px solid ${active?'#1d4ed8':'#e2e8f0'}`,background:active?'#eff6ff':'#f8fafc',cursor:'pointer',fontFamily:'inherit',textAlign:'center',transition:'all 0.15s'});

  return (
    <div style={{maxWidth:'820px',margin:'0 auto'}}>

      {/* ‚îÄ‚îÄ Stats */}
      <div className="stats-grid" style={{marginBottom:'1rem'}}>
        {[['Deuda total',fmt$(totalBal),'#ef4444','#dc2626'],['M√≠nimos / mes',fmt$(totalMin),'#f59e0b','#d97706'],['Extra ‚Üí deuda',fmt$(extraPayComputed)+'/mes','#1d4ed8','#1e40af'],['Pago total / mes',fmt$(totalMin+extraPayComputed),'#10b981','#059669']].map(([l,v,c1,c2])=>(
          <div key={l} className="stat-card" style={{background:`linear-gradient(135deg,${c1},${c2})`}}>
            <div className="stat-label">{l}</div>
            <div className="stat-value">{v}</div>
          </div>
        ))}
      </div>

      {/* ‚îÄ‚îÄ Debt list */}
      <div style={cardSt}>
        <div style={{...labelSt,marginBottom:'10px'}}>DEUDAS ‚Äî activa/desactiva ¬∑ arrastra ‚†ø para reordenar (modo Custom)</div>
        {debtList.length===0 && <p style={{color:'#94a3b8',fontSize:'13px'}}>Sin deudas en el Money Map.</p>}
        {debtList.map((d,i)=>(
          <div key={d.id}
            draggable onDragStart={()=>onDragStart(i)} onDragOver={e=>onDragOver(e,i)} onDrop={()=>onDrop(i)} onDragEnd={()=>{setDragIdx(null);setDragOver(null);}}
            style={{display:'flex',alignItems:'center',gap:'10px',padding:'10px 12px',borderRadius:'10px',border:`2px solid ${dragOver===i?'#1d4ed8':d.enabled?d.color:'#e2e8f0'}`,background:dragOver===i?'#eff6ff':d.enabled?'#fafafa':'#f8fafc',opacity:d.enabled?1:0.5,marginBottom:'6px',transition:'all 0.15s',cursor:'grab'}}>
            <span style={{color:'#94a3b8',fontSize:'18px',userSelect:'none',flexShrink:'0'}}>‚†ø</span>
            <div style={{width:'10px',height:'10px',borderRadius:'3px',background:d.color,flexShrink:'0'}}/>
            <div style={{flex:'1',minWidth:0}}>
              <div style={{fontWeight:'700',fontSize:'14px',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{d.name}</div>
              <div style={{fontSize:'11px',color:'#94a3b8',marginTop:'1px'}}>APR {d.apr}% ¬∑ M√≠nimo {fmt$(d.minPay)}/mes</div>
            </div>
            <div style={{textAlign:'right',flexShrink:'0'}}>
              <div style={{fontWeight:'800',fontSize:'14px'}}>{fmt$(d.balance)}</div>
            </div>
            <button onClick={()=>setDebtList(prev=>prev.map((x,j)=>j===i?{...x,enabled:!x.enabled}:x))}
              style={{padding:'5px 10px',border:`1px solid ${d.enabled?d.color:'#e2e8f0'}`,borderRadius:'8px',background:d.enabled?'white':'#f1f5f9',color:d.enabled?d.color:'#94a3b8',fontSize:'11px',fontWeight:'700',cursor:'pointer',fontFamily:'inherit',flexShrink:'0'}}>
              {d.enabled?'‚úì ON':'OFF'}
            </button>
          </div>
        ))}
      </div>

      {/* ‚îÄ‚îÄ Extra payment ‚Äî inline editor */}
      <div style={cardSt}>
        <div style={labelSt}>PAGO EXTRA HACIA DEUDA</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
          {/* Left: ahorro % */}
          <div>
            <div style={{fontSize:'12px',fontWeight:'700',color:'#334155',marginBottom:'8px'}}>
              Ahorro mensual registrado: <span style={{color:'#1d4ed8'}}>{fmt$(extraPay)}/mes</span>
            </div>
            <div style={{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'8px'}}>
              {[0,25,50,75,100].map(pct=>(
                <button key={pct} onClick={()=>setAhorroUsado(pct)} style={{
                  padding:'5px 10px',borderRadius:'8px',border:`2px solid ${ahorroUsado===pct?'#1d4ed8':'#e2e8f0'}`,
                  background:ahorroUsado===pct?'#eff6ff':'#f8fafc',color:ahorroUsado===pct?'#1d4ed8':'#64748b',
                  fontWeight:'700',fontSize:'12px',cursor:'pointer',fontFamily:'inherit'
                }}>{pct}%</button>
              ))}
            </div>
            <input type="range" min="0" max="100" value={ahorroUsado} onChange={e=>setAhorroUsado(Number(e.target.value))}
              style={{width:'100%',accentColor:'#1d4ed8',marginBottom:'4px'}}/>
            <div style={{fontSize:'12px',color:'#64748b'}}>{ahorroUsado}% del ahorro = <b style={{color:'#1d4ed8'}}>{fmt$(Math.round(extraPay*ahorroUsado/100))}/mes</b></div>
          </div>
          {/* Right: monto adicional */}
          <div>
            <div style={{fontSize:'12px',fontWeight:'700',color:'#334155',marginBottom:'8px'}}>Monto adicional (otra fuente)</div>
            <div style={{display:'flex',alignItems:'center',background:'#f8fafc',border:'1.5px solid #e2e8f0',borderRadius:'10px',overflow:'hidden',marginBottom:'8px'}}>
              <span style={{padding:'0 10px',color:'#94a3b8',fontWeight:'700',fontSize:'16px'}}>$</span>
              <input type="number" min="0" value={extraAdicional||''} onChange={e=>setExtraAd(parseFloat(e.target.value)||0)}
                placeholder="0" style={{flex:'1',background:'transparent',border:'none',padding:'10px 4px',fontSize:'15px',fontWeight:'800',fontFamily:'inherit',color:'#0f172a'}}/>
              <span style={{padding:'0 10px',color:'#94a3b8',fontSize:'12px',fontWeight:'600'}}>/mes</span>
            </div>
            <div style={{fontSize:'11px',color:'#94a3b8'}}>Ej: bono, freelance, segundo ingreso‚Ä¶</div>
          </div>
        </div>
        {/* Total extra */}
        <div style={{marginTop:'12px',background:'#eff6ff',border:'1px solid #bfdbfe',borderRadius:'10px',padding:'10px 14px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <span style={{fontSize:'13px',fontWeight:'700',color:'#1d4ed8'}}>Total extra hacia deuda / mes</span>
          <span style={{fontSize:'20px',fontWeight:'900',color:'#1d4ed8'}}>{fmt$(extraPayComputed)}</span>
        </div>
      </div>

      {/* ‚îÄ‚îÄ Method selector */}
      <div style={cardSt}>
        <div style={{...labelSt,marginBottom:'12px'}}>ESTRATEGIA</div>
        <div style={{display:'flex',gap:'10px',marginBottom:'10px'}}>
          {[['avalanche','üìà Avalanche','APR m√°s alto primero ¬∑ minimiza inter√©s'],['snowball','‚ö° Snowball','Balance m√°s bajo ¬∑ victorias r√°pidas'],['custom','üéØ Custom','Tu orden personalizado (arrastra arriba)']].map(([id,label,desc])=>(
            <button key={id} style={methodSt(method===id)} onClick={()=>setMethod(id)}>
              <div style={{fontWeight:'800',fontSize:'13px',color:method===id?'#1d4ed8':'#334155'}}>{label}</div>
              <div style={{fontSize:'10px',color:'#94a3b8',marginTop:'3px',lineHeight:'1.3'}}>{desc}</div>
            </button>
          ))}
        </div>
      </div>

      {/* ‚îÄ‚îÄ Results */}
      {activeResult ? (()=>{
        const r=activeResult;
        return (
          <div style={cardSt}>
            {/* Tab bar */}
            <div style={{display:'flex',gap:'4px',marginBottom:'1.25rem',borderBottom:'2px solid #f1f5f9',paddingBottom:'0'}}>
              {[['resumen','üìä Resumen'],['cronograma','üìÖ Cronograma'],['graficos','üìà Gr√°ficos'],['comparacion','‚öñÔ∏è Comparaci√≥n']].map(([id,lbl])=>(
                <button key={id} onClick={()=>setTabView(id)} style={tabBtnSt(activeTab===id)}>{lbl}</button>
              ))}
            </div>

            {/* RESUMEN */}
            {activeTab==='resumen' && (()=>{
              const interestPct = totalBal>0?(r.totalInt/totalBal*100).toFixed(0):0;
              const freeDate = r.months ? new Date(Date.now()+r.months*30.44*24*3600*1000).toLocaleDateString('es',{month:'long',year:'numeric'}) : '‚Äî';
              return (
                <div>
                  <div style={{textAlign:'center',padding:'1rem 0 1.5rem',borderBottom:'1px solid #f1f5f9',marginBottom:'1.25rem'}}>
                    <div style={labelSt}>QUEDAR√ÅS LIBRE DE DEUDA EN</div>
                    <div style={{fontWeight:'900',fontSize:'52px',lineHeight:'1',letterSpacing:'-2px',color:'#1d4ed8'}}>{fmtMos(r.months)}</div>
                    <div style={{fontSize:'13px',color:'#94a3b8',marginTop:'8px'}}>{freeDate} ¬∑ {fmt$(totalMin+extraPayComputed)}/mes</div>
                  </div>

                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'10px',marginBottom:'1.25rem'}}>
                    {[['Inter√©s total',fmt$(r.totalInt),`${interestPct}% del principal`,'#fef2f2','#ef4444'],['Total a pagar',fmt$(r.totalPaid),'Principal + inter√©s','#f0fdf4','#10b981'],['Pago promedio',fmt$(r.totalPaid/(r.months||1))+'/mes','Hasta liquidar','#eff6ff','#1d4ed8']].map(([l,v,s,bg,col])=>(
                      <div key={l} style={{background:bg,borderRadius:'12px',padding:'12px',border:`1px solid ${col}22`}}>
                        <div style={{fontSize:'10px',fontWeight:'700',letterSpacing:'0.5px',color:col,marginBottom:'4px'}}>{l.toUpperCase()}</div>
                        <div style={{fontSize:'18px',fontWeight:'900',color:col}}>{v}</div>
                        <div style={{fontSize:'10px',color:'#64748b',marginTop:'2px'}}>{s}</div>
                      </div>
                    ))}
                  </div>

                  <div style={labelSt}>ORDEN DE LIQUIDACI√ìN</div>
                  <div style={{display:'flex',flexDirection:'column',gap:'7px',marginBottom:'1.25rem'}}>
                    {r.ds.filter(d=>d.paidOff).sort((a,b)=>a.paidOff-b.paidOff).map((d,i)=>(
                      <div key={d.id} style={{display:'flex',alignItems:'center',gap:'10px',padding:'10px 12px',background:'#f8fafc',borderRadius:'10px',border:'1px solid #e2e8f0'}}>
                        <div style={{width:'24px',height:'24px',borderRadius:'50%',background:d.color,color:'white',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'12px',fontWeight:'800',flexShrink:'0'}}>{i+1}</div>
                        <div style={{flex:'1'}}>
                          <div style={{fontWeight:'700',fontSize:'13px'}}>{d.name}</div>
                          <div style={{fontSize:'11px',color:'#94a3b8'}}>{fmt$(d.initBal)} ¬∑ APR {d.apr}%</div>
                        </div>
                        <div style={{textAlign:'right'}}>
                          <div style={{fontWeight:'800',color:'#059669',fontSize:'13px'}}>‚úì Mes {d.paidOff}</div>
                          <div style={{fontSize:'11px',color:'#94a3b8'}}>{fmtMos(d.paidOff)}</div>
                        </div>
                      </div>
                    ))}
                    {r.ds.filter(d=>!d.paidOff).map(d=>(
                      <div key={d.id} style={{display:'flex',alignItems:'center',gap:'10px',padding:'10px 12px',background:'#fef2f2',borderRadius:'10px',border:'1px solid #fecaca'}}>
                        <div style={{width:'24px',height:'24px',borderRadius:'50%',background:'#ef4444',color:'white',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'12px',fontWeight:'800',flexShrink:'0'}}>!</div>
                        <div style={{fontWeight:'700',fontSize:'13px',color:'#dc2626'}}>{d.name} ‚Äî No se paga en 50 a√±os con el pago actual</div>
                      </div>
                    ))}
                  </div>

                  {/* Timeline */}
                  <div style={labelSt}>L√çNEA DE TIEMPO</div>
                  <div style={{background:'#f8fafc',borderRadius:'12px',padding:'14px',border:'1px solid #e2e8f0'}}>
                    <div style={{display:'flex',height:'28px',borderRadius:'8px',overflow:'hidden',gap:'2px',marginBottom:'8px'}}>
                      {r.ds.filter(d=>d.paidOff).sort((a,b)=>a.paidOff-b.paidOff).map(d=>{
                        const pct=((d.paidOff/(r.months||1))*100).toFixed(1);
                        return <div key={d.id} title={`${d.name}: mes ${d.paidOff}`}
                          style={{background:d.color,width:`${pct}%`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'10px',color:'white',fontWeight:'800',borderRadius:'5px',overflow:'hidden',flexShrink:'0'}}>
                          {pct>9?d.name.split(' ')[0]:''}
                        </div>;
                      })}
                    </div>
                    <div style={{display:'flex',justifyContent:'space-between',fontSize:'11px',color:'#94a3b8',fontWeight:'600'}}>
                      <span>Hoy</span><span>Mes {Math.round((r.months||0)/2)}</span><span>{fmtMos(r.months)}</span>
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* CRONOGRAMA */}
            {activeTab==='cronograma' && (
              <div style={{overflowX:'auto'}}>
                <table style={{width:'100%',borderCollapse:'collapse',fontSize:'12px'}}>
                  <thead>
                    <tr style={{background:'#f8fafc'}}>
                      {['Mes','Inter√©s','Pago','Balance restante','Progreso'].map(h=>(
                        <th key={h} style={{padding:'8px 10px',textAlign:'left',fontWeight:'700',color:'#475569',borderBottom:'2px solid #e2e8f0',fontSize:'11px',letterSpacing:'0.5px',whiteSpace:'nowrap'}}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {r.schedule.slice(0,120).map((row,i)=>{
                      const pct=(1-row.rem/totalBal)*100;
                      return (
                        <tr key={row.month} style={{background:i%2===0?'white':'#fafafa'}}>
                          <td style={{padding:'7px 10px',fontWeight:'700'}}>{row.month}</td>
                          <td style={{padding:'7px 10px',color:'#ef4444'}}>{fmtFull(row.mInt)}</td>
                          <td style={{padding:'7px 10px',fontWeight:'700'}}>{fmt$(totalMin+extraPayComputed)}</td>
                          <td style={{padding:'7px 10px',fontWeight:'700'}}>{fmt$(row.rem)}</td>
                          <td style={{padding:'7px 10px',minWidth:'100px'}}>
                            <div style={{height:'6px',background:'#f1f5f9',borderRadius:'3px',overflow:'hidden'}}>
                              <div style={{height:'100%',width:`${Math.max(0,pct).toFixed(1)}%`,background:'#1d4ed8',borderRadius:'3px'}}/>
                            </div>
                            <div style={{fontSize:'10px',color:'#94a3b8',marginTop:'2px'}}>{pct.toFixed(0)}% pagado</div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                {r.schedule.length>120 && <div style={{fontSize:'11px',color:'#94a3b8',marginTop:'8px',textAlign:'center'}}>Mostrando primeros 120 de {r.schedule.length} meses</div>}
              </div>
            )}

            {/* GRAFICOS */}
            {activeTab==='graficos' && (
              <div>
                <div style={{...labelSt,marginBottom:'10px'}}>BALANCE TOTAL</div>
                <div style={{position:'relative',height:'240px',marginBottom:'1.5rem'}}>
                  <canvas ref={balChartRef}/>
                </div>
                <div style={{...labelSt,marginBottom:'10px'}}>DEUDAS INDIVIDUALES</div>
                <div style={{position:'relative',height:'240px'}}>
                  <canvas ref={debtChartRef}/>
                </div>
              </div>
            )}

            {/* COMPARACI√ìN */}
            {activeTab==='comparacion' && avResult && sbResult && cusResult && (()=>{
              const methods = [
                {id:'avalanche',label:'üìà Avalanche',desc:'APR m√°s alto primero',r:avResult,color:'#1d4ed8',bg:'#eff6ff',brd:'#bfdbfe'},
                {id:'snowball', label:'‚ö° Snowball', desc:'Balance m√°s bajo',    r:sbResult,color:'#7c3aed',bg:'#f5f3ff',brd:'#ddd6fe'},
                {id:'custom',   label:'üéØ Custom',   desc:'Tu orden arrastrando',r:cusResult,color:'#0d9488',bg:'#f0fdfa',brd:'#99f6e4'},
              ];
              const bestInt  = methods.reduce((a,b)=>a.r.totalInt<b.r.totalInt?a:b);
              const bestTime = methods.reduce((a,b)=>(a.r.months||9999)<(b.r.months||9999)?a:b);
              return (
                <div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'10px',marginBottom:'1rem'}}>
                    {methods.map(m=>{
                      const isBestInt  = m.id===bestInt.id;
                      const isBestTime = m.id===bestTime.id;
                      const first = m.r.ds.filter(d=>d.paidOff).sort((a,b)=>a.paidOff-b.paidOff)[0];
                      return (
                        <div key={m.id} style={{padding:'14px',borderRadius:'12px',border:`2px solid ${isBestInt?m.color:m.brd}`,background:isBestInt?m.bg:'#f8fafc',position:'relative'}}>
                          {isBestInt && <div style={{position:'absolute',top:'-10px',right:'8px',background:m.color,color:'white',padding:'3px 8px',borderRadius:'10px',fontSize:'10px',fontWeight:'700'}}>üí∞ Menos inter√©s</div>}
                          {!isBestInt&&isBestTime && <div style={{position:'absolute',top:'-10px',right:'8px',background:m.color,color:'white',padding:'3px 8px',borderRadius:'10px',fontSize:'10px',fontWeight:'700'}}>‚ö° M√°s r√°pido</div>}
                          <div style={{fontWeight:'800',fontSize:'14px',marginBottom:'2px'}}>{m.label}</div>
                          <div style={{fontSize:'10px',color:'#64748b',marginBottom:'10px'}}>{m.desc}</div>
                          {[['Tiempo',fmtMos(m.r.months)],['Inter√©s',fmt$(m.r.totalInt)],['Total',fmt$(m.r.totalPaid)]].map(([l,v])=>(
                            <div key={l} style={{display:'flex',justifyContent:'space-between',marginBottom:'5px',fontSize:'12px'}}>
                              <span style={{color:'#64748b'}}>{l}</span>
                              <span style={{fontWeight:'800'}}>{v}</span>
                            </div>
                          ))}
                          {first && (
                            <div style={{marginTop:'8px',padding:'7px',background:'white',borderRadius:'8px',fontSize:'11px',border:'1px solid #e2e8f0'}}>
                              <div style={{fontWeight:'700',color:'#059669',marginBottom:'2px'}}>üéâ 1ra victoria</div>
                              <div><b>{first.name}</b> ¬∑ mes {first.paidOff}</div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  <div style={{background:'#f0fdf4',border:'1px solid #bbf7d0',borderRadius:'12px',padding:'12px 14px',fontSize:'12px',color:'#334155',lineHeight:'1.7'}}>
                    <div style={{fontWeight:'700',color:'#059669',marginBottom:'6px'}}>üìä An√°lisis</div>
                    Avalanche ahorra <b>{fmt$(Math.max(sbResult.totalInt,cusResult.totalInt)-avResult.totalInt)}</b> en inter√©s vs la peor alternativa.
                    {' '}Snowball paga la primera deuda en el mes {sbResult.ds.filter(d=>d.paidOff).sort((a,b)=>a.paidOff-b.paidOff)[0]?.paidOff||'‚Äî'}.
                    {' '}Con tu orden custom, la primera sale en el mes {cusResult.ds.filter(d=>d.paidOff).sort((a,b)=>a.paidOff-b.paidOff)[0]?.paidOff||'‚Äî'}.
                  </div>
                </div>
              );
            })()}
          </div>
        );
      })() : (
        <div style={{textAlign:'center',padding:'2rem',color:'#94a3b8',fontSize:'14px',fontWeight:'600'}}>Activa al menos una deuda para ver el plan ‚Üí</div>
      )}

      <div style={{fontSize:'11px',color:'#cbd5e1',textAlign:'center',lineHeight:'1.8',fontWeight:'500',paddingBottom:'1rem'}}>
        Asume pagos y tasas constantes. No considera cambios de APR ni refinanciamiento.
      </div>


    </div>
  );
}

// ============= RUNWAY CALCULATOR =============
function RunwayCalculator({ activos, gastos, ingresos, deudas, currency }) {
  const { useState, useEffect, useMemo } = React;

  const ASSET_CATS = [
    { id:'cash',          label:'Cash y equivalentes', icon:'üíµ', color:'#16a34a', bg:'#f0fdf4', border:'#bbf7d0', liquidity:1, liqLabel:'Inmediato'   },
    { id:'inversiones',   label:'Inversiones',          icon:'üìà', color:'#2563eb', bg:'#eff6ff', border:'#bfdbfe', liquidity:3, liqLabel:'1‚Äì4 semanas' },
    { id:'retiro',        label:'Cuentas de retiro',    icon:'üèõÔ∏è', color:'#7c3aed', bg:'#f5f3ff', border:'#ddd6fe', liquidity:4, liqLabel:'1‚Äì3 meses'  },
    { id:'bienes_raices', label:'Bienes ra√≠ces',        icon:'üèòÔ∏è', color:'#ea580c', bg:'#fff7ed', border:'#fed7aa', liquidity:6, liqLabel:'6+ meses'   },
    { id:'negocio',       label:'Negocio / Otros',      icon:'üè¢', color:'#0d9488', bg:'#f0fdfa', border:'#99f6e4', liquidity:5, liqLabel:'3‚Äì6 meses'  },
    { id:'personales',    label:'Activos personales',   icon:'üöó', color:'#db2777', bg:'#fdf2f8', border:'#fbcfe8', liquidity:5, liqLabel:'3‚Äì6 meses'  },
  ];

  const EXPENSE_CATS = [
    { id:'impuestos',      label:'Impuestos',      icon:'üèõÔ∏è' },
    { id:'gastos_diarios', label:'Gastos diarios', icon:'üõí' },
    { id:'seguros',        label:'Seguros',        icon:'üõ°Ô∏è' },
    { id:'deuda',          label:'Deuda (sin auto)',icon:'üí≥' },
    { id:'casa',           label:'Casa / HOA',     icon:'üè†' },
  ];

  const mmToCat = { efectivo:'cash', inversiones:'inversiones', retiro:'retiro', bienesRaices:'bienes_raices', bienesPersonales:'personales' };

  // Map asset category ‚Üí related debt keys for netting
  const debtForCat = {
    bienesRaices: ['casa', 'lineaPropiedad'],   // home value - mortgage - HELOC
    efectivo:     ['tarjetas', 'lineaPersonal'], // liquid assets - revolving debt
    // autos excluded ‚Äî assumed sold to pay off auto loan, net = 0
  };

  const mmAssets = useMemo(() => {
    // Pre-compute debt totals per key
    const debtTotals = {};
    if (deudas) {
      Object.entries(deudas).forEach(([key, items]) => {
        debtTotals[key] = (items || []).reduce((s,i) => s + parseNumber(i.balance), 0);
      });
    }

    // For each asset category, figure out how much debt to net out
    // Distribute debt proportionally across assets in that category
    const debtUsed = {};  // track debt already allocated

    const list = [];
    Object.entries(activos).forEach(([key, items]) => {
      if (key === 'bienesPersonales') return; // autos excluded ‚Äî sell to pay debt, net = 0
      const catId   = mmToCat[key] || 'negocio';
      const relKeys = debtForCat[key] || [];

      // Total gross value for this category
      const catGross = items.reduce((s,i) => s + parseNumber(i.valor), 0);

      // Total applicable debt for this category (not yet used)
      let catDebt = relKeys.reduce((s, dk) => {
        const used = debtUsed[dk] || 0;
        return s + Math.max(0, (debtTotals[dk] || 0) - used);
      }, 0);

      items.forEach(item => {
        const gross = parseNumber(item.valor);
        if (gross <= 0) return;

        // Prorate debt to this item
        const itemDebt = catGross > 0 ? catDebt * (gross / catGross) : 0;
        const net      = Math.max(0, gross - itemDebt);

        const label = item.ubicacion || item.tipo || catId;
        const entry = { id:`${key}-${item.tipo}-${item.ubicacion}`, categoryId:catId, label, amount:net, gross, debt:itemDebt };
        if (net > 0) list.push(entry);
      });

      // Mark this debt as used
      relKeys.forEach(dk => { debtUsed[dk] = (debtTotals[dk] || 0); });
    });
    return list;
  }, [activos, deudas]);

  const mmExpenses = useMemo(() => {
    // Auto loan payments excluded ‚Äî auto assumed sold to cancel debt
    const deudaItems = (gastos.deuda || []);
    const autoPayment = deudaItems
      .filter(i => /auto|carro|veh/i.test(i.tipo || i.subcategoria || ''))
      .reduce((s,i) => s + parseNumber(i.monto), 0);
    return {
      impuestos:      (gastos.impuestos ||[]).reduce((s,i)=>s+parseNumber(i.monto),0),
      gastos_diarios: (gastos.diarios   ||[]).reduce((s,i)=>s+parseNumber(i.monto),0),
      seguros:        (gastos.seguros   ||[]).reduce((s,i)=>s+parseNumber(i.monto),0),
      deuda:          Math.max(0, deudaItems.reduce((s,i)=>s+parseNumber(i.monto),0) - autoPayment),
      casa:           0,
      // Ahorro excluido ‚Äî en emergencia el ahorro se detiene
    };
  }, [gastos]);

  const [assetList, setAssets]   = useState(mmAssets);
  const [expVals,   setExpVals]  = useState(mmExpenses);
  const [result,    setResult]   = useState(null);
  const [editExp,   setEditExp]  = useState(false);
  const [expDraft,  setExpDraft] = useState(mmExpenses);
  const [showAddAsset, setShowAddAsset] = useState(false);
  const [assetDraft,   setADraft]       = useState({ categoryId:'cash', label:'', amount:'' });

  useEffect(() => { setAssets(mmAssets); }, [JSON.stringify(mmAssets)]);
  useEffect(() => { setExpVals(mmExpenses); setExpDraft(mmExpenses); }, [JSON.stringify(mmExpenses)]);

  // Auto-calculate always
  useEffect(() => {
    const gap  = Object.values(expVals).reduce((s,v)=>s+(parseFloat(v)||0),0);
    const tAss = assetList.reduce((s,a)=>s+a.amount,0);
    if (gap > 0 && tAss > 0) {
      const sorted = [...assetList].sort((a,b)=>{
        const ca=ASSET_CATS.find(c=>c.id===a.categoryId);
        const cb=ASSET_CATS.find(c=>c.id===b.categoryId);
        return (ca?.liquidity||3)-(cb?.liquidity||3);
      });
      setResult({ totalMonths:tAss/gap, gap, tAss, sorted });
    } else { setResult(null); }
  }, [assetList, expVals]);

  const fmt = n => '$'+new Intl.NumberFormat('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}).format(n||0);
  const fmtMonths = m => {
    if(!isFinite(m)||m<=0) return '‚Äî';
    if(m>=12){ const y=Math.floor(m/12),mo=Math.round(m%12); return mo>0?`${y}a ${mo}m`:`${y} a√±o${y>1?'s':''}`; }
    return `${m.toFixed(1)} meses`;
  };
  const rColor  = m => m>=24?'#16a34a':m>=12?'#0d9488':m>=6?'#d97706':m>=3?'#ea580c':'#dc2626';
  const rBg     = m => m>=24?'#f0fdf4':m>=12?'#f0fdfa':m>=6?'#fffbeb':m>=3?'#fff7ed':'#fef2f2';
  const rBorder = m => m>=24?'#bbf7d0':m>=12?'#99f6e4':m>=6?'#fde68a':m>=3?'#fed7aa':'#fecaca';
  const rLabel  = m => {
    const fmtM = n => {
      if (!isFinite(n)||n<=0) return '‚Äî';
      if (n>=12){ const y=Math.floor(n/12),mo=Math.round(n%12); return mo>0?`${y} a√±o${y>1?'s':''} y ${mo} mes${mo>1?'es':''}`:`${y} a√±o${y>1?'s':''}`; }
      return `${n.toFixed(1)} meses`;
    };
    return `Sin ingresos, tus activos netos cubren ${fmtM(m)} de gastos esenciales.`;
  };

  const totalExp = Object.values(expVals).reduce((s,v)=>s+(parseFloat(v)||0),0);
  const totalAss = assetList.reduce((s,a)=>s+a.amount,0);

  const cardSt = { background:'white', borderRadius:'16px', border:'1px solid var(--border)', padding:'1.25rem', boxShadow:'0 1px 3px rgba(0,0,0,0.04)', marginBottom:'1rem' };
  const labelSt = { fontSize:'11px', fontWeight:'700', letterSpacing:'1px', color:'#94a3b8', marginBottom:'6px' };
  const editBtnSt = { padding:'6px 14px', background:'#eff6ff', border:'1px solid #bfdbfe', borderRadius:'8px', color:'#1d4ed8', fontSize:'12px', fontWeight:'700', cursor:'pointer', fontFamily:'inherit' };
  const overlayS = { position:'fixed', inset:0, background:'rgba(15,23,42,0.55)', zIndex:200, display:'flex', alignItems:'center', justifyContent:'center', padding:'16px' };
  const modalS   = { background:'white', borderRadius:'20px', width:'100%', maxWidth:'480px', maxHeight:'90vh', overflowY:'auto', boxShadow:'0 24px 64px rgba(0,0,0,0.2)', padding:'24px' };

  return (
    <div style={{maxWidth:'680px',margin:'0 auto'}}>

      {/* ‚îÄ‚îÄ Gastos card */}
      <div style={cardSt}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
          <div>
            <div style={labelSt}>GASTOS MENSUALES</div>
            <div style={{fontWeight:'900',fontSize:'1.75rem',color:'#0f172a'}}>{fmt(totalExp)}<span style={{fontSize:'1rem',fontWeight:'600',color:'#94a3b8'}}>/mes</span></div>
          </div>
          <button style={editBtnSt} onClick={()=>{setExpDraft({...expVals});setEditExp(true);}}>‚úé Editar</button>
        </div>
        <div style={{display:'flex',flexWrap:'wrap',gap:'7px'}}>
          {EXPENSE_CATS.filter(c=>parseFloat(expVals[c.id])>0).map(c=>(
            <div key={c.id} style={{display:'flex',alignItems:'center',gap:'5px',background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:'8px',padding:'5px 11px',fontSize:'12px',fontWeight:'600',color:'#475569'}}>
              {c.icon} {c.label} <span style={{color:'#0f172a',fontWeight:'800'}}>{fmt(expVals[c.id])}</span>
            </div>
          ))}
          {totalExp === 0 && <span style={{fontSize:'13px',color:'#cbd5e1',fontWeight:'600'}}>Sin gastos registrados</span>}
        </div>
      </div>

      {/* ‚îÄ‚îÄ Activos card */}
      <div style={cardSt}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
          <div>
            <div style={labelSt}>ACTIVOS DISPONIBLES</div>
            <div style={{fontWeight:'900',fontSize:'1.75rem',color:'#0f172a'}}>{fmt(totalAss)}</div>
          </div>
          <button style={editBtnSt} onClick={()=>setShowAddAsset(true)}>+ A√±adir</button>
        </div>
        {assetList.length === 0 && <div style={{fontSize:'13px',color:'#cbd5e1',fontWeight:'600'}}>Sin activos registrados</div>}
        {ASSET_CATS.map(cat => {
          const group = assetList.filter(a=>a.categoryId===cat.id);
          if(!group.length) return null;
          return (
            <div key={cat.id} style={{marginBottom:'10px'}}>
              <div style={{display:'flex',alignItems:'center',gap:'7px',marginBottom:'6px'}}>
                <div style={{width:'24px',height:'24px',borderRadius:'7px',background:cat.bg,border:`1px solid ${cat.border}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'13px'}}>{cat.icon}</div>
                <span style={{fontSize:'11px',fontWeight:'800',color:cat.color}}>{cat.label}</span>
                <span style={{fontSize:'10px',color:'#94a3b8'}}>¬∑ {cat.liqLabel}</span>
              </div>
              {group.map(a=>(
                <div key={a.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'7px 10px',borderRadius:'9px',background:'#fafafa',marginBottom:'3px'}}>
                  <div>
                    <div style={{fontSize:'13px',fontWeight:'600',color:'#334155'}}>{a.label}</div>
                    {a.debt > 0 && <div style={{fontSize:'11px',color:'#94a3b8',marginTop:'1px'}}>Bruto {fmt(a.gross)} ‚àí Deuda {fmt(a.debt)}</div>}
                  </div>
                  <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                    <div style={{textAlign:'right'}}>
                      <div style={{fontSize:'14px',fontWeight:'800',color: a.debt>0?'#059669':'#0f172a'}}>{fmt(a.amount)}</div>
                      {a.debt > 0 && <div style={{fontSize:'10px',fontWeight:'700',color:'#059669'}}>neto</div>}
                    </div>
                    <button onClick={()=>setAssets(p=>p.filter(x=>x.id!==a.id))} style={{background:'none',border:'none',color:'#d1d5db',fontSize:'14px',cursor:'pointer',padding:'2px 5px',borderRadius:'5px'}}>‚úï</button>
                  </div>
                </div>
              ))}
            </div>
          );
        })}
      </div>

      {/* ‚îÄ‚îÄ Result */}
      {!result && totalExp > 0 && totalAss === 0 && (
        <div style={{textAlign:'center',padding:'2rem',color:'#94a3b8',fontSize:'14px',fontWeight:'600'}}>Agrega activos para ver el runway ‚Üí</div>
      )}
      {!result && totalExp === 0 && (
        <div style={{textAlign:'center',padding:'2rem',color:'#94a3b8',fontSize:'14px',fontWeight:'600'}}>Edita los gastos mensuales para ver el runway ‚Üí</div>
      )}

      {result && (() => {
        const { totalMonths, gap, tAss, sorted } = result;
        const col = rColor(totalMonths);
        const bg  = rBg(totalMonths);
        const brd = rBorder(totalMonths);
        return (
          <div style={{background:'white',borderRadius:'16px',border:`2px solid ${brd}`,padding:'1.5rem',boxShadow:'0 1px 3px rgba(0,0,0,0.04)',marginBottom:'1rem'}}>

            {/* Big number */}
            <div style={{textAlign:'center',padding:'8px 0 20px'}}>
              <div style={{fontSize:'11px',color:'#94a3b8',fontWeight:'700',marginBottom:'8px',letterSpacing:'1px'}}>RUNWAY TOTAL</div>
              <div style={{fontWeight:'900',fontSize:'60px',lineHeight:'1',letterSpacing:'-3px',color:col}}>{fmtMonths(totalMonths)}</div>
              <div style={{fontSize:'13px',color:'#94a3b8',marginTop:'10px',fontWeight:'500'}}>{fmt(tAss)} en activos √∑ {fmt(gap)}/mes</div>
            </div>

            {/* Status */}
            <div style={{borderRadius:'10px',padding:'12px 16px',textAlign:'center',marginBottom:'1.5rem',background:'#f8fafc',border:'1px solid #e2e8f0'}}>
              <span style={{fontSize:'13px',fontWeight:'600',color:'#475569'}}>{rLabel(totalMonths)}</span>
            </div>

            {/* Liquidation order */}
            <div style={{fontSize:'11px',fontWeight:'700',letterSpacing:'1px',color:'#94a3b8',marginBottom:'12px'}}>ORDEN DE LIQUIDACI√ìN</div>
            {sorted.map(a=>{
              const cat = ASSET_CATS.find(c=>c.id===a.categoryId);
              const pct = (a.amount/tAss*100).toFixed(2);
              const mos = (a.amount/gap).toFixed(1);
              return (
                <div key={a.id} style={{marginBottom:'12px'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'5px'}}>
                    <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                      <span style={{fontSize:'16px'}}>{cat?.icon}</span>
                      <div>
                        <div style={{fontSize:'13px',fontWeight:'700',color:'#334155'}}>{a.label}</div>
                        <div style={{fontSize:'10px',fontWeight:'700',color:cat?.color}}>{cat?.liqLabel}</div>
                      </div>
                    </div>
                    <div style={{textAlign:'right'}}>
                      <div style={{fontSize:'13px',fontWeight:'800',color: a.debt>0?'#059669':'#0f172a'}}>{fmt(a.amount)}{a.debt>0 && <span style={{fontSize:'10px',fontWeight:'600',color:'#059669',marginLeft:'4px'}}>neto</span>}</div>
                      <div style={{fontSize:'11px',fontWeight:'700',color:cat?.color}}>{mos} meses</div>
                    </div>
                  </div>
                  <div style={{height:'8px',background:'#f1f5f9',borderRadius:'4px',overflow:'hidden'}}>
                    <div style={{height:'100%',width:`${pct}%`,background:cat?.color,borderRadius:'4px',opacity:0.8}}/>
                  </div>
                </div>
              );
            })}

            {/* Cumulative Timeline */}
            {(() => {
              // Build cumulative segments with month markers
              let cumMonths = 0;
              const segs = sorted.map(a => {
                const cat   = ASSET_CATS.find(c=>c.id===a.categoryId);
                const mos   = a.amount / gap;
                const start = cumMonths;
                cumMonths  += mos;
                const pct   = (mos / totalMonths * 100).toFixed(2);
                return { ...a, cat, mos, start, end: cumMonths, pct };
              });
              // Tick marks: every 6 months up to totalMonths
              const tickInterval = totalMonths <= 12 ? 3 : totalMonths <= 36 ? 6 : 12;
              const ticks = [];
              for (let t = 0; t <= Math.ceil(totalMonths); t += tickInterval) {
                if (t > totalMonths) break;
                ticks.push(t);
              }
              if (ticks[ticks.length-1] < totalMonths) ticks.push(Math.round(totalMonths));
              return (
                <div style={{marginTop:'16px',background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:'12px',padding:'14px'}}>
                  <div style={{fontSize:'11px',fontWeight:'700',color:'#94a3b8',letterSpacing:'1px',marginBottom:'9px'}}>L√çNEA DE TIEMPO ACUMULATIVA</div>
                  {/* Strip */}
                  <div style={{display:'flex',height:'30px',borderRadius:'8px',overflow:'hidden',gap:'2px'}}>
                    {segs.map(s=>(
                      <div key={s.id} title={`${s.label}: mes ${s.start.toFixed(1)} ‚Üí ${s.end.toFixed(1)}`}
                        style={{width:`${s.pct}%`,background:s.cat?.color,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'12px',borderRadius:'5px',flexShrink:'0',overflow:'hidden',position:'relative'}}>
                        {s.pct>7 ? s.cat?.icon : ''}
                      </div>
                    ))}
                  </div>
                  {/* Cumulative month ticks */}
                  <div style={{position:'relative',marginTop:'6px',height:'18px'}}>
                    {ticks.map(t=>{
                      const leftPct = (t / totalMonths * 100);
                      return (
                        <div key={t} style={{position:'absolute',left:`${leftPct}%`,transform:'translateX(-50%)',fontSize:'11px',color:'#94a3b8',fontWeight:'600',whiteSpace:'nowrap'}}>
                          {t===0 ? 'Hoy' : `Mes ${t}`}
                        </div>
                      );
                    })}
                  </div>
                  {/* Legend */}
                  <div style={{display:'flex',flexWrap:'wrap',gap:'8px',marginTop:'14px'}}>
                    {segs.map(s=>(
                      <div key={s.id} style={{display:'flex',alignItems:'center',gap:'5px',fontSize:'11px',fontWeight:'600',color:'#475569'}}>
                        <div style={{width:'10px',height:'10px',borderRadius:'3px',background:s.cat?.color,flexShrink:'0'}}/>
                        <span>{s.label}</span>
                        <span style={{color:s.cat?.color,fontWeight:'800'}}>‚Üí mes {Math.round(s.end)}</span>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })()}
          </div>
        );
      })()}

      <div style={{fontSize:'11px',color:'#cbd5e1',textAlign:'center',lineHeight:'1.8',fontWeight:'500',paddingBottom:'1rem'}}>
        Asume gastos constantes. No considera rendimientos, inflaci√≥n ni costos de liquidaci√≥n.
      </div>

      {/* ‚îÄ‚îÄ Edit Expenses Modal */}
      {editExp && (
        <div style={overlayS} onClick={e=>{if(e.target===e.currentTarget)setEditExp(false);}}>
          <div style={modalS}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.25rem'}}>
              <div><div style={{fontWeight:'900',fontSize:'1.2rem'}}>Gastos Mensuales</div><div style={{fontSize:'12px',color:'#94a3b8'}}>Pre-cargados desde tu Money Map</div></div>
              <button onClick={()=>setEditExp(false)} style={{background:'#f1f5f9',border:'none',borderRadius:'8px',width:'32px',height:'32px',cursor:'pointer',fontSize:'16px',color:'#64748b'}}>‚úï</button>
            </div>
            {EXPENSE_CATS.map(cat=>(
              <div key={cat.id} style={{marginBottom:'12px'}}>
                <div style={{fontSize:'13px',fontWeight:'700',marginBottom:'5px'}}>{cat.icon} {cat.label}</div>
                <div style={{display:'flex',alignItems:'center',background:'#f8fafc',border:'1.5px solid #e2e8f0',borderRadius:'10px',overflow:'hidden'}}>
                  <span style={{padding:'0 12px',color:'#94a3b8',fontWeight:'700'}}>$</span>
                  <input type="number" placeholder="0" value={expDraft[cat.id]||''}
                    onChange={e=>setExpDraft(d=>({...d,[cat.id]:e.target.value}))}
                    style={{flex:'1',background:'transparent',border:'none',padding:'11px 4px',fontSize:'15px',fontWeight:'800',fontFamily:'inherit',color:'#0f172a'}}/>
                  <span style={{padding:'0 12px',color:'#94a3b8',fontSize:'12px',fontWeight:'600'}}>/mes</span>
                </div>
              </div>
            ))}
            <div style={{background:'#eff6ff',border:'1px solid #bfdbfe',borderRadius:'12px',padding:'12px 16px',display:'flex',justifyContent:'space-between',margin:'16px 0'}}>
              <span style={{fontWeight:'700',color:'#1d4ed8',fontSize:'13px'}}>Total mensual</span>
              <span style={{fontWeight:'900',fontSize:'1.25rem',color:'#1d4ed8'}}>{fmt(Object.values(expDraft).reduce((s,v)=>s+(parseFloat(v)||0),0))}</span>
            </div>
            <div style={{display:'flex',gap:'10px'}}>
              <button onClick={()=>{setExpVals({...expDraft});setEditExp(false);}} style={{flex:1,padding:'13px',background:'#1d4ed8',border:'none',borderRadius:'12px',color:'white',fontSize:'15px',fontWeight:'800',cursor:'pointer',fontFamily:'inherit'}}>Guardar</button>
              <button onClick={()=>setEditExp(false)} style={{padding:'13px 18px',background:'#f1f5f9',border:'none',borderRadius:'12px',color:'#64748b',fontSize:'15px',fontWeight:'700',cursor:'pointer',fontFamily:'inherit'}}>Cancelar</button>
            </div>
          </div>
        </div>
      )}

      {/* ‚îÄ‚îÄ Add Asset Modal */}
      {showAddAsset && (
        <div style={overlayS} onClick={e=>{if(e.target===e.currentTarget)setShowAddAsset(false);}}>
          <div style={modalS}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.25rem'}}>
              <div style={{fontWeight:'900',fontSize:'1.2rem'}}>Agregar Activo</div>
              <button onClick={()=>setShowAddAsset(false)} style={{background:'#f1f5f9',border:'none',borderRadius:'8px',width:'32px',height:'32px',cursor:'pointer',fontSize:'16px',color:'#64748b'}}>‚úï</button>
            </div>
            <div style={{fontSize:'11px',fontWeight:'700',letterSpacing:'1px',color:'#94a3b8',marginBottom:'8px'}}>CATEGOR√çA</div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'8px',marginBottom:'16px'}}>
              {ASSET_CATS.map(cat=>{
                const sel=assetDraft.categoryId===cat.id;
                return <button key={cat.id} onClick={()=>setADraft(d=>({...d,categoryId:cat.id}))}
                  style={{background:sel?cat.bg:'#f8fafc',border:`2px solid ${sel?cat.color:'#e2e8f0'}`,borderRadius:'12px',padding:'10px 12px',textAlign:'left',cursor:'pointer',fontFamily:'inherit'}}>
                  <div style={{fontSize:'18px',marginBottom:'3px'}}>{cat.icon}</div>
                  <div style={{fontSize:'12px',fontWeight:'800',color:sel?cat.color:'#334155'}}>{cat.label}</div>
                  <div style={{fontSize:'10px',color:'#94a3b8',marginTop:'2px'}}>{cat.liqLabel}</div>
                </button>;
              })}
            </div>
            <div style={{fontSize:'11px',fontWeight:'700',letterSpacing:'1px',color:'#94a3b8',marginBottom:'6px'}}>NOMBRE</div>
            <input value={assetDraft.label} onChange={e=>setADraft(d=>({...d,label:e.target.value}))}
              placeholder="Ej: Checking BofA" style={{width:'100%',background:'#f8fafc',border:'1.5px solid #e2e8f0',borderRadius:'10px',padding:'10px 14px',fontSize:'14px',fontWeight:'700',fontFamily:'inherit',marginBottom:'14px'}}/>
            <div style={{fontSize:'11px',fontWeight:'700',letterSpacing:'1px',color:'#94a3b8',marginBottom:'6px'}}>VALOR</div>
            <div style={{display:'flex',alignItems:'center',background:'#f8fafc',border:'1.5px solid #e2e8f0',borderRadius:'10px',overflow:'hidden',marginBottom:'20px'}}>
              <span style={{padding:'0 12px',color:'#94a3b8',fontSize:'18px',fontWeight:'700'}}>$</span>
              <input type="number" value={assetDraft.amount} onChange={e=>setADraft(d=>({...d,amount:e.target.value}))}
                placeholder="0" style={{flex:'1',background:'transparent',border:'none',padding:'12px 4px',fontSize:'22px',fontWeight:'900',fontFamily:'inherit',color:'#0f172a'}}
                onKeyDown={e=>{if(e.key==='Enter'){const amt=parseFloat(assetDraft.amount);if(!amt||amt<=0)return;const cat=ASSET_CATS.find(c=>c.id===assetDraft.categoryId);setAssets(p=>[...p,{id:Date.now(),categoryId:assetDraft.categoryId,label:assetDraft.label||cat.label,amount:amt}]);setADraft({categoryId:'cash',label:'',amount:''});setShowAddAsset(false);}}}/>
            </div>
            <div style={{display:'flex',gap:'10px'}}>
              <button onClick={()=>{const amt=parseFloat(assetDraft.amount);if(!amt||amt<=0)return;const cat=ASSET_CATS.find(c=>c.id===assetDraft.categoryId);setAssets(p=>[...p,{id:Date.now(),categoryId:assetDraft.categoryId,label:assetDraft.label||cat.label,amount:amt}]);setADraft({categoryId:'cash',label:'',amount:''});setShowAddAsset(false);}}
                style={{flex:1,padding:'13px',background:'#1d4ed8',border:'none',borderRadius:'12px',color:'white',fontSize:'15px',fontWeight:'800',cursor:'pointer',fontFamily:'inherit'}}>Agregar</button>
              <button onClick={()=>setShowAddAsset(false)} style={{padding:'13px 18px',background:'#f1f5f9',border:'none',borderRadius:'12px',color:'#64748b',fontSize:'15px',fontWeight:'700',cursor:'pointer',fontFamily:'inherit'}}>Cancelar</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============= RATIOS FINANCIEROS =============
function RatiosFinancieros({ ratiosData, setRatiosData, totales, currency, ingresos, gastos, setActiveTab }) {
  const [showResultsModal, setShowResultsModal] = useState(false);
  const [showBenchmarkModal, setShowBenchmarkModal] = useState(false);
  const [showReservaModal, setShowReservaModal] = useState(false);
  const updateField = (field, val) => setRatiosData(prev => ({ ...prev, [field]: val }));

  // ratiosData is kept in sync by App-level useEffect

  const calcRatios = () => {
    const e=parseNumber(ratiosData.edad), ib=parseNumber(ratiosData.ingresoBruto), ineto=parseNumber(ratiosData.ingresoNeto);
    const ah=parseNumber(ratiosData.ahorroAnual), imp=parseNumber(ratiosData.impuestosAnual), seg=parseNumber(ratiosData.segurosAnual);
    const gd=parseNumber(ratiosData.gastosAnual), da=parseNumber(ratiosData.deudaAnual);
    const ge=parseNumber(ratiosData.gastosEsencialesMensuales), res=parseNumber(ratiosData.reserva);
    const pd=parseNumber(ratiosData.pagoDeudaMensual), pc=parseNumber(ratiosData.pasivosCorrientes);
    const sup = ineto-(imp+seg+gd+da+ah);
    const gastosT = imp+seg+gd+da;
    return {
      edad:e, ingresoBruto:ib, ingresoNeto:ineto, superavitAnual:sup, ahorroAnual:ah, gastosAnualesTotales:gastosT,
      activosTotales:totales.activosTotales, pasivosTotales:totales.pasivosTotales, patrimonioNeto:totales.patrimonioNeto,
      mesesReserva:     ge>0?res/ge:NaN,
      razonCorriente:   pc>0?totales.activosLiquidos/pc:NaN,
      tasaAhorro:       ib>0?ah/ib:NaN,
      capAcum:          ineto>0?(ah+sup)/ineto:NaN,
      dtiNeto:          (ineto/12)>0?pd/(ineto/12):NaN,
      deudaActivos:     totales.activosTotales>0?totales.pasivosTotales/totales.activosTotales:NaN,
      patrimonioActivos:totales.activosTotales>0?totales.patrimonioNeto/totales.activosTotales:NaN,
      inversionRatio:   ib>0?totales.inversiones/ib:NaN,
      riquezaNeta:      ib>0?totales.patrimonioNeto/ib:NaN,
      ahorroRetiro:     ib>0?totales.totalRetiro/ib:NaN,
    };
  };
  const ratios = calcRatios();

  const Tip = ({text,children}) => {
    const [show,setShow]=React.useState(false);
    return <span style={{position:'relative',display:'inline-flex',alignItems:'center'}} onMouseEnter={()=>setShow(true)} onMouseLeave={()=>setShow(false)}>
      {children}
      {show&&<span style={{position:'absolute',bottom:'100%',left:'50%',transform:'translateX(-50%)',marginBottom:'8px',padding:'8px 12px',background:'#1f2937',color:'white',borderRadius:'8px',fontSize:'13px',lineHeight:'1.4',width:'250px',zIndex:1000,boxShadow:'0 4px 12px rgba(0,0,0,0.15)',pointerEvents:'none'}}>{text}</span>}
    </span>;
  };

  const getInvBm  = age => { if(age<25)return 0.2; if(age<=30)return 0.2+(age-25)*(0.6-0.2)/10; if(age<=40)return 0.6+(age-30)*(3-0.6)/10; if(age<=50)return 3+(age-40)*(8-3)/10; if(age<=60)return 8+(age-50)*(16-8)/10; return 16; };
  const getRiqBm  = age => { const bms=[{age:25,good:2.5,great:5},{age:30,good:3,great:6},{age:35,good:3.5,great:7},{age:40,good:4,great:8},{age:45,good:4.5,great:9},{age:50,good:5,great:10},{age:55,good:5.5,great:11},{age:60,good:6,great:12},{age:65,good:6.5,great:13},{age:70,good:7,great:14}]; if(age<25)return bms[0]; if(age>=70)return bms[bms.length-1]; for(let i=0;i<bms.length-1;i++){if(age>=bms[i].age&&age<bms[i+1].age){const t=(age-bms[i].age)/(bms[i+1].age-bms[i].age);return{good:bms[i].good+t*(bms[i+1].good-bms[i].good),great:bms[i].great+t*(bms[i+1].great-bms[i].great)};}} return bms[bms.length-1]; };
  const getRetBm  = age => { const bms=[{age:25,f:0.35},{age:30,f:0.85},{age:35,f:1.5},{age:40,f:2.58},{age:45,f:3.14},{age:50,f:4.92},{age:55,f:6.35},{age:60,f:7.23},{age:65,f:10.84},{age:70,f:11}]; if(age<25)return bms[0].f; if(age>=70)return bms[bms.length-1].f; for(let i=0;i<bms.length-1;i++){if(age>=bms[i].age&&age<bms[i+1].age){const t=(age-bms[i].age)/(bms[i+1].age-bms[i].age);return bms[i].f+t*(bms[i+1].f-bms[i].f);}} return bms[bms.length-1].f; };

  return (
    <div>
      <div className="stats-grid">
        <div className="stat-card"><div className="stat-label">Activos Totales</div><div className="stat-value">{formatCurrency(totales.activosTotales,currency)}</div></div>
        <div className="stat-card" style={{background:'linear-gradient(135deg,var(--danger) 0%,#dc2626 100%)'}}><div className="stat-label">Pasivos Totales</div><div className="stat-value">{formatCurrency(totales.pasivosTotales,currency)}</div></div>
        <div className="stat-card" style={{background:totales.patrimonioNeto>=0?'linear-gradient(135deg,var(--emerald) 0%,var(--emerald-dark) 100%)':'linear-gradient(135deg,var(--danger) 0%,#dc2626 100%)'}}><div className="stat-label">Patrimonio Neto</div><div className="stat-value">{formatCurrency(totales.patrimonioNeto,currency)}</div></div>
      </div>

      <div className="card">
        <div className="card-header"><div><h2 className="card-title">üìä Informaci√≥n Financiera</h2><p className="card-subtitle">Calculada autom√°ticamente desde otras pesta√±as</p></div></div>
        <div className="grid-3">
          <div className="form-group">
            <label className="form-label">Edad</label>
            <input type="number" className="form-input" placeholder="35" value={ratiosData.edad} onChange={e=>updateField('edad',e.target.value)} />
          </div>
          {[
            ['Ingreso Bruto Anual','ingresoBruto','Calculado desde Ingresos'],
            ['Ingreso Neto Anual','ingresoNeto','Ingresos - Impuestos - Seguros'],
            ['Ahorro Anual','ahorroAnual','Desde categor√≠a "Ahorro"'],
            ['Impuestos Anuales','impuestosAnual','Desde "Impuestos"'],
            ['Seguros Anuales','segurosAnual','Desde "Seguros"'],
            ['Gastos Diarios Anuales','gastosAnual','Desde "Gastos Diarios"'],
            ['Servicio Deuda Anual','deudaAnual','Desde "Pago de Deuda"'],
            ['Pago Mensual Deudas','pagoDeudaMensual','Desde "Pago de Deuda"'],
            ['Gastos Esenciales Mens.','gastosEsencialesMensuales','Desde "Gastos Diarios"'],
            ['Reserva de Emergencia','reserva','Desde "Efectivo" en Activos'],
            ['Pasivos Corrientes','pasivosCorrientes','Desde Pasivos Totales'],
          ].map(([label, field, hint]) => (
            <div key={field} className="form-group">
              <label className="form-label">{label}</label>
              <input type="text" className="form-input" value={formatCurrency(ratiosData[field]||0,currency)} readOnly style={{background:'#f8fafc',cursor:'not-allowed'}} />
              <div style={{fontSize:'0.75rem',color:'var(--text-muted)',marginTop:'0.25rem'}}>‚úÖ {hint}</div>
            </div>
          ))}
        </div>
        <div style={{marginTop:'2rem',textAlign:'center'}}>
          <button className="btn btn-primary" onClick={()=>setShowResultsModal(true)} style={{fontSize:'1.1rem',padding:'1rem 2.5rem'}}>üìä Ver An√°lisis Completo de Ratios</button>
        </div>
      </div>

      {/* Results Modal */}
      {showResultsModal && (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px',backdropFilter:'blur(8px)'}} onClick={()=>setShowResultsModal(false)}>
          <div style={{background:'#fff',borderRadius:'20px',maxWidth:'1400px',width:'100%',maxHeight:'90vh',overflow:'hidden',display:'flex',flexDirection:'column',boxShadow:'0 25px 70px rgba(0,0,0,0.5)'}} onClick={e=>e.stopPropagation()}>
            <div style={{padding:'20px 24px',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <button onClick={()=>setShowResultsModal(false)} style={{background:'none',border:'none',color:'var(--primary)',fontSize:'17px',fontWeight:'600',cursor:'pointer'}}>‚Üê Volver</button>
              <div style={{fontSize:'22px',fontWeight:'800',flex:1,textAlign:'center'}}>Resultados de Ratios</div>
              <button onClick={()=>setShowResultsModal(false)} style={{background:'var(--border)',border:'none',width:'32px',height:'32px',borderRadius:'50%',fontSize:'20px',cursor:'pointer'}}>√ó</button>
            </div>
            <div style={{flex:1,overflowY:'auto',padding:'20px'}}>
              {/* Summary */}
              <div style={{background:'white',margin:'12px 0',borderRadius:'16px',boxShadow:'0 2px 8px rgba(0,0,0,.08)',padding:'16px'}}>
                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'12px'}}>
                  {[['Ingreso',ratios.ingresoBruto,'var(--success)'],['Gastos',ratios.gastosAnualesTotales,'var(--danger)'],['Ahorro*',ratios.ahorroAnual,'var(--success)'],['Activos',ratios.activosTotales,null],['Pasivos',ratios.pasivosTotales,null],['Patrimonio',ratios.patrimonioNeto,ratios.patrimonioNeto>=0?'var(--success)':'var(--danger)']].map(([label,val,col])=>(
                    <div key={label} style={{background:'#fafafa',borderRadius:'12px',padding:'14px',textAlign:'center'}}>
                      <div style={{fontSize:'12px',color:'var(--text-muted)',marginBottom:'6px',fontWeight:'600'}}>{label}</div>
                      <div style={{fontSize:'22px',fontWeight:'800',color:col||'#333'}}>{formatCurrency(val,currency)}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* KPI sections */}
              {[
                {title:'üíß LIQUIDEZ', cards:[
                  {label:'Meses de reserva',val:isFinite(ratios.mesesReserva)?ratios.mesesReserva.toFixed(1)+' m':'‚Äî',ok:ratios.mesesReserva>=6?'‚úÖ':ratios.mesesReserva>=3?'‚ö†Ô∏è':'üö®',meta:'>6 meses ‚úÖ',btn:{label:'üí° Ver recomendaciones',action:()=>setShowReservaModal(true)}},
                  {label:'Raz√≥n corriente',val:isFinite(ratios.razonCorriente)?ratios.razonCorriente.toFixed(2):'‚Äî',ok:ratios.razonCorriente>=1?'‚úÖ':'üö®',meta:'‚â•1.0 ‚úÖ'},
                ]},
                {title:'üê∑ AHORRO', cards:[
                  {label:'Tasa de ahorro',val:isFinite(ratios.tasaAhorro)?(ratios.tasaAhorro*100).toFixed(1)+'%':'‚Äî',ok:ratios.tasaAhorro>=0.30?'‚úÖ':ratios.tasaAhorro>=0.15?'‚ö†Ô∏è':'üö®',meta:'‚â•30% ‚úÖ ¬∑ 15-29% ‚ö†Ô∏è ¬∑ <15% üö®'},
                  {label:'Cap. acumulaci√≥n',val:isFinite(ratios.capAcum)?(ratios.capAcum*100).toFixed(1)+'%':'‚Äî',ok:ratios.capAcum>=0.30?'‚úÖ':ratios.capAcum>=0.10?'‚ö†Ô∏è':'üö®',meta:'‚â•30% ‚úÖ ¬∑ 10-29% ‚ö†Ô∏è ¬∑ <10% üö®'},
                ]},
                {title:'üè¶ DEUDA', cards:[
                  {label:'DTI neto',val:isFinite(ratios.dtiNeto)?(ratios.dtiNeto*100).toFixed(1)+'%':'‚Äî',ok:ratios.dtiNeto<=0.36?'‚úÖ':'üö®',meta:'‚â§36% ‚úÖ ¬∑ >36% üö®'},
                  {label:'Pasivos / Activos',val:isFinite(ratios.deudaActivos)?(ratios.deudaActivos*100).toFixed(1)+'%':'‚Äî',ok:ratios.deudaActivos<=0.30?'‚úÖ':ratios.deudaActivos<=0.50?'‚ö†Ô∏è':'üö®',meta:'‚â§30% ‚úÖ ¬∑ 30-50% ‚ö†Ô∏è ¬∑ >50% üö®'},
                ]},
                {title:'üíé PATRIMONIO', cards:[
                  {label:'Patrimonio / Activos',val:isFinite(ratios.patrimonioActivos)?(ratios.patrimonioActivos*100).toFixed(1)+'%':'‚Äî',ok:ratios.patrimonioActivos>=0.70?'‚úÖ':ratios.patrimonioActivos>=0.50?'‚ö†Ô∏è':'üö®',meta:'‚â•70% ‚úÖ ¬∑ 50-69% ‚ö†Ô∏è ¬∑ <50% üö®'},
                  {label:'Inversi√≥n / Ingreso',val:isFinite(ratios.inversionRatio)?ratios.inversionRatio.toFixed(2)+'x':'‚Äî',ok:ratios.edad>=18&&ratios.inversionRatio>=getInvBm(ratios.edad)?'‚úÖ':'üö®',meta:'Ver benchmark por edad',btn:{label:'üìä Benchmark',action:()=>setShowBenchmarkModal(true)}},
                  {label:'Nivel riqueza neta',val:isFinite(ratios.riquezaNeta)?ratios.riquezaNeta.toFixed(2)+'x':'‚Äî',ok:ratios.edad>=18&&ratios.riquezaNeta>=getRiqBm(ratios.edad).great?'‚úÖ':ratios.edad>=18&&ratios.riquezaNeta>=getRiqBm(ratios.edad).good?'‚ö†Ô∏è':'üö®',meta:'Ver benchmark por edad',btn:{label:'üìä Benchmark',action:()=>setShowBenchmarkModal(true)}},
                  {label:'Ahorro para retiro',val:isFinite(ratios.ahorroRetiro)?ratios.ahorroRetiro.toFixed(2)+'x':'‚Äî',ok:ratios.edad>=18&&ratios.ahorroRetiro>=getRetBm(ratios.edad)?'‚úÖ':'üö®',meta:'Ver benchmark por edad',btn:{label:'üìä Benchmark',action:()=>setShowBenchmarkModal(true)}},
                ]},
              ].map(section => (
                <div key={section.title} style={{padding:'0 16px'}}>
                  <div style={{margin:'24px 0 12px',padding:'8px 12px',background:'var(--primary)',borderRadius:'10px',color:'#fff',fontSize:'14px',fontWeight:'700',textTransform:'uppercase',letterSpacing:'.5px'}}>{section.title}</div>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))',gap:'16px'}}>
                    {section.cards.map(card => {
                      const isGreen  = card.ok === '‚úÖ';
                      const isYellow = card.ok === '‚ö†Ô∏è';
                      const isRed    = card.ok === 'üö®';
                      const bg       = isGreen ? '#f0fdf4' : isYellow ? '#fffbeb' : isRed ? '#fef2f2' : 'white';
                      const border   = isGreen ? '2px solid #10b981' : isYellow ? '2px solid #f59e0b' : isRed ? '2px solid #ef4444' : '2px solid var(--border)';
                      const valColor = isGreen ? '#059669' : isYellow ? '#d97706' : isRed ? '#dc2626' : '#0f172a';
                      return (
                        <div key={card.label} style={{background:bg,border,borderRadius:'14px',padding:'16px'}}>
                          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'10px'}}>
                            <div style={{fontSize:'15px',fontWeight:'600',color:'#0f172a'}}>{card.label}</div>
                            {card.btn && <button onClick={card.btn.action} style={{background:'var(--primary)',color:'white',padding:'4px 10px',borderRadius:'6px',fontSize:'12px',fontWeight:'700',cursor:'pointer',border:'none'}}>{card.btn.label}</button>}
                          </div>
                          <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'8px'}}>
                            <span style={{fontSize:'28px',fontWeight:'800',color:valColor}}>{card.val}</span>
                            {(isGreen||isYellow||isRed) && <span style={{fontSize:'22px'}}>{card.ok}</span>}
                          </div>
                          <div style={{fontSize:'13px',color:'var(--text-muted)',lineHeight:'1.4'}}>Meta: {card.meta}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Benchmark Modal */}
      {showBenchmarkModal && (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',zIndex:1001,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px',backdropFilter:'blur(8px)'}} onClick={()=>setShowBenchmarkModal(false)}>
          <div style={{background:'#fff',borderRadius:'20px',maxWidth:'1100px',width:'100%',maxHeight:'90vh',overflow:'hidden',display:'flex',flexDirection:'column'}} onClick={e=>e.stopPropagation()}>
            <div style={{padding:'20px 24px',background:'var(--primary)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <div style={{fontSize:'22px',fontWeight:'800',color:'white'}}>üìä Benchmarks por Edad</div>
              <button onClick={()=>setShowBenchmarkModal(false)} style={{background:'rgba(255,255,255,0.2)',border:'none',width:'32px',height:'32px',borderRadius:'50%',fontSize:'20px',cursor:'pointer',color:'white'}}>√ó</button>
            </div>
            <div style={{padding:'32px',overflowY:'auto'}}>
              <BenchmarkTables />
            </div>
          </div>
        </div>
      )}

      {/* Reserva Modal */}
      {showReservaModal && (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.7)',zIndex:1001,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px',backdropFilter:'blur(8px)'}} onClick={()=>setShowReservaModal(false)}>
          <div style={{background:'#fff',borderRadius:'20px',maxWidth:'900px',width:'100%',maxHeight:'90vh',overflow:'hidden',display:'flex',flexDirection:'column'}} onClick={e=>e.stopPropagation()}>
            <div style={{padding:'20px 24px',background:'var(--primary)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <div style={{fontSize:'22px',fontWeight:'800',color:'white'}}>üí° Recomendaciones de Reserva</div>
              <button onClick={()=>setShowReservaModal(false)} style={{background:'rgba(255,255,255,0.2)',border:'none',width:'32px',height:'32px',borderRadius:'50%',fontSize:'20px',cursor:'pointer',color:'white'}}>√ó</button>
            </div>
            <div style={{padding:'32px',overflowY:'auto'}}>
              <table style={{width:'100%',borderCollapse:'collapse',background:'#fff',borderRadius:'12px',overflow:'hidden'}}>
                <thead style={{background:'var(--primary)',color:'#fff'}}><tr><th style={{padding:'14px 16px',textAlign:'left',color:'white'}}>Meses</th><th style={{padding:'14px 16px',textAlign:'left',color:'white'}}>Situaci√≥n</th></tr></thead>
                <tbody>
                  {[['6 meses','Empleo estable + buena liquidez'],['9 meses','Empleo estable + dependientes'],['12 meses','Empleo inestable + dependientes'],['18 meses','Ingresos variables (freelance)'],['24 meses','Negocio propio / alta volatilidad'],['36 meses','Ingresos irregulares / pre-retiro']].map(([m,s])=>(
                    <tr key={m} style={{borderBottom:'1px solid var(--border)'}}><td style={{padding:'16px',fontSize:'20px',fontWeight:'700',color:'var(--success)'}}>{m}</td><td style={{padding:'16px',fontSize:'15px'}}>{s}</td></tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function BenchmarkTables() {
  const tableStyle = {width:'100%',borderCollapse:'collapse',background:'#fff',borderRadius:'12px',overflow:'hidden',marginBottom:'24px'};
  const thStyle    = {padding:'14px 16px',textAlign:'left',fontWeight:'700',fontSize:'14px',color:'white'};
  const tdStyle    = {padding:'12px 16px',borderBottom:'1px solid var(--border)'};
  return (
    <div>
      {[
        {title:'üí∞ Inversi√≥n / Ingreso Bruto',cols:['Edad','Benchmark','Ejemplo ($50k)'],rows:[[25,'0.2x','$10,000'],[30,'0.6x','$30,000'],[40,'1.8x','$90,000'],[50,'5.5x','$275,000'],[60,'12.0x','$600,000'],[65,'16.0x','$800,000']]},
        {title:'üíé Nivel de Riqueza Neta',cols:['Edad','Good ‚ö†Ô∏è','Great ‚úÖ','Ejemplo Great ($50k)'],rows:[[25,'2.5x','5.0x','$250,000'],[30,'3.0x','6.0x','$300,000'],[40,'4.0x','8.0x','$400,000'],[50,'5.0x','10.0x','$500,000'],[60,'6.0x','12.0x','$600,000'],[70,'7.0x','14.0x','$700,000']]},
        {title:'üèñÔ∏è Ahorro para Retiro',cols:['Edad','Benchmark','Ejemplo ($50k)'],rows:[[25,'0.35x','$17,500'],[30,'0.85x','$42,500'],[40,'2.58x','$129,000'],[50,'4.92x','$246,000'],[60,'7.23x','$361,500'],[65,'10.84x','$542,000']]},
      ].map(t => (
        <div key={t.title} style={{marginBottom:'32px'}}>
          <h3 style={{margin:'0 0 16px',padding:'12px 16px',fontSize:'18px',fontWeight:'700',color:'white',background:'var(--primary)',borderRadius:'10px'}}>{t.title}</h3>
          <table style={tableStyle}>
            <thead style={{background:'var(--primary)'}}><tr>{t.cols.map(c=><th key={c} style={thStyle}>{c}</th>)}</tr></thead>
            <tbody>{t.rows.map(r=><tr key={r[0]}>{r.map((cell,i)=><td key={i} style={tdStyle}>{cell}</td>)}</tr>)}</tbody>
          </table>
        </div>
      ))}
    </div>
  );
}

function ExportFooter({ totales, currency }) {
  return (
    <footer className="export-footer">
      <div className="export-footer-content">
        <div className="export-info">
          <div className="font-bold">Xavier Serbia Money Map</div>
          <div className="text-muted" style={{fontSize:'0.85rem',marginTop:'0.25rem'}}>
            Patrimonio Neto: <span className="currency font-bold" style={{color:totales.patrimonioNeto>=0?'var(--success)':'var(--danger)'}}>{formatCurrency(totales.patrimonioNeto,currency)}</span>
          </div>
          <div style={{fontSize:'0.75rem',color:'var(--text-muted)',marginTop:'0.5rem',maxWidth:'500px'}}>Esta herramienta proporciona an√°lisis financiero educativo. No constituye asesoramiento financiero, legal o fiscal profesional.</div>
        </div>
      </div>
    </footer>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
