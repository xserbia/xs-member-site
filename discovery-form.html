<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Discovery ¬∑ Diagn√≥stico Financiero</title>
  <style>
    :root{
      --primary:#3956E8;
      --secondary:#7459D9;
      --accent:#E8C239;
      --bg:#f6f7ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(circle at top, rgba(57,86,232,.12) 0, rgba(245,247,255,1) 40%, rgba(245,247,255,1) 100%);
      color:var(--text);
    }
    .wrap{
      max-width: 1100px;
      margin: 28px auto;
      padding: 0 16px 28px;
    }
    
    /* Header mejorado */
    header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:20px;
      margin-bottom: 28px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      text-align:center;
    }
    .brand h1{
      margin:0;
      font-size: 28px;
      letter-spacing:-0.03em;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 14px;
      max-width: 600px;
    }

    /* Step circles */
    .stepCircles{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:24px;
      margin-top:8px;
    }
    .stepCircle{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      position:relative;
      cursor:pointer;
      transition: transform .2s ease;
    }
    .stepCircle:hover .stepNumber{
      transform: scale(1.05);
      border-color: var(--primary);
    }
    .stepNumber{
      width:70px;
      height:70px;
      border-radius:50%;
      border:3px solid var(--border);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      font-weight:900;
      color:var(--muted);
      transition: all .3s ease;
      position:relative;
      z-index:2;
    }
    .stepCircle.completed .stepNumber{
      background: linear-gradient(135deg, var(--ok), #10b981);
      border-color: var(--ok);
      color:#fff;
    }
    .stepCircle.active .stepNumber{
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-color: var(--primary);
      color:#fff;
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(57,86,232,.3);
    }
    .stepLabel{
      font-size:13px;
      font-weight:700;
      color:var(--muted);
      transition: color .3s ease;
    }
    .stepCircle.active .stepLabel{
      color:var(--primary);
    }
    .stepCircle.completed .stepLabel{
      color:var(--ok);
    }

    /* Connector line between circles */
    .stepCircle:not(:last-child)::after{
      content:'';
      position:absolute;
      top:35px;
      left:calc(50% + 35px);
      width:24px;
      height:3px;
      background:var(--border);
      z-index:1;
    }
    .stepCircle.completed:not(:last-child)::after{
      background:var(--ok);
    }

    .progressInline{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .progressDots{
      display:none; /* Hidden now, using circles instead */
    }
    .progressText{
      font-size:13px;
      color:var(--muted);
    }

    /* Auto-save indicator */
    .autoSaveIndicator{
      font-size:12px;
      color:var(--ok);
      opacity:0;
      transition: opacity .3s ease;
    }
    .autoSaveIndicator.show{
      opacity:1;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content{ 
      padding: 24px 20px; 
      min-height: 420px;
    }

    /* Demo banner */
    /* Panel styles */
    .panel{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      background: #fff;
      margin-bottom: 16px;
    }
    .panel h2{
      margin:0 0 8px;
      font-size: 20px;
      letter-spacing:-0.02em;
    }
    .panel h3{
      margin:16px 0 10px;
      font-size: 16px;
      letter-spacing:-0.01em;
    }
    .panel p{
      margin:0 0 12px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    /* Hero section */
    .hero{
      text-align:center;
      padding: 28px 20px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(57,86,232,.08), rgba(116,89,217,.08));
      border:1px solid rgba(57,86,232,.2);
      margin-bottom: 20px;
    }
    .hero h2{
      margin:0 0 10px;
      font-size: 26px;
      letter-spacing:-0.03em;
    }
    .hero p{
      margin:0;
      font-size: 15px;
      color:var(--muted);
      line-height:1.6;
    }
    .hero b{
      color:var(--primary);
    }

    /* Checklist */
    .checklistPrep{
      background: rgba(22,163,74,.06);
      border:1px solid rgba(22,163,74,.2);
      border-radius: 14px;
      padding: 16px;
      margin: 14px 0;
    }
    .checklistPrep p{
      margin:0 0 8px;
      font-weight:600;
      color:var(--text);
    }
    .checklistPrep ul{
      margin:0;
      padding-left:20px;
      color:var(--text);
    }
    .checklistPrep li{
      margin:6px 0;
      font-size:14px;
    }

    /* Mode selector */
    /* Templates */
    .quickTemplates{
      margin: 16px 0;
    }

    /* Goal cards */
    .goalsGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap:12px;
      margin: 20px 0;
    }
    .goalCard{
      border:2px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      text-align:center;
      cursor:pointer;
      transition: all .2s ease;
      background:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .goalCard:hover{
      border-color: rgba(57,86,232,.35);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15,23,42,.1);
    }
    .goalCard.selected{
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(57,86,232,.08), rgba(116,89,217,.08));
      box-shadow: 0 4px 12px rgba(57,86,232,.2);
    }
    .goalCard .goalIcon{
      font-size:48px;
      line-height:1;
    }
    .goalCard .goalLabel{
      font-size:13px;
      font-weight:700;
      color:var(--text);
    }
    .goalCard.selected .goalLabel{
      color:var(--primary);
    }

    /* Contract and Signature */
    .contractBox{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin: 20px 0;
    }
    .contractBox h3{
      color: var(--primary);
      margin-top: 0;
      font-size: 20px;
    }
    .contractText{
      max-height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .contractText h4{
      color: var(--primary);
      font-size: 15px;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    .contractText ul{
      margin: 10px 0;
      padding-left: 24px;
    }
    .contractText li{
      margin: 6px 0;
    }
    .signatureSection{
      margin-top: 24px;
    }
    .signatureCanvas{
      position: relative;
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: #fff;
      padding: 10px;
      margin: 10px 0;
    }
    .signatureCanvas canvas{
      display: block;
      width: 100%;
      max-width: 600px;
      height: 200px;
      border: 1px dashed #ddd;
      border-radius: 4px;
      cursor: crosshair;
      touch-action: none;
    }
    .signatureCanvas #clearSignature{
      margin-top: 10px;
      font-size: 13px;
      padding: 8px 16px;
    }
    .signatureInfo{
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px 16px;
      border-radius: 4px;
      margin-top: 16px;
    }
    .signatureInfo .hint{
      margin: 0;
      color: #856404;
    }
    label.checkbox{
      display: flex;
      align-items: flex-start;
      gap: 10px;
      cursor: pointer;
      padding: 12px;
      border-radius: 8px;
      transition: background .2s ease;
    }
    label.checkbox:hover{
      background: rgba(57,86,232,.05);
    }
    label.checkbox input[type="checkbox"]{
      margin-top: 2px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    label.checkbox span{
      flex: 1;
      line-height: 1.5;
    }

    /* Templates */
    .quickTemplates{
      margin: 16px 0;
    }
    .quickTemplates b{
      display:block;
      margin-bottom:10px;
      font-size:14px;
    }
    .templateGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .templateBtn{
      border:2px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 14px;
      text-align:left;
      cursor:pointer;
      transition: all .2s ease;
      font-size:14px;
      font-weight:600;
    }
    .templateBtn:hover{
      border-color: rgba(57,86,232,.35);
      background: rgba(57,86,232,.04);
    }
    .templateBtn.selected{
      border-color: var(--primary);
      background: rgba(57,86,232,.08);
      color:var(--primary);
    }

    /* Wizard flow */
    .wizardFlow{
      max-width: 680px;
      margin: 0 auto;
    }
    .wizardStep{
      display:none;
      animation: fadeIn 0.3s ease;
    }
    .wizardStep.active{
      display:block;
    }
    .wizardQ{
      text-align:center;
      margin-bottom: 24px;
    }
    .wizardQ b{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    .wizardQ h3{
      margin:0 0 6px;
      font-size:22px;
      letter-spacing:-0.02em;
    }
    .wizardQ p{
      margin:0;
      color:var(--muted);
      font-size:14px;
    }
    .wizardOptions{
      display:grid;
      gap:10px;
    }
    .optionBtn{
      border:2px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 18px 20px;
      text-align:left;
      cursor:pointer;
      transition: all .15s ease;
      font-size:15px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .optionBtn:hover{
      border-color: rgba(57,86,232,.35);
      background: rgba(57,86,232,.04);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(15,23,42,.08);
    }
    .optionBtn:active{
      transform: translateY(0);
    }

    /* Category inline cards */
    .categoriesInline{
      display:grid;
      gap:12px;
      margin-top: 16px;
    }
    .catInlineCard{
      border:2px solid transparent;
      background: linear-gradient(#fff, #fff) padding-box,
                  linear-gradient(135deg, var(--primary), var(--secondary)) border-box;
      border-radius: 14px;
      overflow:hidden;
      transition: all .2s ease;
      margin-bottom: 14px;
    }
    .catInlineCard.selected{
      background: linear-gradient(rgba(57,86,232,.02), rgba(57,86,232,.02)) padding-box,
                  linear-gradient(135deg, var(--primary), var(--secondary)) border-box;
    }
    .catInlineCard.checked{
      background: linear-gradient(rgba(57,86,232,.04), rgba(116,89,217,.04)) padding-box,
                  linear-gradient(135deg, var(--primary), var(--secondary)) border-box;
    }
    .catHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      cursor:pointer;
      user-select:none;
      background: linear-gradient(135deg, rgba(57,86,232,.03), rgba(116,89,217,.03));
      transition: all .3s ease;
    }
    .catHeader:hover{
      background: linear-gradient(135deg, rgba(57,86,232,.06), rgba(116,89,217,.06));
    }
    .catInlineCard.checked .catHeader{
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-bottom: 2px solid transparent;
    }
    .catInlineCard.checked .catHeader:hover{
      background: linear-gradient(135deg, #4a66f0, #8669e0);
    }
    .catInlineCard.checked .catHeader .catLabel b,
    .catInlineCard.checked .catHeader .catLabel span{
      background: none;
      -webkit-background-clip: initial;
      -webkit-text-fill-color: #fff;
      background-clip: initial;
      color: #fff;
    }
    .catInlineCard.checked .catHeader .catExpand{
      background: rgba(255,255,255,.2);
      color: #fff;
    }
    .catInlineCard.open .catHeader{
      border-bottom: 1px solid var(--border);
    }
    .catInlineCard.checked.open .catHeader{
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-bottom-color: transparent;
    }
    .catInlineCard.checked.open .catHeader .catLabel b,
    .catInlineCard.checked.open .catHeader .catLabel span{
      background: none;
      -webkit-background-clip: initial;
      -webkit-text-fill-color: #fff;
      background-clip: initial;
      color: #fff;
    }
    .catInlineCard.checked.open .catHeader .catExpand{
      background: rgba(255,255,255,.2);
      color: #fff;
    }
    .catInfo{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .catInfo input[type="checkbox"]{
      width:20px;
      height:20px;
      cursor:pointer;
      accent-color:var(--primary);
    }
    .catLabel b{
      display:block;
      font-size:15px;
      font-weight:700;
      margin-bottom:2px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: all .3s ease;
    }
    .catInlineCard.open .catHeader .catLabel b{
      background: #fff;
      -webkit-background-clip: initial;
      -webkit-text-fill-color: #fff;
      background-clip: initial;
    }
    .catLabel span{
      display:block;
      font-size:12px;
      color:var(--muted);
      transition: color .3s ease;
    }
    .catExpand{
      width:32px;
      height:32px;
      border-radius:8px;
      background:rgba(15,23,42,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-weight:900;
      transition: transform .3s ease, background .3s ease, color .3s ease;
    }
    .catInlineCard.open .catExpand{
      transform: rotate(180deg);
    }

    .catBody{
      padding: 0 16px 16px;
      display:none;
      padding-top:16px;
      background: #fff;
    }
    .catInlineCard.open .catBody{
      display:block;
    }

    /* Quick add row */
    .quickAddRow{
      display:grid;
      grid-template-columns: 1.5fr 1fr auto;
      gap:8px;
      margin-bottom: 12px;
    }
    .quickAddRow input,
    .quickAddRow select{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      font-size:13px;
      background:#fff;
    }
    .quickAddRow button{
      padding: 10px 16px;
      border:1px solid var(--primary);
      background: var(--primary);
      color:#fff;
      border-radius: 10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .quickAddRow button:hover{
      background: var(--secondary);
    }

    /* Standard add row (type + alias + amount) */
    .standardAddRow{
      display:grid;
      grid-template-columns: 1.3fr 1.3fr 1fr auto;
      gap:8px;
      margin-bottom: 12px;
    }
    .standardAddRow select,
    .standardAddRow input{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      font-size:13px;
      background:#fff;
    }
    .standardAddRow button{
      padding: 10px 14px;
      border:1px solid var(--primary);
      background: var(--primary);
      color:#fff;
      border-radius: 10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .standardAddRow button:hover{
      background: var(--secondary);
    }

    /* Standard add row MULTI (with owner selector) */
    .standardAddRowMulti{
      display:grid;
      grid-template-columns: 1.2fr 1.2fr 0.9fr 1.1fr auto;
      gap:8px;
      margin-bottom: 12px;
    }
    .standardAddRowMulti select,
    .standardAddRowMulti input{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      font-size:13px;
      background:#fff;
    }
    .standardAddRowMulti button{
      padding: 10px 14px;
      border:1px solid var(--primary);
      background: var(--primary);
      color:#fff;
      border-radius: 10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .standardAddRowMulti button:hover{
      background: var(--secondary);
    }

    /* Expense/Savings special row */
    .expenseAddRow{
      display:grid;
      grid-template-columns: 2fr 1fr auto;
      gap:8px;
      margin-bottom: 12px;
    }
    .expenseAddRow select,
    .expenseAddRow input{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      font-size:13px;
      background:#fff;
    }
    .expenseAddRow button{
      padding: 10px 16px;
      border:1px solid var(--primary);
      background: var(--primary);
      color:#fff;
      border-radius: 10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .expenseAddRow button:hover{
      background: var(--secondary);
    }

    /* Expense/Savings MULTI (with owner) */
    .expenseAddRowMulti{
      display:grid;
      grid-template-columns: 2fr 0.9fr 1.1fr auto;
      gap:8px;
      margin-bottom: 12px;
    }
    .expenseAddRowMulti select,
    .expenseAddRowMulti input{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      font-size:13px;
      background:#fff;
    }
    .expenseAddRowMulti button{
      padding: 10px 14px;
      border:1px solid var(--primary);
      background: var(--primary);
      color:#fff;
      border-radius: 10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .expenseAddRowMulti button:hover{
      background: var(--secondary);
    }

    .itemsList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .itemChip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      background: rgba(15,23,42,.015);
      font-size:13px;
    }
    .itemChip .chipInfo{
      flex:1;
      min-width:0;
    }
    .itemChip .chipName{
      font-weight:600;
      margin-bottom:2px;
    }
    .itemChip .chipDetails{
      font-size:12px;
      color:var(--muted);
    }
    .itemChip .chipRemove{
      width:24px;
      height:24px;
      border-radius:6px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      flex-shrink:0;
    }
    .itemChip .chipRemove:hover{
      background:rgba(220,38,38,.08);
      color:#dc2626;
      border-color:rgba(220,38,38,.35);
    }

    /* Person cards */
    .peopleWrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: 14px;
    }
    .personCard{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: rgba(15,23,42,.015);
      animation: fadeIn 0.3s ease;
    }
    .personHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .tag{
      font-size: 11px;
      font-weight: 800;
      color: var(--primary);
      background: rgba(57,86,232,.10);
      border:1px solid rgba(57,86,232,.18);
      padding: 6px 10px;
      border-radius: 999px;
    }
    .xbtn{
      border:1px solid var(--border);
      background:#fff;
      color: var(--muted);
      width:32px;
      height:32px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:900;
      font-size:16px;
    }
    .xbtn:hover{
      background:rgba(220,38,38,.08);
      color:#dc2626;
      border-color:rgba(220,38,38,.35);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin: 10px 0;
    }
    .field label{
      font-size: 13px;
      font-weight:600;
      color: var(--text);
    }
    .field label .optional{
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      background:rgba(100,116,139,.1);
      border:1px solid rgba(100,116,139,.2);
      padding:3px 8px;
      border-radius:999px;
      margin-left:6px;
    }
    input[type="text"], 
    input[type="email"], 
    input[type="tel"], 
    input[type="number"], 
    select, 
    textarea{
      width:100%;
      padding: 11px 14px;
      border:1px solid var(--border);
      border-radius: 12px;
      outline:none;
      font-size: 14px;
      background:#fff;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    textarea{
      min-height: 100px; 
      resize: vertical;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(57,86,232,.45);
      box-shadow: 0 0 0 4px rgba(57,86,232,.10);
    }

    .row{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height:1.4;
    }
    .hint b{
      color:var(--text);
    }

    /* Buttons */
    .btns{
      display:flex;
      gap:10px;
      justify-content:space-between;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background:#fff;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color: var(--text);
      padding: 11px 18px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      cursor:pointer;
      transition: all .15s ease;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(15,23,42,.1);
    }
    .btn:active{
      transform: translateY(0);
    }
    .btn.primary{
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-color: transparent;
      color: #fff;
      box-shadow: 0 8px 16px rgba(57,86,232,.2);
    }
    .btn.primary:hover{
      box-shadow: 0 10px 20px rgba(57,86,232,.25);
    }
    .btn.ghost{
      background: transparent;
      color: var(--muted);
      border-color:transparent;
    }
    .btn.ghost:hover{
      background:rgba(15,23,42,.04);
      color:var(--text);
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .btn.large{
      padding: 14px 24px;
      font-size:15px;
    }
    .btn.full{
      width:100%;
      justify-content:center;
    }

    /* Confirmation */
    .confirmationHero{
      text-align:center;
      padding: 32px 20px;
    }
    .checkIcon{
      width:80px;
      height:80px;
      margin: 0 auto 16px;
      border-radius:50%;
      background: linear-gradient(135deg, var(--ok), #10b981);
      color:#fff;
      font-size:48px;
      display:flex;
      align-items:center;
      justify-content:center;
      animation: scaleIn 0.4s ease;
    }
    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }
    .confirmationHero h2{
      margin:0 0 10px;
      font-size:24px;
    }
    .confirmationHero p{
      margin:0;
      color:var(--muted);
      font-size:15px;
    }

    .deliverables{
      display:grid;
      gap:12px;
      margin: 24px 0;
    }
    .deliverableCard{
      display:flex;
      align-items:flex-start;
      gap:14px;
      padding: 16px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
    }
    .deliverableCard .emoji{
      font-size:28px;
      flex-shrink:0;
    }
    .deliverableCard b{
      display:block;
      font-size:15px;
      margin-bottom:4px;
    }
    .deliverableCard p{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }

    /* Summary section */
    .summaryGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
      margin: 16px 0;
    }
    .summaryCard{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: rgba(15,23,42,.015);
    }
    .summaryCard .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .summaryCard .value{
      font-size:18px;
      font-weight:700;
      color:var(--text);
    }

    /* Toast */
    .toast{
      position:fixed;
      bottom:24px;
      right:24px;
      background:var(--text);
      color:#fff;
      padding: 12px 20px;
      border-radius: 12px;
      font-size:13px;
      font-weight:600;
      box-shadow: 0 10px 30px rgba(15,23,42,.3);
      opacity:0;
      transform: translateY(20px);
      transition: all .3s ease;
      z-index:1000;
    }
    .toast.show{
      opacity:1;
      transform: translateY(0);
    }

    @media (max-width: 900px){
      .templateGrid, .summaryGrid{
        grid-template-columns: 1fr;
      }
      .goalsGrid{
        grid-template-columns: repeat(2, 1fr);
      }
      .row{
        grid-template-columns:1fr;
      }
      .quickAddRow{
        grid-template-columns: 1fr;
      }
      .standardAddRow{
        grid-template-columns: 1fr;
      }
      .standardAddRowMulti{
        grid-template-columns: 1fr;
      }
      .expenseAddRow{
        grid-template-columns: 1fr;
      }
      .expenseAddRowMulti{
        grid-template-columns: 1fr;
      }
      
      /* Smaller circles on mobile */
      .stepCircles{
        gap:16px;
      }
      .stepNumber{
        width:55px;
        height:55px;
        font-size:22px;
      }
      .stepCircle.active .stepNumber{
        transform: scale(1.05);
      }
      .stepCircle:not(:last-child)::after{
        top:27px;
        left:calc(50% + 27px);
        width:16px;
      }
      .stepLabel{
        font-size:11px;
      }
      .brand h1{
        font-size:22px;
      }
      .brand p{
        font-size:13px;
      }
    }

    @media (max-width: 640px){
      .stepCircles{
        gap:8px;
      }
      .stepNumber{
        width:45px;
        height:45px;
        font-size:18px;
        border-width:2px;
      }
      .stepCircle:not(:last-child)::after{
        top:22px;
        left:calc(50% + 22px);
        width:8px;
        height:2px;
      }
      .stepLabel{
        font-size:9px;
      }
    }

    @media (max-width: 480px){
      .goalsGrid{
        gap:8px;
      }
      .goalCard{
        padding:12px 8px;
      }
      .goalCard .goalIcon{
        font-size:36px;
      }
      .goalCard .goalLabel{
        font-size:11px;
      }
    }

    /* Keyboard hints */
    .keyboardHints{
      position:fixed;
      bottom:20px;
      left:20px;
      font-size:11px;
      color:var(--muted);
      background:rgba(255,255,255,.9);
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      display:none;
    }
    .keyboardHints.show{
      display:block;
    }
    .keyboardHints kbd{
      background:rgba(15,23,42,.08);
      padding:2px 6px;
      border-radius:4px;
      font-family:monospace;
      font-size:10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Discovery ¬∑ Diagn√≥stico Financiero</h1>
        <p>Recopilaci√≥n r√°pida para preparar tu diagn√≥stico. No es asesor√≠a ni recomendaci√≥n.</p>
      </div>

      <div class="stepCircles" id="stepCircles">
        <div class="stepCircle clickable" data-step-circle="0" data-goto="0">
          <div class="stepNumber">üñäÔ∏è</div>
          <div class="stepLabel">Firma</div>
        </div>
        <div class="stepCircle clickable" data-step-circle="1" data-goto="1">
          <div class="stepNumber">1</div>
          <div class="stepLabel">Welcome</div>
        </div>
        <div class="stepCircle clickable" data-step-circle="2" data-goto="2">
          <div class="stepNumber">2</div>
          <div class="stepLabel">Personas</div>
        </div>
        <div class="stepCircle clickable" data-step-circle="3" data-goto="3">
          <div class="stepNumber">3</div>
          <div class="stepLabel">Metas</div>
        </div>
        <div class="stepCircle clickable" data-step-circle="4" data-goto="4">
          <div class="stepNumber">4</div>
          <div class="stepLabel">Finanzas</div>
        </div>
        <div class="stepCircle clickable" data-step-circle="5" data-goto="5">
          <div class="stepNumber">5</div>
          <div class="stepLabel">Final</div>
        </div>
      </div>

      <div class="progressInline">
        <span class="progressText" id="progressText">Firma del contrato</span>
        <div class="autoSaveIndicator" id="autoSave">Guardado ‚úì</div>
      </div>
    </header>

    <div class="card">
      <div class="content">
        <!-- STEP 1: Preparaci√≥n -->
        <section class="step" data-step="0">
          <!-- VIEW 1: Signature Form (before signing) -->
          <div id="signatureForm" class="panel">
            <h2>Consentimiento y Acuerdo de Servicio</h2>
            <p class="hint">Por favor lee cuidadosamente y firma para continuar</p>
            
            <div class="contractBox">
              <h3>Acuerdo de Asesor√≠a Financiera</h3>
              
              <div class="contractText">
                <p><b>Fecha:</b> <span id="contractDate"></span></p>
                
                <h4>1. Prop√≥sito del Discovery</h4>
                <p>
                  Este cuestionario de diagn√≥stico financiero ("Discovery") tiene como prop√≥sito 
                  recopilar informaci√≥n sobre tu situaci√≥n financiera actual para preparar una 
                  sesi√≥n de asesor√≠a personalizada.
                </p>
                
                <h4>2. Uso de la Informaci√≥n</h4>
                <p>
                  La informaci√≥n que proporciones ser√° utilizada exclusivamente para:
                </p>
                <ul>
                  <li>Preparar recomendaciones financieras personalizadas</li>
                  <li>Facilitar la sesi√≥n de diagn√≥stico</li>
                  <li>Crear reportes internos para nuestro equipo de asesores</li>
                </ul>
                
                <h4>3. Confidencialidad</h4>
                <p>
                  Toda la informaci√≥n proporcionada ser√° tratada de manera estrictamente confidencial. 
                  No compartiremos tus datos con terceros sin tu consentimiento expl√≠cito, excepto 
                  cuando sea requerido por ley.
                </p>
                
                <h4>4. Exactitud de la Informaci√≥n</h4>
                <p>
                  Te comprometes a proporcionar informaci√≥n veraz y actualizada. Entiendes que las 
                  recomendaciones se basar√°n en la informaci√≥n que proporciones.
                </p>
                
                <h4>5. No es Asesor√≠a Legal o Fiscal</h4>
                <p>
                  Este servicio proporciona asesor√≠a financiera general. No sustituye asesor√≠a legal, 
                  fiscal o de inversiones profesional. Te recomendamos consultar con profesionales 
                  especializados para temas espec√≠ficos.
                </p>
                
                <h4>6. Protecci√≥n de Datos</h4>
                <p>
                  Tus datos ser√°n almacenados de forma segura y protegidos seg√∫n las mejores pr√°cticas 
                  de seguridad. Tienes derecho a solicitar acceso, correcci√≥n o eliminaci√≥n de tus 
                  datos en cualquier momento.
                </p>
                
                <h4>7. Aceptaci√≥n</h4>
                <p>
                  Al firmar este documento, confirmas que:
                </p>
                <ul>
                  <li>Has le√≠do y comprendido este acuerdo</li>
                  <li>Aceptas los t√©rminos y condiciones descritos</li>
                  <li>Autorizas el uso de tu informaci√≥n seg√∫n lo indicado</li>
                  <li>Eres mayor de edad y tienes capacidad legal para firmar</li>
                </ul>
              </div>
              
              <div class="signatureSection">
                <div class="field">
                  <label>Nombre Completo *</label>
                  <input 
                    type="text" 
                    id="signatureName" 
                    placeholder="Tu nombre completo"
                    required
                  />
                </div>
                
                <div class="field">
                  <label>Firma Digital *</label>
                  <p class="hint">Firma con tu mouse o dedo en el recuadro:</p>
                  <div class="signatureCanvas">
                    <canvas id="signatureCanvas" width="600" height="200"></canvas>
                    <button class="btn ghost" id="clearSignature" type="button">
                      Limpiar firma
                    </button>
                  </div>
                </div>
                
                <div class="field">
                  <label class="checkbox">
                    <input type="checkbox" id="acceptTerms" required />
                    <span>
                      Confirmo que he le√≠do y acepto los t√©rminos de este acuerdo. 
                      Entiendo que mi firma digital tiene la misma validez legal que una firma manuscrita.
                    </span>
                  </label>
                </div>
                
                <div class="signatureInfo">
                  <p class="hint">
                    ‚ÑπÔ∏è Al firmar, registramos tu direcci√≥n IP (<span id="userIP">obteniendo...</span>) 
                    y la fecha/hora exacta para validez legal.
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- VIEW 2: Locked Contract (after signing) -->
          <div id="signatureLocked" class="panel" style="display:none;">
            <div style="text-align:center; padding:20px 0;">
              <div style="display:inline-block; background:linear-gradient(135deg, #22c55e, #10b981); color:white; padding:12px 24px; border-radius:50px; font-size:18px; font-weight:700; margin-bottom:20px;">
                ‚úÖ Contrato Firmado y Sellado
              </div>
              <p style="color:#6c757d; font-size:14px;">
                Este contrato est√° firmado legalmente y no puede ser modificado.
              </p>
            </div>
            
            <div class="contractBox" style="border-color:#22c55e;">
              <h2 style="color:#22c55e;">üìÑ Tu Contrato Firmado</h2>
              
              <div style="background:#d4edda; padding:20px; border-radius:8px; border-left:4px solid #22c55e; margin-bottom:20px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                  <div>
                    <p style="margin:0; font-size:12px; color:#155724; font-weight:600;">FIRMANTE</p>
                    <p style="margin:4px 0 0; font-size:16px; color:#155724; font-weight:700;" id="lockedName">-</p>
                  </div>
                  <div>
                    <p style="margin:0; font-size:12px; color:#155724; font-weight:600;">EMAIL</p>
                    <p style="margin:4px 0 0; font-size:16px; color:#155724; font-weight:700;" id="lockedEmail">-</p>
                  </div>
                  <div>
                    <p style="margin:0; font-size:12px; color:#155724; font-weight:600;">FECHA Y HORA</p>
                    <p style="margin:4px 0 0; font-size:14px; color:#155724;" id="lockedTimestamp">-</p>
                  </div>
                  <div>
                    <p style="margin:0; font-size:12px; color:#155724; font-weight:600;">DIRECCI√ìN IP</p>
                    <p style="margin:4px 0 0; font-size:14px; color:#155724;" id="lockedIP">-</p>
                  </div>
                </div>
                
                <div style="margin-top:20px; padding-top:20px; border-top:1px solid #c3e6cb;">
                  <p style="margin:0; font-size:12px; color:#155724; font-weight:600;">FIRMA DIGITAL</p>
                  <div style="background:white; padding:10px; border-radius:6px; margin-top:8px;">
                    <img id="lockedSignatureImg" src="" alt="Firma" style="max-width:300px; height:auto; display:block; margin:0 auto;" />
                  </div>
                </div>
              </div>
              
              <div style="display:flex; gap:12px; flex-wrap:wrap;">
                <button 
                  type="button" 
                  id="downloadContractBtn" 
                  class="btn" 
                  style="background:linear-gradient(135deg, #3956E8, #7459D9); color:white; flex:1; min-width:200px;"
                >
                  üì• Descargar Contrato Firmado
                </button>
                
                <button 
                  type="button" 
                  id="viewContractTextBtn" 
                  class="btn" 
                  style="background:white; color:#3956E8; border:2px solid #3956E8; flex:1; min-width:200px;"
                >
                  üìÑ Ver Texto Completo
                </button>
              </div>
              
              <div id="contractFullText" style="display:none; margin-top:20px;">
                <div class="contractText">
                  <p><b>Fecha:</b> <span id="contractDateLocked"></span></p>
                  
                  <h4>1. Prop√≥sito del Discovery</h4>
                  <p>
                    Este cuestionario de diagn√≥stico financiero ("Discovery") tiene como prop√≥sito 
                    recopilar informaci√≥n sobre tu situaci√≥n financiera actual para preparar una 
                    sesi√≥n de asesor√≠a personalizada.
                  </p>
                  
                  <h4>2. Uso de la Informaci√≥n</h4>
                  <p>La informaci√≥n que proporciones ser√° utilizada exclusivamente para:</p>
                  <ul>
                    <li>Preparar recomendaciones financieras personalizadas</li>
                    <li>Facilitar la sesi√≥n de diagn√≥stico</li>
                    <li>Crear reportes internos para nuestro equipo de asesores</li>
                  </ul>
                  
                  <h4>3. Confidencialidad</h4>
                  <p>
                    Toda la informaci√≥n proporcionada ser√° tratada de manera estrictamente confidencial. 
                    No compartiremos tus datos con terceros sin tu consentimiento expl√≠cito, excepto 
                    cuando sea requerido por ley.
                  </p>
                  
                  <h4>4. Exactitud de la Informaci√≥n</h4>
                  <p>
                    Te comprometes a proporcionar informaci√≥n veraz y actualizada. Entiendes que las 
                    recomendaciones se basar√°n en la informaci√≥n que proporciones.
                  </p>
                  
                  <h4>5. No es Asesor√≠a Legal o Fiscal</h4>
                  <p>
                    Este servicio proporciona asesor√≠a financiera general. No sustituye asesor√≠a legal, 
                    fiscal o de inversiones profesional. Te recomendamos consultar con profesionales 
                    especializados para temas espec√≠ficos.
                  </p>
                  
                  <h4>6. Protecci√≥n de Datos</h4>
                  <p>
                    Tus datos ser√°n almacenados de forma segura y protegidos seg√∫n las mejores pr√°cticas 
                    de seguridad. Tienes derecho a solicitar acceso, correcci√≥n o eliminaci√≥n de tus 
                    datos en cualquier momento.
                  </p>
                  
                  <h4>7. Aceptaci√≥n</h4>
                  <p>Al firmar este documento, confirmas que:</p>
                  <ul>
                    <li>Has le√≠do y comprendido este acuerdo</li>
                    <li>Aceptas los t√©rminos y condiciones descritos</li>
                    <li>Autorizas el uso de tu informaci√≥n seg√∫n lo indicado</li>
                    <li>Eres mayor de edad y tienes capacidad legal para firmar</li>
                  </ul>
                </div>
              </div>
              
              <div style="background:#fff3cd; padding:16px; border-radius:8px; border-left:4px solid #ffc107; margin-top:20px;">
                <p style="margin:0; font-size:13px; color:#856404;">
                  üîí <strong>Seguridad:</strong> Este contrato est√° protegido y sellado. No puede ser editado 
                  ni modificado. Guarda una copia para tus registros personales.
                </p>
              </div>
            </div>
          </div>
        </section>

        <section class="step" data-step="1" hidden>
          <div class="hero">
            <h2>¬°Hola! Preparemos tu sesi√≥n de diagn√≥stico üëã</h2>
            <p>
              Esto tomar√° <b>3-10 minutos</b> dependiendo del modo que elijas. 
              Tu progreso se guarda autom√°ticamente, puedes volver cuando quieras.
            </p>
          </div>

          <div class="panel">
            <h2>Antes de empezar</h2>
            
            <div class="field" style="margin-bottom:24px;">
              <label>Tu email *</label>
              <input 
                type="email" 
                id="userEmail" 
                placeholder="tu@email.com" 
                required 
                style="max-width:400px;"
              />
              <p class="hint">
                Para enviarte el resumen de tu diagn√≥stico y el link para agendar tu sesi√≥n.
              </p>
            </div>
            
            <div class="checklistPrep">
              <p>üí° Ten a mano (opcional pero √∫til):</p>
              <ul>
                <li>üí∞ Idea aproximada de ingresos anuales</li>
                <li>üè¶ Lista mental de cuentas bancarias/inversiones</li>
                <li>üè† Si tienes propiedades o pr√©stamos activos</li>
                <li>üë• Info b√°sica de personas con quienes compartes finanzas</li>
              </ul>
              <div class="hint">
                <b>Tranquilo:</b> No necesitas n√∫meros exactos ahora. 
                Podemos refinar todo en la sesi√≥n.
              </div>
            </div>
            
            <div style="background:#e3f2fd; border-left:4px solid #2196f3; padding:16px; border-radius:6px; margin-top:20px;">
              <p style="margin:0; font-size:14px; color:#1565c0;">
                ‚ÑπÔ∏è <b>Navegaci√≥n libre:</b> Puedes moverte entre pasos haciendo click en los c√≠rculos de arriba. 
                Si no tienes toda la informaci√≥n a mano, guarda lo que puedas y vuelve despu√©s. 
                Tu progreso se guarda autom√°ticamente.
              </p>
            </div>
          </div>
        </section>

        <!-- STEP 2: Personas -->
        <section class="step" data-step="2" hidden>
          <div class="panel">
            <h2>Estructura familiar/financiera</h2>
            <p>
              Esto nos ayuda a <b>personalizar las recomendaciones</b>. 
              Por ejemplo: si tienes pareja, podemos analizar estrategias conjuntas.
            </p>

            <div class="quickTemplates">
              <b>Plantillas r√°pidas:</b>
              <div class="templateGrid">
                <button class="templateBtn" data-template="single" type="button">
                  üë§ Solo yo
                </button>
                <button class="templateBtn" data-template="couple" type="button">
                  üë• Pareja (sin hijos)
                </button>
                <button class="templateBtn" data-template="family" type="button">
                  üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia (pareja + hijos)
                </button>
                <button class="templateBtn" data-template="custom" type="button">
                  ‚úèÔ∏è Personalizado
                </button>
              </div>
            </div>

            <div class="field" id="householdRoleField">
              <label>¬øEres el principal proveedor econ√≥mico?</label>
              <select id="householdRole">
                <option value="">Selecciona‚Ä¶</option>
                <option value="primary_provider">S√≠, principalmente yo</option>
                <option value="shared">Compartido</option>
                <option value="not_primary">No, principalmente otra persona</option>
              </select>
            </div>

            <div class="peopleWrap" id="peopleWrap"></div>

            <button class="btn" type="button" id="addPersonBtn">
              ‚ûï Agregar otra persona
            </button>
          </div>
        </section>

        <!-- STEP 3: Metas -->
        <section class="step" data-step="3" hidden>
          <div class="panel">
            <h2>¬øCu√°les son tus metas financieras?</h2>
            <p>
              Selecciona todas las metas que sean importantes para ti. 
              Esto nos ayuda a <b>priorizar recomendaciones</b> en tu diagn√≥stico.
            </p>

            <div class="goalsGrid" id="goalsGrid">
              <div class="goalCard" data-goal="casa">
                <div class="goalIcon">üè†</div>
                <div class="goalLabel">Comprar casa</div>
              </div>
              <div class="goalCard" data-goal="retiro">
                <div class="goalIcon">üèñÔ∏è</div>
                <div class="goalLabel">Retiro c√≥modo</div>
              </div>
              <div class="goalCard" data-goal="emergencia">
                <div class="goalIcon">üõ°Ô∏è</div>
                <div class="goalLabel">Fondo emergencia</div>
              </div>
              <div class="goalCard" data-goal="educacion">
                <div class="goalIcon">üéì</div>
                <div class="goalLabel">Educaci√≥n hijos</div>
              </div>
              <div class="goalCard" data-goal="viaje">
                <div class="goalIcon">‚úàÔ∏è</div>
                <div class="goalLabel">Viaje/Vacaciones</div>
              </div>
              <div class="goalCard" data-goal="deudas">
                <div class="goalIcon">üí≥</div>
                <div class="goalLabel">Pagar deudas</div>
              </div>
              <div class="goalCard" data-goal="negocio">
                <div class="goalIcon">üíº</div>
                <div class="goalLabel">Iniciar negocio</div>
              </div>
              <div class="goalCard" data-goal="auto">
                <div class="goalIcon">üöó</div>
                <div class="goalLabel">Comprar auto</div>
              </div>
              <div class="goalCard" data-goal="inversiones">
                <div class="goalIcon">üìà</div>
                <div class="goalLabel">Hacer crecer dinero</div>
              </div>
              <div class="goalCard" data-goal="independencia">
                <div class="goalIcon">ü¶Ö</div>
                <div class="goalLabel">Independencia financiera</div>
              </div>
              <div class="goalCard" data-goal="herencia">
                <div class="goalIcon">üéÅ</div>
                <div class="goalLabel">Dejar herencia</div>
              </div>
              <div class="goalCard" data-goal="otro">
                <div class="goalIcon">üéØ</div>
                <div class="goalLabel">Otra meta</div>
              </div>
            </div>

            <div class="hint" style="margin-top:14px;">
              üí° <b>Tip:</b> No hay l√≠mite - selecciona todas las que apliquen. Puedes no seleccionar ninguna si prefieres.
            </div>
          </div>
        </section>

        <!-- STEP 4: Finanzas (Wizard) -->
        <section class="step" data-step="4" hidden>
          <div class="panel">
            <h2>Snapshot financiero</h2>
            <p>
              Selecciona las √°reas relevantes que aplican. Agrega al menos un √≠tem en cada una.
            </p>

            <div class="wizardFlow" id="wizardFlow">
              <!-- Wizard step 1: Income range -->
              <div class="wizardStep active" data-wizard="1">
                <div class="wizardQ">
                  <b>Pregunta 1 de 5</b>
                  <h3>¬øCu√°l es tu ingreso anual aproximado (hogar)?</h3>
                  <p class="hint">Esto nos ayuda a sugerir √°reas relevantes</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="0-50k" type="button">
                    üíµ Menos de $50,000
                  </button>
                  <button class="optionBtn" data-answer="50-100k" type="button">
                    üí∞ $50,000 - $100,000
                  </button>
                  <button class="optionBtn" data-answer="100-200k" type="button">
                    üíé $100,000 - $200,000
                  </button>
                  <button class="optionBtn" data-answer="200k+" type="button">
                    üèÜ M√°s de $200,000
                  </button>
                </div>
              </div>

              <!-- Wizard step 2: Debts -->
              <div class="wizardStep" data-wizard="2">
                <div class="wizardQ">
                  <b>Pregunta 2 de 5</b>
                  <h3>¬øTienes deudas activas?</h3>
                  <p class="hint">Tarjetas, pr√©stamos, hipoteca, etc.</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="yes" type="button">
                    ‚úì S√≠, tengo deudas
                  </button>
                  <button class="optionBtn" data-answer="no" type="button">
                    ‚úó No, sin deudas actualmente
                  </button>
                </div>
              </div>

              <!-- Wizard step 3: Investments -->
              <div class="wizardStep" data-wizard="3">
                <div class="wizardQ">
                  <b>Pregunta 3 de 5</b>
                  <h3>¬øTienes inversiones o cuentas de retiro?</h3>
                  <p class="hint">401k, IRA, acciones, crypto, etc.</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="retirement" type="button">
                    üè¶ Solo retiro (401k/IRA)
                  </button>
                  <button class="optionBtn" data-answer="both" type="button">
                    üìà Retiro + otras inversiones
                  </button>
                  <button class="optionBtn" data-answer="none" type="button">
                    ‚ûñ No tengo inversiones a√∫n
                  </button>
                </div>
              </div>

              <!-- Wizard step 4: Real estate -->
              <div class="wizardStep" data-wizard="4">
                <div class="wizardQ">
                  <b>Pregunta 4 de 5</b>
                  <h3>¬øTienes propiedades (casa, terrenos, etc.)?</h3>
                  <p class="hint">Propiedades que posees o est√°s pagando</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="yes" type="button">
                    üè† S√≠, tengo propiedad(es)
                  </button>
                  <button class="optionBtn" data-answer="no" type="button">
                    ‚úó No, rento/vivo con familia
                  </button>
                </div>
              </div>

              <!-- Wizard step 5: Insurance -->
              <div class="wizardStep" data-wizard="5">
                <div class="wizardQ">
                  <b>Pregunta 5 de 9</b>
                  <h3>¬øTienes seguros activos?</h3>
                  <p class="hint">Vida, salud, auto, hogar, etc.</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="yes" type="button">
                    üõ°Ô∏è S√≠, tengo seguro(s)
                  </button>
                  <button class="optionBtn" data-answer="no" type="button">
                    ‚úó No tengo seguros
                  </button>
                </div>
              </div>

              <!-- Wizard step 6: Business/Trust -->
              <div class="wizardStep" data-wizard="6">
                <div class="wizardQ">
                  <b>Pregunta 6 de 9</b>
                  <h3>¬øTienes un negocio o trust?</h3>
                  <p class="hint">Negocio propio, LLC, partnership, trusts, etc.</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="yes" type="button">
                    üíº S√≠, tengo negocio/trust
                  </button>
                  <button class="optionBtn" data-answer="no" type="button">
                    ‚úó No tengo
                  </button>
                </div>
              </div>

              <!-- Wizard step 7: Legal -->
              <div class="wizardStep" data-wizard="7">
                <div class="wizardQ">
                  <b>Pregunta 7 de 9</b>
                  <h3>¬øTienes documentos legales importantes?</h3>
                  <p class="hint">Testamento, poderes, trusts, beneficiarios, etc.</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="yes" type="button">
                    üìÑ S√≠, tengo documentos
                  </button>
                  <button class="optionBtn" data-answer="no" type="button">
                    ‚úó No tengo / No estoy seguro
                  </button>
                </div>
              </div>

              <!-- Wizard step 8: Other Assets -->
              <div class="wizardStep" data-wizard="8">
                <div class="wizardQ">
                  <b>Pregunta 8 de 9</b>
                  <h3>¬øTienes otros activos importantes?</h3>
                  <p class="hint">Veh√≠culos, joyas, arte, colecciones, etc.</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="yes" type="button">
                    üöó S√≠, tengo otros activos
                  </button>
                  <button class="optionBtn" data-answer="no" type="button">
                    ‚úó No / Nada significativo
                  </button>
                </div>
              </div>

              <!-- Wizard step 9: Savings -->
              <div class="wizardStep" data-wizard="9">
                <div class="wizardQ">
                  <b>Pregunta 9 de 9</b>
                  <h3>¬øTienes ahorro activo?</h3>
                  <p class="hint">Fondo de emergencia, ahorros para retiro, inversiones</p>
                </div>
                
                <div class="wizardOptions">
                  <button class="optionBtn" data-answer="yes" type="button">
                    üí∞ S√≠, estoy ahorrando
                  </button>
                  <button class="optionBtn" data-answer="no" type="button">
                    ‚úó No ahorro actualmente
                  </button>
                </div>
              </div>
            </div>

            <!-- Categories detail (shown after wizard) -->
            <div id="categoriesDetail" style="display:none; margin-top:24px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <p class="hint" id="categoriesDetailHint" style="margin:0;">
                  Agrega al menos un √≠tem en cada √°rea seleccionada.
                </p>
                <button class="btn ghost" id="editWizardBtn" type="button" style="padding:8px 14px; font-size:13px;">
                  ‚Üê Editar respuestas
                </button>
              </div>
              <div class="categoriesInline" id="categoriesInline"></div>
            </div>
          </div>
        </section>

        <!-- STEP 5: Confirmaci√≥n -->
        <section class="step" data-step="5" hidden>
          <!-- VIEW 1: Before submission - Validation checklist -->
          <div id="beforeSubmit">
            <div class="panel">
              <h3>Revisi√≥n Final</h3>
              <div class="summaryGrid" id="summaryGrid"></div>
            </div>

            <div class="panel">
              <label for="finalNotes">
                ¬øAlgo que quieras que sepamos antes de la sesi√≥n?
                <span class="optional">Opcional</span>
              </label>
              <textarea id="finalNotes" 
                placeholder="Ej: Tengo una situaci√≥n especial con impuestos, me gustar√≠a enfocarnos en eso..."></textarea>
              <div class="hint">
                Esto nos ayuda a preparar mejor tu diagn√≥stico personalizado.
              </div>
            </div>

            <button class="btn primary large full" id="finalSubmit" type="button">
              Confirmar y enviar ‚Üí
            </button>
          </div>

          <!-- VIEW 2: After successful submission - Success message -->
          <div id="afterSubmit" style="display:none;">
            <div class="confirmationHero">
              <div class="checkIcon">‚úì</div>
              <h2>¬°Listo! Tu informaci√≥n ha sido enviada</h2>
              <p>Recibir√°s un email para coordinar tu sesi√≥n de diagn√≥stico</p>
            </div>

            <div class="deliverables">
              <div class="deliverableCard" style="grid-column: 1 / -1; max-width: 600px; margin: 0 auto;">
                <span class="emoji">üìÖ</span>
                <div>
                  <b>Link para agendar tu diagn√≥stico</b>
                  <p>Revisa tu email y elige el horario que mejor te funcione para tu sesi√≥n personalizada con uno de nuestros asesores</p>
                </div>
              </div>
            </div>

            <div class="panel">
              <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 12px; color: #155724;">üìß Emails enviados:</h4>
                <ul style="margin: 0; padding-left: 24px; color: #155724;">
                  <li>‚úÖ Contrato firmado (a tu email)</li>
                  <li>‚úÖ Link de Calendly para agendar (a tu email)</li>
                  <li>‚úÖ Diagn√≥stico completo (a nuestro equipo)</li>
                </ul>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="btns">
        <button class="btn ghost" type="button" id="backBtn">‚Üê Atr√°s</button>
        <button class="btn primary" type="button" id="nextBtn">Continuar ‚Üí</button>
      </div>
    </div>
  </div>

  <div class="keyboardHints" id="keyboardHints">
    <kbd>Alt</kbd> + <kbd>‚Üí</kbd> Siguiente ¬∑ 
    <kbd>Alt</kbd> + <kbd>‚Üê</kbd> Atr√°s ¬∑ 
    <kbd>Ctrl</kbd> + <kbd>S</kbd> Guardar
  </div>

<script>
(function(){
  'use strict';

  // ===== Helpers =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const uid = (prefix="id") => prefix + "_" + Math.random().toString(16).slice(2,10);

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ===== State =====
  const state = {
    mode: 'detailed',
    step: 0,  // Start at 0 for signature
    startTime: Date.now(),
    userEmail: '',
    
    signature: {
      name: '',
      signatureData: '',  // base64 image
      timestamp: '',
      ip: '',
      accepted: false,
      locked: false  // true once signed, prevents editing
    },
    
    people: {
      template: '',
      householdRole: '',
      members: []
    },

    goals: [],

    financials: {
      incomeRange: "",
      hasDebts: null,
      hasInvestments: null,
      hasRealEstate: null,
      hasInsurance: null,
      hasBusiness: null,
      hasLegal: null,
      hasOtherAssets: null,
      hasSavings: null,
      categoriesSelected: [],
      items: []
    },

    wizardStep: 1,
    wizardComplete: false,
    notes: ""
  };

  // Load from localStorage
  function loadDraft(){
    try{
      // Clean up old versions
      localStorage.removeItem('discovery_draft_v2');
      localStorage.removeItem('discovery_draft');
      
      const saved = localStorage.getItem('discovery_draft_v3');
      if(saved){
        const data = JSON.parse(saved);
        Object.assign(state, data);
        showToast('‚úì Progreso recuperado');
        
        // If contract is already signed, show locked view
        if(state.signature.locked){
          $('#signatureForm').style.display = 'none';
          $('#signatureLocked').style.display = 'block';
          populateLockedContract();
        }
      }
    } catch(e){}
  }

  // Auto-save
  let saveTimer;
  function debouncedSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      localStorage.setItem('discovery_draft_v3', JSON.stringify(state));
      const indicator = $('#autoSave');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 1500);
    }, 2000);
  }

  // Toast
  function showToast(msg){
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 2500);
  }

  // ===== Navigation =====
  const backBtn = $('#backBtn');
  const nextBtn = $('#nextBtn');

  function setStep(step){
    state.step = step;
    $$('.step').forEach(sec => sec.hidden = sec.dataset.step !== String(step));

    // If going to step 0 and contract is locked, show locked view
    if(step === 0 && state.signature.locked){
      $('#signatureForm').style.display = 'none';
      $('#signatureLocked').style.display = 'block';
      populateLockedContract();
    } else if(step === 0){
      $('#signatureForm').style.display = 'block';
      $('#signatureLocked').style.display = 'none';
    }

    // Update step circles
    $$('.stepCircle').forEach((circle, idx) => {
      const circleStep = idx;  // Now 0-5 instead of 1-5
      circle.classList.remove('completed', 'active');
      
      if(circleStep < step){
        circle.classList.add('completed');
        // Change to checkmark for completed (except signature which shows emoji)
        const numberEl = circle.querySelector('.stepNumber');
        if(circleStep === 0){
          numberEl.textContent = '‚úì';
        } else {
          numberEl.textContent = '‚úì';
        }
      } else if(circleStep === step){
        circle.classList.add('active');
        // Show original content for active
        const numberEl = circle.querySelector('.stepNumber');
        if(circleStep === 0){
          numberEl.textContent = 'üñäÔ∏è';
        } else {
          numberEl.textContent = circleStep;
        }
      } else {
        // Show original content for future steps
        const numberEl = circle.querySelector('.stepNumber');
        if(circleStep === 0){
          numberEl.textContent = 'üñäÔ∏è';
        } else {
          numberEl.textContent = circleStep;
        }
      }
    });

    // Progress text
    const elapsed = Math.floor((Date.now() - state.startTime) / 60000);
    const remaining = Math.max(1, 10 - elapsed);
    
    if(step === 0){
      $('#progressText').textContent = 'Firma del contrato';
    } else {
      $('#progressText').textContent = `Paso ${step} de 5 ¬∑ ~${remaining} min restantes`;
    }

    // Buttons
    backBtn.hidden = step === 0;
    nextBtn.hidden = step === 5;

    // Step-specific
    if(step === 2) renderPeople();
    if(step === 3) renderGoals();
    if(step === 4) renderWizard();
    if(step === 5) renderConfirmation();

    updateNavValidity();
    debouncedSave();
  }

  function updateNavValidity(){
    // Free navigation - don't block! Just update button state for current step
    let canNext = true;
    
    if(state.step === 0){
      canNext = validateSignature();
    }
    if(state.step === 1){
      const email = $('#userEmail').value.trim();
      canNext = email && email.includes('@') && email.includes('.');
    }
    // Steps 2-4: Allow navigation even if incomplete
    // Only validate at final submission (step 5)
    
    nextBtn.disabled = !canNext;
  }

  backBtn.addEventListener('click', () => {
    if(state.step > 0) setStep(state.step - 1);
  });

  nextBtn.addEventListener('click', async () => {
    if(state.step === 0 && !validateSignature()){
      showToast('‚ùå Por favor completa tu nombre, firma y acepta los t√©rminos');
      return;
    }
    if(state.step === 0){
      // Capture signature and LOCK IT
      state.signature.name = signatureName.value.trim();
      state.signature.signatureData = signatureCanvas.toDataURL('image/png');
      state.signature.timestamp = new Date().toISOString();
      state.signature.ip = await getUserIP();
      state.signature.accepted = acceptTerms.checked;
      state.signature.locked = true; // Mark as locked
      
      // Hide form, show locked view
      $('#signatureForm').style.display = 'none';
      $('#signatureLocked').style.display = 'block';
      
      // Populate locked view
      populateLockedContract();
      
      debouncedSave();
      showToast('‚úÖ Contrato firmado y sellado correctamente');
    }
    if(state.step === 1){
      const email = $('#userEmail').value.trim();
      if(!email || !email.includes('@') || !email.includes('.')){
        showToast('‚ùå Por favor ingresa un email v√°lido');
        return;
      }
      state.userEmail = email;
    }
    // No validation for steps 2-4 - allow free navigation!
    if(state.step < 5) setStep(state.step + 1);
  });

  // Populate locked contract view
  function populateLockedContract() {
    $('#lockedName').textContent = state.signature.name;
    $('#lockedEmail').textContent = state.userEmail || 'Pendiente';
    $('#lockedIP').textContent = state.signature.ip;
    
    // Format timestamp
    const date = new Date(state.signature.timestamp);
    $('#lockedTimestamp').textContent = date.toLocaleString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    $('#contractDateLocked').textContent = date.toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Show signature image
    $('#lockedSignatureImg').src = state.signature.signatureData;
  }

  // Download contract button
  $('#downloadContractBtn').addEventListener('click', () => {
    // Create a simple HTML page with the contract
    const contractHTML = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contrato Firmado - ${state.signature.name}</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
    h1 { color: #3956E8; text-align: center; }
    h2 { color: #3956E8; margin-top: 30px; }
    .signature-box { background: #d4edda; padding: 20px; border-radius: 8px; border-left: 4px solid #22c55e; margin: 20px 0; }
    .signature-box p { margin: 8px 0; }
    img { max-width: 300px; display: block; margin: 20px auto; border: 2px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h1>Consentimiento y Acuerdo de Servicio</h1>
  <h2>Discovery ¬∑ Diagn√≥stico Financiero</h2>
  
  <div class="signature-box">
    <p><strong>Firmante:</strong> ${state.signature.name}</p>
    <p><strong>Fecha:</strong> ${$('#lockedTimestamp').textContent}</p>
    <p><strong>IP:</strong> ${state.signature.ip}</p>
    <p><strong>Email:</strong> ${state.userEmail}</p>
  </div>
  
  <h2>T√©rminos del Contrato</h2>
  ${$('#contractFullText .contractText').innerHTML}
  
  <h2>Firma Digital</h2>
  <img src="${state.signature.signatureData}" alt="Firma" />
  
  <p style="text-align: center; color: #666; font-size: 12px; margin-top: 40px;">
    Este documento ha sido generado electr√≥nicamente y es v√°lido sin firma f√≠sica adicional.
  </p>
</body>
</html>
    `;
    
    // Download as HTML
    const blob = new Blob([contractHTML], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Contrato-Firmado-${state.signature.name.replace(/\s+/g, '-')}-${Date.now()}.html`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    
    showToast('‚úÖ Contrato descargado exitosamente');
  });

  // View contract text button
  $('#viewContractTextBtn').addEventListener('click', () => {
    const textDiv = $('#contractFullText');
    if (textDiv.style.display === 'none') {
      textDiv.style.display = 'block';
      $('#viewContractTextBtn').textContent = 'üîº Ocultar Texto';
    } else {
      textDiv.style.display = 'none';
      $('#viewContractTextBtn').textContent = 'üìÑ Ver Texto Completo';
    }
  });

  // ===== FREE NAVIGATION: Click on step circles to jump =====
  $$('.stepCircle').forEach(circle => {
    circle.addEventListener('click', () => {
      const targetStep = parseInt(circle.dataset.goto);
      
      // Block if trying to skip signature step when not signed
      if(targetStep > 0 && !state.signature.locked){
        showToast('‚ö†Ô∏è Por favor firma el contrato primero');
        return;
      }
      
      // Allow navigation to step 0 to VIEW locked contract
      // Allow free navigation to any other step
      setStep(targetStep);
    });
  });

  // ===== Validation =====
  function validatePeople(){
    const m = state.people.members;
    const primary = m[0];

    const baseOk =
      primary.firstName?.trim() &&
      primary.lastName?.trim() &&
      Number.isInteger(primary.age) && primary.age > 0 &&
      ["male","female","prefer_not_to_say"].includes(primary.gender);

    if(!baseOk) return { ok:false };

    if(m.length > 1){
      for(let i=1; i<m.length; i++){
        const p = m[i];
        const okp =
          p.firstName?.trim() &&
          p.lastName?.trim() &&
          Number.isInteger(p.age) && p.age > 0 &&
          ["male","female","prefer_not_to_say"].includes(p.gender) &&
          p.relationshipToPrimary;
        if(!okp) return { ok:false };
      }
    }
    return { ok:true };
  }

  function validateFinancials(){
    if(!state.wizardComplete) return { ok:false };
    const selected = state.financials.categoriesSelected;
    if(selected.length === 0) return { ok:false };

    for(const catKey of selected){
      const items = state.financials.items.filter(it => it.category === catKey);
      if(items.length === 0) return { ok:false };
    }
    return { ok:true };
  }

  // ===== STEP 0: Signature =====
  const signatureCanvas = $('#signatureCanvas');
  const signatureCtx = signatureCanvas.getContext('2d');
  const signatureName = $('#signatureName');
  const acceptTerms = $('#acceptTerms');
  const clearSignatureBtn = $('#clearSignature');
  
  let isDrawing = false;
  let hasSignature = false;

  // Set canvas size properly for high DPI
  function initCanvas() {
    const canvas = signatureCanvas;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * 2;
    canvas.height = rect.height * 2;
    signatureCtx.scale(2, 2);
    signatureCtx.strokeStyle = '#0F172A';
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.lineJoin = 'round';
  }

  initCanvas();

  // Drawing functions
  function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    signatureCtx.beginPath();
    signatureCtx.moveTo(x, y);
  }

  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const rect = signatureCanvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    signatureCtx.lineTo(x, y);
    signatureCtx.stroke();
    hasSignature = true;
  }

  function stopDrawing() {
    isDrawing = false;
    validateSignature();
  }

  // Mouse events
  signatureCanvas.addEventListener('mousedown', startDrawing);
  signatureCanvas.addEventListener('mousemove', draw);
  signatureCanvas.addEventListener('mouseup', stopDrawing);
  signatureCanvas.addEventListener('mouseout', stopDrawing);

  // Touch events
  signatureCanvas.addEventListener('touchstart', startDrawing);
  signatureCanvas.addEventListener('touchmove', draw);
  signatureCanvas.addEventListener('touchend', stopDrawing);

  // Clear signature
  clearSignatureBtn.addEventListener('click', () => {
    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    hasSignature = false;
    validateSignature();
  });

  // Input listeners
  signatureName.addEventListener('input', validateSignature);
  acceptTerms.addEventListener('change', validateSignature);

  function validateSignature() {
    const nameOk = signatureName.value.trim().length > 2;
    const termsOk = acceptTerms.checked;
    const signatureOk = hasSignature;
    
    if (state.step === 0) {
      nextBtn.disabled = !(nameOk && termsOk && signatureOk);
    }
    
    return nameOk && termsOk && signatureOk;
  }

  // Get user IP
  async function getUserIP() {
    try {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      $('#userIP').textContent = data.ip;
      return data.ip;
    } catch (e) {
      $('#userIP').textContent = 'N/A';
      return 'N/A';
    }
  }

  // Set contract date
  $('#contractDate').textContent = new Date().toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  // Get IP on load
  getUserIP();

  // ===== STEP 1: Email =====
  const userEmailInput = $('#userEmail');
  userEmailInput.addEventListener('input', () => {
    state.userEmail = userEmailInput.value.trim();
    updateNavValidity();
    debouncedSave();
  });

  // Restore email on load
  if(state.userEmail){
    userEmailInput.value = state.userEmail;
  }

  // ===== STEP 2: People =====
  const TEMPLATES = {
    single: {
      members: [
        { id:"p1", role:"primary", firstName:"", lastName:"", age:null, gender:"" }
      ],
      householdRole: "primary_provider"
    },
    couple: {
      members: [
        { id:"p1", role:"primary", firstName:"", lastName:"", age:null, gender:"" },
        { id:"p2", role:"additional", firstName:"", lastName:"", age:null, gender:"", relationshipToPrimary:"spouse" }
      ],
      householdRole: "shared"
    },
    family: {
      members: [
        { id:"p1", role:"primary", firstName:"", lastName:"", age:null, gender:"" },
        { id:"p2", role:"additional", firstName:"", lastName:"", age:null, gender:"", relationshipToPrimary:"spouse" },
        { id:"p3", role:"additional", firstName:"", lastName:"", age:null, gender:"", relationshipToPrimary:"child" }
      ],
      householdRole: "shared"
    }
  };

  $$('.templateBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const template = btn.dataset.template;
      
      $$('.templateBtn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');

      if(template !== 'custom'){
        state.people = JSON.parse(JSON.stringify(TEMPLATES[template]));
        state.people.template = template;
      } else {
        state.people.template = 'custom';
      }
      
      renderPeople();
      debouncedSave();
    });
  });

  const householdRoleEl = $('#householdRole');
  const peopleWrap = $('#peopleWrap');
  const addPersonBtn = $('#addPersonBtn');

  function renderPeople(){
    peopleWrap.innerHTML = '';
    const members = state.people.members;

    members.forEach((p, idx) => {
      const isPrimary = idx === 0;

      const card = document.createElement('div');
      card.className = 'personCard';

      const head = document.createElement('div');
      head.className = 'personHead';
      head.innerHTML = `
        <div class="tag">${isPrimary ? 'Persona principal' : 'Persona adicional'}</div>
        ${!isPrimary ? `<button class="xbtn" type="button">√ó</button>` : '<span class="hint">Obligatorio</span>'}
      `;
      card.appendChild(head);

      const requiredFields = ['firstName', 'lastName', 'age', 'gender'];

      const row1 = document.createElement('div');
      row1.className = 'row';
      
      if(requiredFields.includes('firstName')){
        row1.innerHTML += `
          <div class="field">
            <label>Nombre *</label>
            <input type="text" data-k="firstName" value="${escapeHtml(p.firstName||'')}" placeholder="Nombre" />
          </div>
        `;
      }
      
      if(requiredFields.includes('lastName')){
        row1.innerHTML += `
          <div class="field">
            <label>Apellido *</label>
            <input type="text" data-k="lastName" value="${escapeHtml(p.lastName||'')}" placeholder="Apellido" />
          </div>
        `;
      }
      
      card.appendChild(row1);

      const row2 = document.createElement('div');
      row2.className = 'row';
      
      if(requiredFields.includes('age')){
        row2.innerHTML += `
          <div class="field">
            <label>Edad *</label>
            <input type="number" min="0" step="1" data-k="age" value="${p.age ?? ''}" placeholder="35" />
          </div>
        `;
      }
      
      if(requiredFields.includes('gender')){
        row2.innerHTML += `
          <div class="field">
            <label>Sexo *</label>
            <select data-k="gender">
              <option value="">Selecciona‚Ä¶</option>
              <option value="male" ${p.gender==='male'?'selected':''}>Masculino</option>
              <option value="female" ${p.gender==='female'?'selected':''}>Femenino</option>
              <option value="prefer_not_to_say" ${p.gender==='prefer_not_to_say'?'selected':''}>Prefiero no decir</option>
            </select>
          </div>
        `;
      }
      
      card.appendChild(row2);

      if(!isPrimary){
        const rel = document.createElement('div');
        rel.className = 'field';
        rel.innerHTML = `
          <label>Relaci√≥n con persona principal *</label>
          <select data-k="relationshipToPrimary">
            <option value="">Selecciona‚Ä¶</option>
            <option value="spouse" ${p.relationshipToPrimary==='spouse'?'selected':''}>C√≥nyuge</option>
            <option value="partner" ${p.relationshipToPrimary==='partner'?'selected':''}>Pareja</option>
            <option value="child" ${p.relationshipToPrimary==='child'?'selected':''}>Hijo/a</option>
            <option value="family" ${p.relationshipToPrimary==='family'?'selected':''}>Familiar</option>
            <option value="other" ${p.relationshipToPrimary==='other'?'selected':''}>Otro</option>
          </select>
        `;
        card.appendChild(rel);
      }

      // Events
      card.addEventListener('input', (e) => {
        const t = e.target;
        const key = t.getAttribute('data-k');
        if(!key) return;

        const person = state.people.members.find(x => x.id === p.id);
        if(!person) return;

        if(key === 'age'){
          const n = Number(t.value);
          person.age = Number.isFinite(n) ? Math.trunc(n) : null;
        } else {
          person[key] = t.value;
        }

        updateNavValidity();
        debouncedSave();
      });

      if(!isPrimary){
        const xbtn = $('.xbtn', head);
        if(xbtn){
          xbtn.addEventListener('click', () => {
            state.people.members = state.people.members.filter(x => x.id !== p.id);
            renderPeople();
            updateNavValidity();
            debouncedSave();
          });
        }
      }

      peopleWrap.appendChild(card);
    });

    householdRoleEl.value = state.people.householdRole || '';
    
    // Select template button
    if(state.people.template){
      const templateBtn = $(`.templateBtn[data-template="${state.people.template}"]`);
      if(templateBtn){
        $$('.templateBtn').forEach(b => b.classList.remove('selected'));
        templateBtn.classList.add('selected');
      }
    }
    
    updateNavValidity();
  }

  householdRoleEl.addEventListener('change', () => {
    state.people.householdRole = householdRoleEl.value;
    debouncedSave();
  });

  addPersonBtn.addEventListener('click', () => {
    const nextIndex = state.people.members.length + 1;
    state.people.members.push({
      id: "p" + nextIndex,
      role: "additional",
      firstName:"",
      lastName:"",
      age:null,
      gender:"",
      relationshipToPrimary:""
    });
    renderPeople();
    debouncedSave();
  });

  // ===== STEP 3: Goals =====
  function renderGoals(){
    const goalCards = $$('.goalCard');
    
    // Restore selected state
    goalCards.forEach(card => {
      const goal = card.dataset.goal;
      if(state.goals.includes(goal)){
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    });
  }
  
  // Handle goal selection (only add listeners once)
  $$('.goalCard').forEach(card => {
    // Remove old listeners by cloning
    const newCard = card.cloneNode(true);
    card.parentNode.replaceChild(newCard, card);
    
    newCard.addEventListener('click', () => {
      const goal = newCard.dataset.goal;
      
      if(newCard.classList.contains('selected')){
        // Deselect
        newCard.classList.remove('selected');
        state.goals = state.goals.filter(g => g !== goal);
      } else {
        // Select
        newCard.classList.add('selected');
        state.goals.push(goal);
      }
      
      debouncedSave();
    });
  });

  // ===== STEP 4: Wizard =====
  const CATEGORY_SUGGESTIONS = {
    '0-50k': ['income', 'expenses', 'banking', 'liabilities', 'other_assets'],
    '50-100k': ['income', 'expenses', 'savings', 'banking', 'liabilities', 'investments_retirement', 'other_assets'],
    '100-200k': ['income', 'expenses', 'savings', 'banking', 'investments_retirement', 'investments_nonretirement', 'real_estate', 'insurance', 'other_assets'],
    '200k+': ['income', 'expenses', 'savings', 'banking', 'investments_retirement', 'investments_nonretirement', 'real_estate', 'insurance', 'business_trust', 'legal', 'other_assets']
  };

  const FIN_CATS = [
    { key:"income", label:"Ingresos", hint:"Salarios, negocios, rentas" },
    { key:"expenses", label:"Gastos mensuales", hint:"Desglose de gastos por categor√≠a" },
    { key:"savings", label:"Ahorro", hint:"Ahorro activo mensual" },
    { key:"liabilities", label:"Deudas", hint:"Tarjetas, pr√©stamos, hipoteca" },
    { key:"real_estate", label:"Bienes ra√≠ces", hint:"Propiedades que posees" },
    { key:"investments_retirement", label:"Inversiones de retiro", hint:"401k, IRA, pensi√≥n" },
    { key:"investments_nonretirement", label:"Otras inversiones", hint:"Acciones, crypto, fondos" },
    { key:"banking", label:"Cuentas bancarias", hint:"Checking, savings, cash" },
    { key:"insurance", label:"Seguros", hint:"Vida, salud, auto, hogar" },
    { key:"business_trust", label:"Negocios/Trust", hint:"Empresas, LLC, trusts" },
    { key:"legal", label:"Legal", hint:"Testamento, poderes" },
    { key:"other_assets", label:"Otros activos", hint:"Autos, colecciones, etc." }
  ];

  // Expenses taxonomy
  const EXPENSES_TAX = {
    "Alimentaci√≥n": ["Supermercado", "Comidas fuera", "Pedido a domicilio"],
    "Casa": ["Alquiler", "Servicios b√°sicos", "Mantenimiento"],
    "Impuestos": ["Seguro social", "Propiedad", "Venta", "Estatales", "Federales", "Municipales"],
    "Transportaci√≥n": ["Gasolina", "Mantenimiento", "Transporte p√∫blico / Uber"],
    "Seguros": ["Salud", "Auto", "Vida"],
    "Regalos y donaciones": ["Familia", "Amigos", "Instituciones"],
    "Gastos M√©dicos": ["Consultas", "Medicamentos", "Procedimientos"],
    "Cuidado Personal": ["Peluquer√≠a", "Cosm√©ticos", "Spa / Barber√≠a"],
    "Dependientes": ["Cuidado de ni√±os", "Cuidado de mayores", "Educaci√≥n"],
    "Deuda": ["Tarjetas de cr√©dito", "Pr√©stamos estudiantiles", "Otros pr√©stamos"],
    "Entretenimiento": ["Cine", "Conciertos", "Streaming"],
    "Telecomunicaciones": ["Tel√©fono", "Internet", "TV"]
  };

  // Savings taxonomy
  const SAVINGS_TAX = {
    "Reserva de emergencia": ["Dep√≥sito", "Aporte mensual"],
    "Retiro": ["401(k)", "IRA/Roth", "Otro"],
    "Inversi√≥n": ["Brokerage", "ETF/Fondos", "Cripto", "Otro"],
    "Otro": ["Otro"]
  };

  // Income types
  const INCOME_TYPES = [
    "Salario",
    "Pago por hora",
    "Bono",
    "Comisi√≥n",
    "Propina",
    "Negocio propio",
    "Dividendos e intereses",
    "Renta inmueble",
    "Pensi√≥n",
    "Seguro Social",
    "Anualidad",
    "Ganancia de capital",
    "Otro"
  ];

  // Debt types
  const DEBT_TYPES = [
    "Tarjeta de cr√©dito",
    "Pr√©stamo de auto",
    "Pr√©stamo estudiantil",
    "Hipoteca",
    "HELOC (l√≠nea de cr√©dito)",
    "Pr√©stamo personal",
    "Pr√©stamo de negocio",
    "Impuestos adeudados",
    "Otro"
  ];

  // Banking types
  const BANKING_TYPES = [
    "Checking",
    "Savings",
    "Money Market",
    "CD (Certificate of Deposit)",
    "Efectivo",
    "Otro"
  ];

  // Retirement investment types
  const RETIREMENT_TYPES = [
    "401(k)",
    "403(b)",
    "457",
    "IRA Tradicional",
    "Roth IRA",
    "SEP IRA",
    "Pensi√≥n",
    "Anualidad",
    "Otro"
  ];

  // Non-retirement investment types
  const INVESTMENT_TYPES = [
    "Brokerage account",
    "Acciones individuales",
    "ETF/Fondos mutuos",
    "Bonos",
    "Criptomonedas",
    "Commodities",
    "Otro"
  ];

  // Real estate types
  const REAL_ESTATE_TYPES = [
    "Casa principal",
    "Casa vacacional",
    "Propiedad de renta",
    "Apartamento/Condo",
    "Terreno",
    "Propiedad comercial",
    "Otro"
  ];

  // Insurance types
  const INSURANCE_TYPES = [
    "Vida - Term",
    "Vida - Whole/Universal",
    "Salud",
    "Auto",
    "Hogar/Renta",
    "Disability",
    "Long-term care",
    "Umbrella",
    "Otro"
  ];

  // Business/Trust types
  const BUSINESS_TYPES = [
    "Negocio propio (100%)",
    "Negocio (participaci√≥n)",
    "LLC",
    "S-Corp",
    "C-Corp",
    "Partnership",
    "Trust",
    "Otro"
  ];

  // Legal types
  const LEGAL_TYPES = [
    "Testamento",
    "Living Trust",
    "Revocable Trust",
    "Irrevocable Trust",
    "Power of Attorney",
    "Healthcare Directive",
    "Beneficiarios designados",
    "Otro"
  ];

  // Other assets types
  const OTHER_ASSETS_TYPES = [
    "Veh√≠culo",
    "Bote/Jet ski",
    "RV/Camper",
    "Joyas",
    "Arte",
    "Coleccionables",
    "Equipamiento profesional",
    "Otro"
  ];

  function renderWizard(){
    const wizardFlow = $('#wizardFlow');
    const categoriesDetail = $('#categoriesDetail');

    if(state.wizardComplete){
      wizardFlow.style.display = 'none';
      categoriesDetail.style.display = 'block';
      renderCategoriesDetail();
    } else {
      wizardFlow.style.display = 'block';
      categoriesDetail.style.display = 'none';
      
      // Show current wizard step
      $$('.wizardStep').forEach((step, idx) => {
        step.classList.toggle('active', idx + 1 === state.wizardStep);
      });
    }
  }

  // Wizard navigation
  $$('.wizardStep').forEach((step, stepIndex) => {
    const stepNum = stepIndex + 1;
    
    step.querySelectorAll('.optionBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const answer = btn.dataset.answer;
        
        // Store answer
        if(stepNum === 1){
          state.financials.incomeRange = answer;
          const suggested = CATEGORY_SUGGESTIONS[answer] || [];
          state.financials.categoriesSelected = [...suggested];
        }
        if(stepNum === 2){
          state.financials.hasDebts = answer === 'yes';
          if(answer === 'yes' && !state.financials.categoriesSelected.includes('liabilities')){
            state.financials.categoriesSelected.push('liabilities');
          }
        }
        if(stepNum === 3){
          state.financials.hasInvestments = answer;
          if(answer === 'retirement' && !state.financials.categoriesSelected.includes('investments_retirement')){
            state.financials.categoriesSelected.push('investments_retirement');
          }
          if(answer === 'both'){
            if(!state.financials.categoriesSelected.includes('investments_retirement')){
              state.financials.categoriesSelected.push('investments_retirement');
            }
            if(!state.financials.categoriesSelected.includes('investments_nonretirement')){
              state.financials.categoriesSelected.push('investments_nonretirement');
            }
          }
        }
        if(stepNum === 4){
          state.financials.hasRealEstate = answer === 'yes';
          if(answer === 'yes' && !state.financials.categoriesSelected.includes('real_estate')){
            state.financials.categoriesSelected.push('real_estate');
          }
        }
        if(stepNum === 5){
          state.financials.hasInsurance = answer === 'yes';
          if(answer === 'yes' && !state.financials.categoriesSelected.includes('insurance')){
            state.financials.categoriesSelected.push('insurance');
          }
        }
        if(stepNum === 6){
          state.financials.hasBusiness = answer === 'yes';
          if(answer === 'yes' && !state.financials.categoriesSelected.includes('business_trust')){
            state.financials.categoriesSelected.push('business_trust');
          }
        }
        if(stepNum === 7){
          state.financials.hasLegal = answer === 'yes';
          if(answer === 'yes' && !state.financials.categoriesSelected.includes('legal')){
            state.financials.categoriesSelected.push('legal');
          }
        }
        if(stepNum === 8){
          state.financials.hasOtherAssets = answer === 'yes';
          if(answer === 'yes' && !state.financials.categoriesSelected.includes('other_assets')){
            state.financials.categoriesSelected.push('other_assets');
          }
        }
        if(stepNum === 9){
          state.financials.hasSavings = answer === 'yes';
          if(answer === 'yes' && !state.financials.categoriesSelected.includes('savings')){
            state.financials.categoriesSelected.push('savings');
          }
        }

        debouncedSave();

        // Next step or finish
        if(stepNum < 9){
          state.wizardStep = stepNum + 1;
          renderWizard();
        } else {
          state.wizardComplete = true;
          state.wizardStep = 1;
          renderWizard();
          updateNavValidity();
        }
      });
    });
  });

  function renderCategoriesDetail(){
    const container = $('#categoriesInline');
    const hintEl = $('#categoriesDetailHint');
    
    // Update hint based on household size
    const people = state.people.members || [];
    if(people.length > 1){
      hintEl.innerHTML = `
        Agrega al menos un √≠tem en cada √°rea seleccionada. 
        <b>Tip:</b> Puedes agregar el mismo tipo varias veces (ej: Checking de Carlos, Checking de Mar√≠a, Checking conjunta) 
        seleccionando el due√±o correspondiente.
      `;
    } else {
      hintEl.textContent = 'Agrega al menos un √≠tem en cada √°rea seleccionada.';
    }
    
    container.innerHTML = '';

    state.financials.categoriesSelected.forEach(catKey => {
      const meta = FIN_CATS.find(c => c.key === catKey);
      if(!meta) return;

      const card = document.createElement('div');
      card.className = 'catInlineCard';
      card.dataset.cat = catKey;

      const items = state.financials.items.filter(it => it.category === catKey);
      const hasItems = items.length > 0;

      const isExpenseOrSaving = catKey === 'expenses' || catKey === 'savings';

      card.innerHTML = `
        <div class="catHeader">
          <div class="catInfo">
            <input type="checkbox" data-category-checkbox checked />
            <div class="catLabel">
              <b>${escapeHtml(meta.label)}</b>
              <span>${escapeHtml(meta.hint)}</span>
            </div>
          </div>
          <div class="catExpand">‚ñæ</div>
        </div>
        <div class="catBody">
          ${isExpenseOrSaving ? renderExpenseSavingsForm(catKey) : renderStandardForm(catKey)}
          <div class="itemsList" data-items></div>
        </div>
      `;

      // Mark card as checked since category was selected
      card.classList.add('checked');

      // Checkbox handler
      const checkbox = card.querySelector('[data-category-checkbox]');
      checkbox.addEventListener('change', (e) => {
        e.stopPropagation();
        if(checkbox.checked){
          card.classList.add('checked');
        } else {
          card.classList.remove('checked');
        }
      });

      // Toggle expand
      card.querySelector('.catHeader').addEventListener('click', (e) => {
        if(e.target.tagName === 'INPUT') return;
        card.classList.toggle('open');
      });

      const itemsList = card.querySelector('[data-items]');

      if(isExpenseOrSaving){
        setupExpenseSavingsHandlers(card, catKey, itemsList);
      } else {
        setupStandardHandlers(card, catKey, itemsList);
      }

      renderItemsList(catKey, itemsList);

      container.appendChild(card);

      // Auto-open if no items
      if(!hasItems){
        card.classList.add('open');
      }
    });
  }

  function renderStandardForm(catKey){
    const typeOptions = getTypeOptionsForCategory(catKey);
    const people = state.people.members || [];
    const showOwner = people.length > 1;
    
    if(!showOwner){
      return `
        <div class="standardAddRow">
          <select data-type-select>
            <option value="">Tipo...</option>
            ${typeOptions.map(type => `<option value="${escapeHtml(type)}">${escapeHtml(type)}</option>`).join('')}
          </select>
          <input type="text" placeholder="Alias (opcional)" data-alias-input />
          <input type="number" min="0" step="0.01" placeholder="$ USD" data-add-amount />
          <button type="button" data-add-btn>+</button>
        </div>
      `;
    }
    
    // Multi-person household: show owner selector
    return `
      <div class="standardAddRowMulti">
        <select data-type-select>
          <option value="">Tipo...</option>
          ${typeOptions.map(type => `<option value="${escapeHtml(type)}">${escapeHtml(type)}</option>`).join('')}
        </select>
        <input type="text" placeholder="Alias (opcional)" data-alias-input />
        <input type="number" min="0" step="0.01" placeholder="$ USD" data-add-amount />
        <select data-owner-select>
          ${ownerOptionsHTML('')}
        </select>
        <button type="button" data-add-btn>+</button>
      </div>
    `;
  }

  function ownerOptionsHTML(current){
    const people = state.people.members || [];
    let html = `<option value="">Due√±o...</option>`;
    for(const p of people){
      const name = ([p.firstName,p.lastName].filter(Boolean).join(" ").trim() || p.id.toUpperCase());
      html += `<option value="${p.id}" ${current===p.id?"selected":""}>${escapeHtml(name)}</option>`;
    }
    html += `<option value="household" ${current==="household"?"selected":""}>Compartido</option>`;
    return html;
  }

  function getTypeOptionsForCategory(catKey){
    const typeMap = {
      'income': INCOME_TYPES,
      'liabilities': DEBT_TYPES,
      'banking': BANKING_TYPES,
      'investments_retirement': RETIREMENT_TYPES,
      'investments_nonretirement': INVESTMENT_TYPES,
      'real_estate': REAL_ESTATE_TYPES,
      'insurance': INSURANCE_TYPES,
      'business_trust': BUSINESS_TYPES,
      'legal': LEGAL_TYPES,
      'other_assets': OTHER_ASSETS_TYPES
    };
    
    return typeMap[catKey] || ['Otro'];
  }

  function renderExpenseSavingsForm(catKey){
    const taxonomy = catKey === 'expenses' ? EXPENSES_TAX : SAVINGS_TAX;
    const people = state.people.members || [];
    const showOwner = people.length > 1;
    
    // Flatten taxonomy into single list
    const options = [];
    for(const [category, subcategories] of Object.entries(taxonomy)){
      for(const subcategory of subcategories){
        options.push({ category, subcategory, label: `${category} - ${subcategory}` });
      }
    }
    
    if(!showOwner){
      return `
        <div class="expenseAddRow">
          <select data-combined-select>
            <option value="">Selecciona categor√≠a...</option>
            ${options.map(opt => {
              const value = JSON.stringify({ category: opt.category, subcategory: opt.subcategory });
              return `<option value='${escapeHtml(value)}'>${escapeHtml(opt.label)}</option>`;
            }).join('')}
          </select>
          <input type="number" min="0" step="0.01" placeholder="$/mes" data-add-amount />
          <button type="button" data-add-btn>+</button>
        </div>
      `;
    }
    
    return `
      <div class="expenseAddRowMulti">
        <select data-combined-select>
          <option value="">Selecciona categor√≠a...</option>
          ${options.map(opt => {
            const value = JSON.stringify({ category: opt.category, subcategory: opt.subcategory });
            return `<option value='${escapeHtml(value)}'>${escapeHtml(opt.label)}</option>`;
          }).join('')}
        </select>
        <input type="number" min="0" step="0.01" placeholder="$/mes" data-add-amount />
        <select data-owner-select>
          ${ownerOptionsHTML('')}
        </select>
        <button type="button" data-add-btn>+</button>
      </div>
    `;
  }

  function setupStandardHandlers(card, catKey, itemsList){
    const addBtn = card.querySelector('[data-add-btn]');
    const typeSelect = card.querySelector('[data-type-select]');
    const aliasInput = card.querySelector('[data-alias-input]');
    const amountInput = card.querySelector('[data-add-amount]');
    const ownerSelect = card.querySelector('[data-owner-select]');

    function addItem(){
      const type = typeSelect.value.trim();
      const alias = aliasInput.value.trim();
      const amount = Number(amountInput.value);

      if(!type || !Number.isFinite(amount) || amount < 0) return;

      // Determine owner
      let owner;
      if(ownerSelect){
        owner = ownerSelect.value || 'household';
      } else {
        owner = state.people.members.length > 1 ? 'household' : state.people.members[0].id;
      }

      // Use alias if provided, otherwise use type
      const displayName = alias || type;

      const item = {
        id: uid(catKey),
        category: catKey,
        type: type,
        alias: alias || null,
        name: displayName,
        value: amount,
        owner: owner
      };

      state.financials.items.push(item);
      typeSelect.value = '';
      aliasInput.value = '';
      amountInput.value = '';
      if(ownerSelect) ownerSelect.value = '';
      
      renderItemsList(catKey, itemsList);
      updateNavValidity();
      debouncedSave();
    }

    addBtn.addEventListener('click', addItem);
    amountInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') addItem();
    });
  }

  function setupExpenseSavingsHandlers(card, catKey, itemsList){
    const combinedSelect = card.querySelector('[data-combined-select]');
    const amountInput = card.querySelector('[data-add-amount]');
    const addBtn = card.querySelector('[data-add-btn]');
    const ownerSelect = card.querySelector('[data-owner-select]');

    function addItem(){
      const selectedValue = combinedSelect.value;
      const amount = Number(amountInput.value);

      if(!selectedValue || !Number.isFinite(amount) || amount < 0) return;

      const { category, subcategory } = JSON.parse(selectedValue);

      // Determine owner
      let owner;
      if(ownerSelect){
        owner = ownerSelect.value || 'household';
      } else {
        owner = state.people.members.length > 1 ? 'household' : state.people.members[0].id;
      }

      const item = {
        id: uid(catKey),
        category: catKey,
        expenseCategory: category,
        subcategory: subcategory,
        name: `${category} - ${subcategory}`,
        value: amount,
        owner: owner
      };

      state.financials.items.push(item);
      combinedSelect.value = '';
      amountInput.value = '';
      if(ownerSelect) ownerSelect.value = '';
      
      renderItemsList(catKey, itemsList);
      updateNavValidity();
      debouncedSave();
    }

    addBtn.addEventListener('click', addItem);
    amountInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') addItem();
    });
  }

  function renderItemsList(catKey, container){
    const items = state.financials.items.filter(it => it.category === catKey);
    
    container.innerHTML = items.map(it => {
      const owner = state.people.members.find(p => p.id === it.owner);
      const ownerName = owner ? `${owner.firstName || owner.id}` : 'Hogar';
      
      // For expenses/savings show category-subcategory, for others show type
      let displayName = it.name;
      let typeInfo = '';
      
      if(it.type && it.alias){
        // Has both type and alias
        typeInfo = `${it.type}`;
        displayName = it.alias;
      } else if(it.type){
        // Only type
        displayName = it.type;
      }
      
      return `
        <div class="itemChip" data-id="${it.id}">
          <div class="chipInfo">
            <div class="chipName">${escapeHtml(displayName)}${typeInfo ? ` <span style="color:var(--muted);font-size:11px;">(${escapeHtml(typeInfo)})</span>` : ''}</div>
            <div class="chipDetails">$${it.value?.toLocaleString() || 0} ¬∑ ${ownerName}</div>
          </div>
          <button class="chipRemove" type="button">√ó</button>
        </div>
      `;
    }).join('');

    // Remove handlers
    container.querySelectorAll('.chipRemove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const chip = e.target.closest('.itemChip');
        const id = chip.dataset.id;
        state.financials.items = state.financials.items.filter(it => it.id !== id);
        renderItemsList(catKey, container);
        updateNavValidity();
        debouncedSave();
      });
    });
  }

  // Edit wizard button
  const editWizardBtn = $('#editWizardBtn');
  editWizardBtn.addEventListener('click', () => {
    // Reset wizard to beginning
    state.wizardStep = 1;
    state.wizardComplete = false;
    
    // Clear selected categories and items
    state.financials.categoriesSelected = [];
    state.financials.items = [];
    
    // Reset all wizard answers
    state.financials.incomeRange = "";
    state.financials.hasDebts = null;
    state.financials.hasInvestments = null;
    state.financials.hasRealEstate = null;
    state.financials.hasInsurance = null;
    state.financials.hasBusiness = null;
    state.financials.hasLegal = null;
    state.financials.hasOtherAssets = null;
    state.financials.hasSavings = null;
    
    renderWizard();
    debouncedSave();
    showToast('Wizard reiniciado - puedes editar tus respuestas');
  });

  // ===== STEP 5: Confirmation =====
  const finalNotesEl = $('#finalNotes');
  const finalSubmitBtn = $('#finalSubmit');
  const summaryGrid = $('#summaryGrid');

  function renderConfirmation(){
    // Always show the checklist view first (hide success view)
    $('#beforeSubmit').style.display = 'block';
    $('#afterSubmit').style.display = 'none';
    
    finalNotesEl.value = state.notes || '';
    
    // VALIDATE FIRST - check if everything is complete
    const validation = validateFinalSubmission();
    
    // Build completion checklist
    const checklist = [
      {
        step: 0,
        icon: 'üñäÔ∏è',
        title: 'Contrato firmado',
        completed: state.signature.locked && state.signature.name && state.signature.signatureData
      },
      {
        step: 1,
        icon: 'üìß',
        title: 'Email ingresado',
        completed: state.userEmail && state.userEmail.includes('@')
      },
      {
        step: 2,
        icon: 'üë•',
        title: `Personas agregadas (${state.people.members.length})`,
        completed: state.people.members.length > 0
      },
      {
        step: 3,
        icon: 'üéØ',
        title: `Metas seleccionadas (${state.goals.length})`,
        completed: true, // Optional
        optional: true
      },
      {
        step: 4,
        icon: 'üí∞',
        title: `Informaci√≥n financiera (${state.financials.items.length} ${state.financials.items.length === 1 ? 'item' : 'items'})`,
        completed: state.financials.items.length > 0
      }
    ];
    
    // IF VALIDATION FAILED - Show what's missing
    if (!validation.ok) {
      summaryGrid.innerHTML = `
        <div style="grid-column: 1/-1;">
          <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 30px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h3 style="color: #856404; margin: 0 0 16px;">Informaci√≥n Incompleta</h3>
            <p style="color: #856404; margin: 0 0 24px; font-size: 15px;">
              Para enviar tu Discovery, completa los siguientes pasos:
            </p>
            
            <div style="background: white; border-radius: 8px; padding: 20px; text-align: left; max-width: 600px; margin: 0 auto;">
              ${checklist.map(item => `
                <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; ${!item.completed && !item.optional ? 'cursor: pointer;' : ''}" 
                     ${!item.completed && !item.optional ? `onclick="window.dispatchEvent(new CustomEvent('goToStep', {detail: ${item.step}}));"` : ''}
                     ${!item.completed && !item.optional ? `onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'"` : ''}>
                  <span style="font-size: 32px; margin-right: 16px; min-width: 40px; text-align: center;">
                    ${item.completed ? '‚úÖ' : '‚¨ú'}
                  </span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: ${item.completed ? '#28a745' : '#856404'}; font-size: 16px;">
                      ${item.title}
                      ${item.optional ? ' <span style="font-size: 12px; color: #6c757d; font-weight: normal;">(opcional)</span>' : ''}
                    </div>
                    ${!item.completed && !item.optional ? '<div style="font-size: 13px; color: #6c757d; margin-top: 4px;">Click para completar ‚Üí</div>' : ''}
                    ${item.completed && item.optional ? '<div style="font-size: 12px; color: #6c757d; margin-top: 4px;">Este paso es opcional</div>' : ''}
                  </div>
                  ${!item.completed && !item.optional ? '<span style="color: #ffc107; font-size: 24px;">!</span>' : ''}
                </div>
              `).join('')}
            </div>
            
            <p style="color: #856404; margin: 24px 0 0; font-size: 13px;">
              üí° Haz click en los items pendientes para ir a completarlos
            </p>
          </div>
        </div>
      `;
      
      // Disable submit button
      finalSubmitBtn.disabled = true;
      finalSubmitBtn.textContent = 'Completar pasos requeridos';
      finalSubmitBtn.style.opacity = '0.5';
      
      return;
    }
    
    // IF VALIDATION PASSED - Show all complete and allow submit
    summaryGrid.innerHTML = `
      <div style="grid-column: 1/-1;">
        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); border: 2px solid #28a745; border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
          <h3 style="color: #155724; margin: 0 0 8px;">¬°Todo Completo!</h3>
          <p style="color: #155724; margin: 0; font-size: 14px;">
            Has completado todos los pasos requeridos. Presiona "Confirmar y enviar" para finalizar.
          </p>
        </div>
        
        <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 24px;">
          <h4 style="margin: 0 0 16px; color: #495057;">Resumen de Pasos Completados:</h4>
          ${checklist.map(item => `
            <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0;">
              <span style="font-size: 32px; margin-right: 16px; min-width: 40px; text-align: center;">‚úÖ</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #28a745; font-size: 16px;">
                  ${item.title}
                  ${item.optional ? ' <span style="font-size: 12px; color: #6c757d; font-weight: normal;">(opcional)</span>' : ''}
                </div>
                ${item.optional ? '<div style="font-size: 12px; color: #6c757d; margin-top: 4px;">Este paso es opcional</div>' : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    
    // Enable submit button
    finalSubmitBtn.disabled = false;
    finalSubmitBtn.textContent = 'Confirmar y enviar ‚Üí';
    finalSubmitBtn.style.opacity = '1';
  }

  finalNotesEl.addEventListener('input', () => {
    state.notes = finalNotesEl.value;
    debouncedSave();
  });

  // ===== FINAL VALIDATION =====
  function validateFinalSubmission() {
    const missingItems = [];
    
    // Check signature (Step 0) - must be locked
    if (!state.signature.locked || !state.signature.name || !state.signature.signatureData) {
      missingItems.push({
        step: 0,
        icon: 'üñäÔ∏è',
        title: 'Contrato sin firmar',
        description: 'Firma el contrato de consentimiento para continuar'
      });
    }
    
    // Check email (Step 1)
    if (!state.userEmail || !state.userEmail.includes('@')) {
      missingItems.push({
        step: 1,
        icon: 'üìß',
        title: 'Email requerido',
        description: 'Ingresa tu email para recibir el link de Calendly'
      });
    }
    
    // Check people (Step 2) - at least one person
    if (state.people.members.length === 0) {
      missingItems.push({
        step: 2,
        icon: 'üë•',
        title: 'Personas sin agregar',
        description: 'Agrega al menos una persona (t√∫ u otros miembros del hogar)'
      });
    }
    
    // Goals (Step 3) - optional, no validation needed
    
    // Check financials (Step 4) - must have at least ONE item with data
    const hasFinancialData = state.financials.items.length > 0;
    
    if (!hasFinancialData) {
      missingItems.push({
        step: 4,
        icon: 'üí∞',
        title: 'Informaci√≥n financiera incompleta',
        description: 'Debes ingresar al menos un dato financiero (ingreso, gasto, activo, etc.)'
      });
    }
    
    if (missingItems.length > 0) {
      return {
        ok: false,
        missingItems: missingItems,
        message: missingItems.map(item => item.title).join('. ')
      };
    }
    
    return { ok: true };
  }

  // Listen for goToStep custom event (from missing items clicks)
  window.addEventListener('goToStep', (e) => {
    setStep(e.detail);
  });

  finalSubmitBtn.addEventListener('click', async () => {
    // Validate before submitting
    const validation = validateFinalSubmission();
    if (!validation.ok) {
      showToast(`‚ö†Ô∏è Por favor completa la informaci√≥n faltante`);
      // Jump to first incomplete step
      if (validation.missingItems && validation.missingItems.length > 0) {
        setStep(validation.missingItems[0].step);
      }
      return;
    }
    
    const payload = buildFinalPayload();
    
    console.log('[Discovery Payload]', payload);
    
    // Show loading state
    finalSubmitBtn.textContent = 'Enviando...';
    finalSubmitBtn.disabled = true;
    
    try {
      // Send to backend API
      const API_URL = 'http://localhost:5000/api/submit-discovery';  // Change to your production URL
      
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });
      
      const result = await response.json();
      
      if (response.ok && result.success) {
        console.log('‚úì Discovery submitted successfully');
        console.log('   üìß Emails enviados:');
        console.log('   1. Contrato PDF al usuario (firmado)');
        console.log('   2. Link de Calendly al usuario');
        console.log('   3. Diagn√≥stico completo al equipo (PDF)');
        
        // Clear localStorage
        localStorage.removeItem('discovery_draft_v3');
        
        // Hide the checklist/form view
        $('#beforeSubmit').style.display = 'none';
        
        // Show the success message view
        $('#afterSubmit').style.display = 'block';
        
        // Scroll to top to show success message
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        showToast('‚úì ¬°Perfecto! Revisa tu email para agendar tu sesi√≥n.');
        
        // Download JSON backup (optional)
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `discovery-backup-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        
      } else {
        throw new Error(result.error || 'Error al enviar');
      }
      
    } catch (error) {
      console.error('Error submitting discovery:', error);
      
      // Download JSON as fallback
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `discovery-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      
      finalSubmitBtn.textContent = 'Confirmar y enviar ‚Üí';
      finalSubmitBtn.disabled = false;
      
      showToast('‚ö†Ô∏è Error de conexi√≥n. Datos guardados localmente. Por favor contacta al equipo.');
    }
  });

  function buildFinalPayload(){
    const params = new URLSearchParams(window.location.search);
    const clientId = params.get('client') || params.get('id') || null;

    return {
      meta: {
        source: 'discovery_v2_improved',
        mode: state.mode,
        completionTime: Date.now() - state.startTime,
        createdAt: new Date().toISOString(),
        clientId
      },
      signature: state.signature,
      userEmail: state.userEmail,
      people: state.people,
      goals: state.goals,
      financials: state.financials,
      notes: state.notes || '',
      flags: {
        hasComplexSituation: state.notes.length > 100,
        multipleIncomeSources: state.financials.items.filter(it => it.category === 'income').length > 2,
        hasRealEstate: state.financials.categoriesSelected.includes('real_estate'),
        hasDebts: state.financials.hasDebts,
        hasInvestments: state.financials.hasInvestments !== 'none'
      }
    };
  }

  // ===== Keyboard shortcuts =====
  document.addEventListener('keydown', (e) => {
    if(e.altKey && e.key === 'ArrowRight' && !nextBtn.disabled && !nextBtn.hidden){
      nextBtn.click();
    }
    if(e.altKey && e.key === 'ArrowLeft' && !backBtn.disabled){
      backBtn.click();
    }
    if(e.ctrlKey && e.key === 's'){
      e.preventDefault();
      debouncedSave();
      showToast('‚úì Progreso guardado');
    }
  });

  // Show keyboard hints on hover
  let hintTimer;
  document.addEventListener('mousemove', () => {
    clearTimeout(hintTimer);
    const hints = $('#keyboardHints');
    hints.classList.add('show');
    hintTimer = setTimeout(() => hints.classList.remove('show'), 3000);
  });

  // ===== Init =====
  loadDraft();
  
  // Set mode from state
  setStep(state.step);

})();
</script>
</body>
</html>
