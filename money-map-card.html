<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Money Map Card</title>

<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=Fraunces:opsz,wght@9..144,600;9..144,700;9..144,800;9..144,900&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

/* ‚úÖ EMBED MODE */
html, body { height: 100%; }
body{
  font-family:'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background:transparent;
  color:#0f172a;
  line-height:1.6;
  -webkit-font-smoothing: antialiased;
  padding:0;
  overflow:hidden;
}

.container{
  width:100%;
  max-width:100%;
  margin:0;
  padding:0;
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const parseNumber = (value) => {
  if (value === null || value === undefined || value === '') return 0;
  const num = typeof value === 'string' ? parseFloat(value.replace(/,/g, '')) : value;
  return isNaN(num) ? 0 : num;
};

function MoneyMapCard({
  totales = {activosTotales:0, pasivosTotales:0, patrimonioNeto:0},
  userProfile = {edad:'30', impuestos:0, seguros:0},
  currency = 'USD',
  ingresoBruto = 0,
  ahorro = 0,
  deudas = 0,
  gastosEsenciales = 0,
  reservaEmergencia = 0,
  modoCalculo = 'mensual',
  onOpenMoneyMap
}) {

  const getMoneyMapStatus = () => {
    const hasNoData =
      !ingresoBruto &&
      !parseNumber(totales.activosTotales) &&
      !parseNumber(totales.pasivosTotales);

    if (hasNoData) return 'new';

    const hasPartialData =
      !gastosEsenciales ||
      !reservaEmergencia ||
      (!ingresoBruto || !ahorro || !deudas) ||
      (parseNumber(totales.activosTotales) === 0 && parseNumber(totales.pasivosTotales) === 0);

    if (hasPartialData) return 'incomplete';

    return 'complete';
  };

  const status = getMoneyMapStatus();

  const mult = modoCalculo === 'anual' ? 1 : 12;

  const ingresoBrutoAnual = parseNumber(ingresoBruto) * mult;
  const impuestosAnuales = (parseNumber(userProfile.impuestos) || 0) * mult;
  const segurosAnuales = (parseNumber(userProfile.seguros) || 0) * mult;

  const ingresoNetoAnual = ingresoBrutoAnual - impuestosAnuales - segurosAnuales;
  const ahorroAnual = parseNumber(ahorro) * mult;

  const pagoMensualDeuda = modoCalculo === 'anual'
    ? (parseNumber(deudas) / 12)
    : parseNumber(deudas);

  const mesesReserva = parseNumber(gastosEsenciales) > 0
    ? parseNumber(reservaEmergencia) / parseNumber(gastosEsenciales)
    : 0;

  const tasaAhorro = ingresoBrutoAnual > 0 ? (ahorroAnual / ingresoBrutoAnual) : 0;

  const dtiNeto = (ingresoNetoAnual / 12) > 0
    ? (pagoMensualDeuda / (ingresoNetoAnual / 12))
    : 0;

  const activosTotales = parseNumber(totales.activosTotales);
  const patrimonioNeto = parseNumber(totales.patrimonioNeto);

  const patrimonioActivos = activosTotales > 0 ? (patrimonioNeto / activosTotales) : 0;
  const riquezaNeta = ingresoBrutoAnual > 0 ? (patrimonioNeto / ingresoBrutoAnual) : 0;

  const getRiquezaBenchmark = (age) => {
    const b = [
      {age:25, good:2.5, great:5}, {age:30, good:3, great:6}, {age:35, good:3.5, great:7},
      {age:40, good:4, great:8}, {age:45, good:4.5, great:9}, {age:50, good:5, great:10},
      {age:55, good:5.5, great:11}, {age:60, good:6, great:12}, {age:65, good:6.5, great:13},
      {age:70, good:7, great:14}
    ];
    if (age < 25) return b[0];
    if (age >= 70) return b[b.length - 1];

    for (let i=0;i<b.length-1;i++){
      if (age >= b[i].age && age < b[i+1].age){
        const t = (age - b[i].age) / (b[i+1].age - b[i].age);
        return {
          good: b[i].good + t * (b[i+1].good - b[i].good),
          great: b[i].great + t * (b[i+1].great - b[i].great),
        };
      }
    }
    return b[b.length - 1];
  };

  const edad = parseInt(userProfile.edad, 10) || 30;
  const benchmark = getRiquezaBenchmark(edad);

  const getMetricStatus = (value, goodThreshold, greatThreshold, isInverse = false) => {
    if (!isFinite(value)) return { level: 'none', emoji: '‚Äî', color: '#94a3b8' };

    if (isInverse) {
      if (value <= greatThreshold) return { level: 'great', emoji: '‚úÖ', color: '#10b981' };
      if (value <= goodThreshold) return { level: 'good', emoji: '‚ö†Ô∏è', color: '#f59e0b' };
      return { level: 'poor', emoji: 'üö®', color: '#ef4444' };
    } else {
      if (value >= greatThreshold) return { level: 'great', emoji: '‚úÖ', color: '#10b981' };
      if (value >= goodThreshold) return { level: 'good', emoji: '‚ö†Ô∏è', color: '#f59e0b' };
      return { level: 'poor', emoji: 'üö®', color: '#ef4444' };
    }
  };

  const metricas = {
    mesesReserva: {
      nombre:'Reserva', valor: mesesReserva.toFixed(1) + 'm', meta:'6m',
      status:getMetricStatus(mesesReserva, 3, 6), icon:'üíß'
    },
    tasaAhorro: {
      nombre:'Ahorro', valor:(tasaAhorro*100).toFixed(0) + '%', meta:'30%',
      status:getMetricStatus(tasaAhorro, 0.15, 0.30), icon:'üê∑'
    },
    dtiNeto: {
      nombre:'DTI', valor:(dtiNeto*100).toFixed(0) + '%', meta:'‚â§36%',
      status:getMetricStatus(dtiNeto, 0.43, 0.36, true), icon:'üè¶'
    },
    patrimonioActivos: {
      nombre:'Patrimonio', valor:(patrimonioActivos*100).toFixed(0) + '%', meta:'70%',
      status:getMetricStatus(patrimonioActivos, 0.50, 0.70), icon:'üíé'
    },
    riquezaNeta: {
      nombre:'Riqueza', valor:riquezaNeta.toFixed(1) + 'x', meta:benchmark.great.toFixed(1) + 'x',
      status:getMetricStatus(riquezaNeta, benchmark.good, benchmark.great), icon:'üìà'
    }
  };

  const calculateOverallScore = () => {
    const levels = Object.values(metricas).map(m => m.status.level).filter(l => l !== 'none');
    const total = levels.length;
    if (!total) return { level:'none', color:'#94a3b8', emoji:'‚Äî', text:'Sin datos' };

    const greatCount = levels.filter(l => l === 'great').length;
    const goodCount = levels.filter(l => l === 'good').length;
    const score = (greatCount * 100 + goodCount * 60) / total;

    if (score >= 85) return { level:'great', color:'#10b981', emoji:'üéâ', text:'Excelente' };
    if (score >= 65) return { level:'good', color:'#f59e0b', emoji:'üëç', text:'Bien' };
    return { level:'needs-work', color:'#ef4444', emoji:'‚ö°', text:'Mejorar' };
  };

  const overallScore = calculateOverallScore();

  // helper
  const open = () => onOpenMoneyMap && onOpenMoneyMap();

  // ====== VISTAS ======
  if (status === 'new') {
    return (
      <div style={{
        background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        borderRadius:'16px',
        padding:'1.4rem',
        color:'#fff',
        boxShadow:'0 4px 20px rgba(102,126,234,0.25)',
        display:'flex',
        flexDirection:'column',
        position:'relative',
        overflow:'hidden',
        height:'100%'
      }}>
        <div style={{
          position:'absolute',
          top:'-30px',
          right:'-30px',
          width:'150px',
          height:'150px',
          background:'rgba(255,255,255,0.1)',
          borderRadius:'50%',
          filter:'blur(30px)'
        }} />
        <div style={{position:'relative', zIndex:1, flex:1, display:'flex', flexDirection:'column'}}>
          <div style={{marginBottom:'1rem'}}>
            <div style={{fontSize:'2.2rem', marginBottom:'0.4rem'}}>üó∫Ô∏è</div>
            <h3 style={{fontSize:'1.25rem', fontWeight:'800', marginBottom:'0.35rem', fontFamily:"'Fraunces', serif"}}>
              Descubre tu Money Map
            </h3>
            <p style={{fontSize:'0.85rem', opacity:0.92, lineHeight:'1.4'}}>
              An√°lisis completo de 5 m√©tricas financieras clave
            </p>
          </div>

          <div style={{
            background:'rgba(255,255,255,0.15)',
            borderRadius:'10px',
            padding:'0.9rem',
            marginBottom:'1rem',
            backdropFilter:'blur(10px)',
            flex:1,
            display:'grid',
            alignItems:'center'
          }}>
            <div style={{display:'grid', gridTemplateColumns:'repeat(5, 1fr)', gap:'0.6rem'}}>
              {['üíß Reserva','üê∑ Ahorro','üè¶ Deuda','üíé Patrimonio','üìà Riqueza'].map((item, idx) => {
                const [icon, label] = item.split(' ');
                return (
                  <div key={idx} style={{textAlign:'center'}}>
                    <div style={{fontSize:'1.35rem', marginBottom:'0.15rem'}}>{icon}</div>
                    <div style={{fontSize:'0.65rem', opacity:0.9}}>{label}</div>
                  </div>
                );
              })}
            </div>
          </div>

          <button onClick={open} style={{
            width:'100%',
            padding:'0.85rem 1.1rem',
            background:'#fff',
            color:'#667eea',
            border:'none',
            borderRadius:'10px',
            fontSize:'0.92rem',
            fontWeight:'800',
            cursor:'pointer',
            boxShadow:'0 4px 12px rgba(0,0,0,0.15)',
            fontFamily:"'DM Sans', sans-serif"
          }}>
            üöÄ Comenzar Money Map
          </button>
        </div>
      </div>
    );
  }

  if (status === 'incomplete') {
    return (
      <div style={{
        background:'#fff',
        borderRadius:'16px',
        padding:'1.4rem',
        boxShadow:'0 2px 8px rgba(0,0,0,0.1)',
        border:'2px solid #fbbf24',
        display:'flex',
        flexDirection:'column',
        height:'100%'
      }}>
        <div style={{marginBottom:'0.9rem'}}>
          <div style={{fontSize:'2.1rem', marginBottom:'0.35rem'}}>‚ö†Ô∏è</div>
          <h3 style={{fontSize:'1.15rem', fontWeight:'800', marginBottom:'0.25rem', color:'#f59e0b', fontFamily:"'Fraunces', serif"}}>
            Money Map Incompleto
          </h3>
          <p style={{color:'#64748b', fontSize:'0.82rem', lineHeight:'1.35'}}>
            Completa m√°s datos para tu an√°lisis
          </p>
        </div>

        <div style={{
          background:'#fffbeb',
          border:'2px solid #fbbf24',
          borderRadius:'10px',
          padding:'0.9rem',
          marginBottom:'1rem',
          flex:1
        }}>
          <div style={{fontWeight:'800', marginBottom:'0.55rem', color:'#92400e', fontSize:'0.85rem'}}>
            üìã Datos faltantes:
          </div>
          <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.45rem', fontSize:'0.78rem', color:'#78350f'}}>
            {!ingresoBruto && <div>‚Ä¢ Ingreso bruto</div>}
            {!ahorro && <div>‚Ä¢ Ahorro</div>}
            {!deudas && <div>‚Ä¢ Pagos deuda</div>}
            {!gastosEsenciales && <div>‚Ä¢ Gastos esenciales</div>}
            {!reservaEmergencia && <div>‚Ä¢ Reserva emergencia</div>}
            {parseNumber(totales.activosTotales) === 0 && <div>‚Ä¢ Activos</div>}
          </div>
        </div>

        <button onClick={open} style={{
          width:'100%',
          padding:'0.85rem 1.1rem',
          background:'#f59e0b',
          color:'#fff',
          border:'none',
          borderRadius:'10px',
          fontSize:'0.92rem',
          fontWeight:'800',
          cursor:'pointer',
          fontFamily:"'DM Sans', sans-serif"
        }}>
          ‚úèÔ∏è Completar Money Map
        </button>
      </div>
    );
  }

  // complete
  return (
    <div style={{
      background:'#fff',
      borderRadius:'16px',
      padding:'1.4rem',
      boxShadow:'0 2px 8px rgba(0,0,0,0.1)',
      border:`2px solid ${overallScore.color}`,
      display:'flex',
      flexDirection:'column',
      height:'100%'
    }}>
      <div style={{
        display:'flex',
        alignItems:'flex-start',
        justifyContent:'space-between',
        marginBottom:'1rem',
        paddingBottom:'0.7rem',
        borderBottom:'2px solid #e2e8f0'
      }}>
        <div style={{flex:1}}>
          <h3 style={{fontSize:'1.15rem', fontWeight:'900', marginBottom:'0.2rem', fontFamily:"'Fraunces', serif", color:'#1e293b'}}>
            üó∫Ô∏è Money Map
          </h3>
          <p style={{color:'#64748b', fontSize:'0.78rem', lineHeight:'1.3'}}>
            Resumen de salud financiera
          </p>
        </div>

        <div style={{
          background:`linear-gradient(135deg, ${overallScore.color} 0%, ${overallScore.color}dd 100%)`,
          color:'#fff',
          padding:'0.5rem 0.75rem',
          borderRadius:'10px',
          textAlign:'center',
          minWidth:'78px'
        }}>
          <div style={{fontSize:'1.45rem', lineHeight:1}}>{overallScore.emoji}</div>
          <div style={{fontSize:'0.65rem', marginTop:'0.25rem', opacity:0.95, fontWeight:800, letterSpacing:'0.3px'}}>
            {overallScore.text}
          </div>
        </div>
      </div>

      <div style={{
        display:'grid',
        gridTemplateColumns:'repeat(5, 1fr)',
        gap:'0.65rem',
        marginBottom:'1rem',
        flex:1
      }}>
        {Object.entries(metricas).map(([key, m]) => (
          <div key={key} style={{
            background:'#f8fafc',
            borderRadius:'10px',
            padding:'0.7rem',
            border:`2px solid ${m.status.color}20`,
            position:'relative',
            display:'flex',
            flexDirection:'column',
            justifyContent:'space-between'
          }}>
            <div style={{position:'absolute', top:'6px', right:'6px', fontSize:'1rem', lineHeight:1}}>{m.status.emoji}</div>
            <div style={{fontSize:'1.45rem', marginBottom:'0.25rem', lineHeight:1}}>{m.icon}</div>
            <div style={{fontSize:'0.65rem', color:'#64748b', marginBottom:'0.2rem', fontWeight:800, lineHeight:1.2}}>{m.nombre}</div>
            <div style={{fontSize:'1.05rem', fontWeight:900, color:'#1e293b', marginBottom:'0.2rem', fontFamily:"'Fraunces', serif", lineHeight:1}}>{m.valor}</div>
            <div style={{fontSize:'0.6rem', color:m.status.color, fontWeight:800, lineHeight:1}}>Meta: {m.meta}</div>
          </div>
        ))}
      </div>

      <div style={{
        background:'#f1f5f9',
        borderRadius:'10px',
        padding:'0.95rem',
        display:'flex',
        alignItems:'center',
        justifyContent:'space-between',
        gap:'1rem'
      }}>
        <div style={{flex:1}}>
          <div style={{fontSize:'0.7rem', color:'#64748b', marginBottom:'0.25rem', fontWeight:800}}>
            Patrimonio Neto
          </div>
          <div style={{
            fontSize:'1.2rem',
            fontWeight:900,
            color: patrimonioNeto >= 0 ? '#10b981' : '#ef4444',
            fontFamily:"'Fraunces', serif",
            lineHeight:1
          }}>
            {new Intl.NumberFormat('en-US', { style:'currency', currency, maximumFractionDigits:0 }).format(patrimonioNeto || 0)}
          </div>
        </div>

        <button onClick={open} style={{
          padding:'0.62rem 1.1rem',
          background:'#3b82f6',
          color:'#fff',
          border:'none',
          borderRadius:'8px',
          fontSize:'0.84rem',
          fontWeight:900,
          cursor:'pointer',
          fontFamily:"'DM Sans', sans-serif",
          whiteSpace:'nowrap'
        }}>
          üìä Abrir Money Map
        </button>
      </div>
    </div>
  );
}

function App(){
  const [moneyMapData, setMoneyMapData] = useState({
    totales: { activosTotales: 0, pasivosTotales: 0, patrimonioNeto: 0 },
    userProfile: { nombre: '', edad: '30', impuestos: 0, seguros: 0 },
    currency: 'USD',
    ingresoBruto: 0,
    ahorro: 0,
    deudas: 0,
    gastosEsenciales: 0,
    reservaEmergencia: 0,
    modoCalculo: 'mensual'
  });

  useEffect(() => {
    const handleMessage = (event) => {
      if (event?.data?.type === 'MONEY_MAP_DATA' && event.data.data) {
        setMoneyMapData(event.data.data);
      }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  const handleOpenMoneyMap = () => {
    // ‚úÖ abre modal global del dashboard (afuera del iframe)
    if (window.parent) window.parent.postMessage({ type:'OPEN_MONEY_MAP' }, '*');
  };

  return (
    <div className="container">
      <MoneyMapCard
        {...moneyMapData}
        onOpenMoneyMap={handleOpenMoneyMap}
      />
    </div>
  );
}

// React 18
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
